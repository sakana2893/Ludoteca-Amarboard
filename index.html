<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Catalogo Giochi â€“ AmarBoard Natale</title>

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
:root{
  --rosso:#b02030;
  --verde:#1f7a3a;
  --oro:#f3d08a;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top,#ffe9e9,#fdf5e6 45%,#e4f5ea 100%);
}
#wrapper{
  max-width:1200px;
  margin:70px auto 40px;
  padding:24px;
  background:rgba(255,250,243,.96);
  border-radius:20px;
  border:2px solid rgba(176,32,48,.35);
  box-shadow:0 0 18px rgba(176,32,48,.25);
}
h1{
  margin:0 0 6px;
  text-align:center;
  color:var(--rosso);
}
.subtitle{
  text-align:center;
  margin-bottom:16px;
  color:#555;
}
.topbar{
  display:flex;
  justify-content:flex-end;
  margin-bottom:6px;
}
.admin-link{
  font-size:.8rem;
  color:#555;
  text-decoration:none;
}
button{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--verde);
  background:#e9fff0;
  color:var(--verde);
  font-weight:700;
  cursor:pointer;
}
button:hover{ background:#d6ffe5; }

table.dataTable thead th{
  background:#fff;
  border-bottom:2px solid var(--rosso);
}
table.dataTable tbody tr:nth-child(even){
  background:#fffaf5;
}

/* ===== MODAL ===== */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#modal .box{
  width:380px;
  background:#fff;
  border-radius:16px;
  padding:18px;
  border:2px solid var(--oro);
}
#modal h3{
  margin-top:0;
  color:var(--rosso);
}
input,textarea{
  width:100%;
  padding:6px 8px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.ok{
  color:#1f7a3a;
  font-weight:700;
  font-size:.9rem;
}
#pWebsite{display:none;}
</style>
</head>

<body>

<div id="wrapper">
  <div class="topbar">
    <a class="admin-link" href="admin.html" target="_blank">Area Admin</a>
  </div>

  <h1>Catalogo Giochi â€“ AmarBoard</h1>
  <div class="subtitle">
    <b>Speciale Natale:</b> scegli il gioco giusto o richiedi la prenotazione al banco ðŸŽ„
  </div>

  <table id="tblCatalogo" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Titolo</th>
        <th>Giocatori</th>
        <th>Durata</th>
        <th>Disponibili</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- MODAL -->
<div id="modal">
  <div class="box">
    <h3 id="mTitolo"></h3>

    <input id="pNome" placeholder="Nome e cognome">
    <input id="pTel" placeholder="Telefono (opzionale)">
    <textarea id="pNote" placeholder="Note (opzionale)"></textarea>
    <input id="pWebsite">

    <div id="mOk" class="ok"></div>

    <div style="display:flex;gap:10px;margin-top:10px;">
      <button id="pInvia" onclick="invia()">Invia</button>
      <button onclick="closeModal()">Annulla</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby-o0FWIL1NVCr_bWznqmkA4yCBnIhQzdyQGOaLDbAD-q_MOfBMjhL1knxVoPWbhHSl/exec";
const CSV_URL = "/catalogo_ludoteca.csv";

/* ===== STATE ===== */
let ctx = {titolo:"",giocatori:""};

/* ===== MODAL ===== */
function openModal(t,g){
  ctx.titolo=t; ctx.giocatori=g||"";
  mTitolo.textContent="Prenota: "+t;
  mOk.textContent="";
  modal.style.display="flex";
}
function closeModal(){
  modal.style.display="none";
}

/* ===== INVIO (SILENZIOSO, AFFIDABILE) ===== */
function invia(){
  if(pNome.value.trim().length<2) return;

  const u=new URL(API_URL);
  u.searchParams.set("action","submit");
  u.searchParams.set("titolo",ctx.titolo);
  u.searchParams.set("giocatori",ctx.giocatori);
  u.searchParams.set("nome",pNome.value.trim());
  u.searchParams.set("telefono",pTel.value.trim());
  u.searchParams.set("note",pNote.value.trim());
  u.searchParams.set("website",pWebsite.value.trim());
  u.searchParams.set("_",Date.now());

  pInvia.disabled=true;
  new Image().src=u.toString();

  mOk.textContent="Richiesta inviata âœ…";
  setTimeout(closeModal,900);
}

/* ===== LOAD CSV ===== */
Papa.parse(CSV_URL+"?v="+Date.now(),{
  download:true,
  header:true,
  complete:r=>{
    const data=r.data.filter(x=>x.Titolo);
    $("#tblCatalogo").DataTable({
      data,
      paging:false,
      info:false,
      columns:[
        {data:"Titolo"},
        {data:"NumeroGiocatori"},
        {data:"Durata"},
        {data:"CopieDisponibili"},
        {data:null,render:x=>
          `<button onclick="openModal('${x.Titolo.replace(/'/g,"\\'")}','${x.NumeroGiocatori||""}')">
            ðŸ“Œ Richiedi
          </button>`}
      ]
    });
  }
});
</script>

</body>
</html>
