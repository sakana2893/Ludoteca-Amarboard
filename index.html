<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Catalogo Giochi â€“ AmarBoard Natale</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --rosso-natale: #b02030;
      --verde-natale: #1f7a3a;
      --oro-soft:    #f3d08a;
      --bg-chiaro:   #fffaf3;
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    .snowflake {
      position: fixed;
      top: -10px;
      color: #ffffff;
      font-size: 1.2rem;
      pointer-events: none;
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      opacity: 0.85;
      z-index: 1;
      text-shadow: 0 0 3px rgba(0,0,0,0.3);
    }
    .snowflake:nth-child(1)  { left: 5%;  animation-duration: 12s; animation-delay: 0s; }
    .snowflake:nth-child(2)  { left: 18%; animation-duration: 15s; animation-delay: 2s; }
    .snowflake:nth-child(3)  { left: 32%; animation-duration: 11s; animation-delay: 4s; }
    .snowflake:nth-child(4)  { left: 46%; animation-duration: 13s; animation-delay: 1s; }
    .snowflake:nth-child(5)  { left: 60%; animation-duration: 16s; animation-delay: 3s; }
    .snowflake:nth-child(6)  { left: 74%; animation-duration: 10s; animation-delay: 5s; }
    .snowflake:nth-child(7)  { left: 88%; animation-duration: 14s; animation-delay: 1s; }

    @keyframes fall {
      0%   { transform: translateY(0); opacity: 0.95; }
      100% { transform: translateY(110vh); opacity: 0; }
    }

    .garland {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: radial-gradient(circle at center, rgba(31,122,58,0.7), rgba(0,0,0,0.3));
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #ffe;
      font-size: 1.4rem;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .garland span { animation: blink 2.2s linear infinite; }
    .garland span:nth-child(odd) { animation-delay: 0.7s; }

    @keyframes blink {
      0%, 100% { opacity: 0.4; transform: translateY(0); }
      50%      { opacity: 1;   transform: translateY(1px); }
    }

    #wrapper {
      max-width: 1200px;
      margin: 90px auto 40px;
      padding: 24px 26px 30px;
      background: rgba(255,250,243,0.96);
      border-radius: 20px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8),
                  0 0 18px rgba(176,32,48,0.4);
      position: relative;
      z-index: 3;
      border: 2px solid rgba(176,32,48,0.35);
    }

    #wrapper::before {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 16px;
      border: 2px dashed rgba(243,208,138,0.7);
      pointer-events: none;
    }

    .header-flex {
      display: flex;
      align-items: center;
      justify-content: center; /* logo centrato come prima */
      gap: 18px;
      margin-bottom: 6px;
      position: relative;
      z-index: 2;
    }

    .xmas-icon { font-size: 2rem; }

    .logo-amar {
      height: 80px;
      width: auto;
      border-radius: 999px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      background: #fff;
    }

    h1 {
      text-align: center;
      margin: 6px 0;
      font-size: 1.8rem;
      color: var(--rosso-natale);
      text-shadow: 0 1px 0 #fff, 0 0 6px rgba(176,32,48,0.35);
      position: relative;
      z-index: 2;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 12px;
      position: relative;
      z-index: 2;
      font-weight: 800;
    }
    .subtitle span { color: var(--verde-natale); font-weight: 900; }

    .top-actions{
      display:flex;
      justify-content: center;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 14px;
      position: relative;
      z-index: 2;
    }

    .btn {
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select:none;
      text-decoration:none;
      color:#222;
    }
    .btn:hover { filter: brightness(0.98); }
    .btn-ok { border-color: rgba(31,122,58,.55); background: rgba(233,255,240,.95); color:#155724; }
    .btn-no { border-color: rgba(176,32,48,.45); background: rgba(255,231,231,.92); color:#7a0f1a; }
    .btn-neutral { border-color: rgba(0,0,0,.18); background: rgba(255,255,255,.92); color:#333; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-bottom: 16px;
      position: relative;
      z-index: 2;
    }

    .stat-box {
      background: linear-gradient(135deg,#fff,#fffdf7);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(176,32,48,0.2);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 0.85rem;
      font-weight: 800;
    }

    .stat-label {
      text-transform: uppercase;
      color: #666;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
      font-weight: 900;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--rosso-natale);
    }

    .stat-note {
      font-size: 0.75rem;
      color: #777;
      margin-top: 3px;
      font-weight: 800;
    }

    .stat-top ol {
      margin: 0;
      padding-left: 18px;
      font-size: 0.8rem;
      font-weight: 900;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
      position: relative;
      z-index: 2;
    }

    .filters-left {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }

    .filter-block { display: flex; flex-direction: column; gap: 4px; }

    .filter-label {
      color: #444;
      font-size: 0.8rem;
      font-weight: 900;
    }

    select, input[type="text"], input[type="password"], input[type="tel"] {
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      min-width: 160px;
      background: #fff;
      font-weight: 900;
    }

    #lastUpdate {
      font-size: 0.75rem;
      color: #666;
      margin-top: 6px;
      text-align: right;
      font-weight: 900;
    }

    #tblCatalogo_wrapper { margin-top: 6px; }

    table.dataTable thead th {
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom: 2px solid var(--rosso-natale);
      font-weight: 900;
    }

    table.dataTable tbody tr:nth-child(even) { background-color: #fffaf5; }
    table.dataTable tbody tr.disponibile-row { background: linear-gradient(90deg, #f7fff7, #ffffff); }
    table.dataTable tbody tr.prestato-row { background: linear-gradient(90deg, #fff7f7, #ffffff); }

    .badge {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 900;
      display: inline-block;
      white-space: nowrap;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .badge-disponibile { background: #d4edda; color: #155724; border-color:#b1dfbb; }
    .badge-prestato { background: #f8d7da; color: #721c24; border-color:#f1b0b7; }
    .badge-req { background:#efe1ff; border-color:#c9a7ff; color:#4a1a7a; }
    .badge-booked { background:#ffe8c7; border-color:#ffc37a; color:#7a3d00; }

    a.bgg-link {
      color: var(--rosso-natale);
      font-size: 0.85rem;
      text-decoration: none;
      font-weight: 900;
    }
    a.bgg-link:hover { text-decoration: underline; }

    .footer-note {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #777;
      text-align: right;
      font-weight: 900;
    }

    #errorBox, #infoBox {
      display:none;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.35;
      font-weight: 900;
      position: relative;
      z-index: 2;
    }
    #errorBox { border: 1px solid rgba(176,32,48,0.35); background: rgba(255, 231, 231, 0.85); color: #7a0f1a; }
    #infoBox  { border: 1px solid rgba(31,122,58,0.25); background: rgba(233,255,240,0.95); color: #155724; }

    /* COUNTDOWN */
    #countdownBanner{
      position: fixed;
      inset: 70px 16px auto 16px;
      max-width: 1200px;
      margin: 0 auto;
      z-index: 9999;
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.35);
      box-shadow: 0 0 18px rgba(176,32,48,0.25);
      border-radius: 16px;
      padding: 14px 16px;
      text-align: center;
      color: #7a0f1a;
      font-weight: 900;
      display:none;
    }
    #countdownBanner small{
      display:block;
      margin-top:6px;
      font-weight: 900;
      color:#444;
    }
    #countdownTime{
      font-variant-numeric: tabular-nums;
      font-size: 1.4rem;
      color: #b02030;
    }
    .spoiler-hidden #wrapper{
      filter: blur(10px);
      pointer-events: none;
      user-select: none;
    }
    .spoiler-hidden #wrapper::after{
      content:"Catalogo in arrivoâ€¦";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.4rem;
      font-weight: 900;
      color: rgba(122,15,26,0.85);
    }

    /* OVERLAY CARICAMENTO */
    #loadingOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
    }
    #loadingCard{
      width: min(520px, 100%);
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 16px;
      box-shadow: 0 0 18px rgba(0,0,0,0.2);
      padding: 14px 14px 12px;
      text-align:center;
      font-weight: 1000;
      color:#7a0f1a;
    }
    #loadingBar{
      margin-top: 10px;
      height: 10px;
      width: 100%;
      background: rgba(0,0,0,0.08);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.08);
    }
    #loadingBar > div{
      height:100%;
      width:30%;
      background: rgba(176,32,48,0.55);
      border-radius:999px;
      animation: loadingmove 1.0s ease-in-out infinite;
    }
    @keyframes loadingmove{
      0%{ transform: translateX(-30%); }
      100%{ transform: translateX(330%); }
    }
    #loadingDetail{
      margin-top: 8px;
      font-size: .9rem;
      color:#444;
      font-weight: 900;
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10000;
      padding: 18px;
    }
    .modal{
      width: min(560px, 100%);
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 16px;
      box-shadow: 0 0 18px rgba(0,0,0,0.2);
      padding: 14px 14px 12px;
    }
    .modal h3{
      margin: 0 0 8px;
      color: var(--rosso-natale);
      font-weight: 1000;
    }
    .modal .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0;
      align-items:center;
    }
    .modal .row > * { flex: 1; min-width: 200px; }
    .modal .actions{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      margin-top: 10px;
    }
    .muted{ color:#555; font-weight:900; font-size:.9rem; }

    img.emoji{ height: 1em; width: 1em; margin: 0 .05em 0 .1em; vertical-align: -0.1em; }

    @media(max-width: 900px) { .stats-bar { grid-template-columns: 1fr; } }
    @media(max-width: 768px) {
      #wrapper { margin: 80px 10px 20px; padding: 14px; }
      .filters { flex-direction: column; align-items: stretch; }
      .header-flex { flex-direction: column; }
      .logo-amar { height: 70px; }
      select, input[type="text"], input[type="password"], input[type="tel"] { min-width: 100%; }
    }
  </style>
</head>

<body>

<div id="countdownBanner">
  ğŸ La pagina della nostra Ludoteca si sbloccherÃ  tra <span id="countdownTime">--:--:--</span>
  <small>Stiamo â€œintavolandoâ€ la pagina: fino a quellâ€™ora resta coperta.</small>
</div>

<div id="loadingOverlay">
  <div id="loadingCard">
    â³ Sto caricando il catalogoâ€¦
    <div id="loadingBar"><div></div></div>
    <div id="loadingDetail">Preparazione tabella e controlli richieste.</div>
  </div>
</div>

<div class="garland">
  <span>âœ¨</span><span>ğŸ„</span><span>â­</span><span>ğŸ•¯ï¸</span>
  <span>ğŸ² AmarBoard Romagna ğŸ²</span>
  <span>â­</span><span>ğŸ„</span><span>âœ¨</span>
</div>

<div class="snowflake">â„</div>
<div class="snowflake">âœ»</div>
<div class="snowflake">â…</div>
<div class="snowflake">â†</div>
<div class="snowflake">â„</div>
<div class="snowflake">âœµ</div>
<div class="snowflake">â„</div>

<div id="wrapper">
  <div class="header-flex">
    <span class="xmas-icon">ğŸ„</span>
    <img class="logo-amar" src="logo_amarboard.png" alt="AmarBoard Romagna">
    <span class="xmas-icon">ğŸ²</span>
  </div>

  <h1>Catalogo Giochi â€“ AmarBoard</h1>

  <div class="subtitle">
    <span>Speciale Natale:</span> trova il gioco giusto (o fatti suggerire dai nostri Volontari) da intavolare con gli amici sui nostri tavoli.
  </div>

  <div class="top-actions">
    <button class="btn btn-neutral" id="btnLogin" type="button">ğŸ” Accedi</button>
    <button class="btn btn-neutral" id="btnRegister" type="button">ğŸ§¾ Registrati</button>
    <a class="btn btn-neutral" id="btnAdminLink" href="admin.html" style="display:none;">ğŸ› ï¸ Area Admin</a>
    <button class="btn btn-no" id="btnLogout" type="button" style="display:none;">ğŸšª Logout</button>
  </div>

  <div class="stats-bar">
    <div class="stat-box">
      <div class="stat-label">Giochi attualmente in prestito</div>
      <div class="stat-value" id="cntAttivi">â€“</div>
      <div class="stat-note">Numero di prestiti attivi in questo momento.</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Prestiti totali effettuati</div>
      <div class="stat-value" id="cntTotali">â€“</div>
      <div class="stat-note">Conteggio cumulativo dei prestiti registrati.</div>
    </div>
    <div class="stat-box stat-top">
      <div class="stat-label">Top 3 giochi piÃ¹ prestati ora</div>
      <ol id="topList"></ol>
    </div>
  </div>

  <div class="filters">
    <div class="filters-left">
      <div class="filter-block">
        <span class="filter-label">Stato</span>
        <select id="filtroStato">
          <option value="">Tutti</option>
          <option value="Disponibile">Disponibile</option>
          <option value="In prestito">In prestito</option>
        </select>
      </div>

      <div class="filter-block">
        <span class="filter-label">Giocatori (contiene)</span>
        <input type="text" id="filtroGiocatori" placeholder="es. 2-4">
      </div>
    </div>

    <button id="btnRefresh" class="btn btn-ok" type="button">ğŸ”„ Aggiorna dati</button>
  </div>

  <div id="infoBox"></div>
  <div id="errorBox"></div>

  <table id="tblCatalogo" class="display" style="width:100%">
    <thead>
    <tr>
      <th>Titolo</th>
      <th>Giocatori</th>
      <th>Durata</th>
      <th>EtÃ </th>
      <th>Editore</th>
      <th>Disponibili</th>
      <th>Stato</th>
      <th>BGG</th>
      <th>Richiesta</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="lastUpdate">Ultimo aggiornamento: â€“</div>

  <div class="footer-note">
    ğŸ… Catalogo generato dalla ludoteca AmarBoard â€“ versione natalizia
  </div>
</div>

<!-- MODAL LOGIN -->
<div class="modal-backdrop" id="modalLogin">
  <div class="modal">
    <h3>ğŸ” Accedi</h3>
    <div class="row">
      <div>
        <div class="muted">Username</div>
        <input id="loginUser" type="text" autocomplete="username" placeholder="es: mario">
      </div>
      <div>
        <div class="muted">Password</div>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
    </div>
    <div class="muted" id="loginMsg" style="margin-top:6px;"></div>
    <div class="actions">
      <button class="btn btn-neutral" type="button" data-close="modalLogin">Annulla</button>
      <button class="btn btn-ok" id="btnDoLogin" type="button">Entra</button>
    </div>
  </div>
</div>

<!-- MODAL REGISTER -->
<div class="modal-backdrop" id="modalRegister">
  <div class="modal">
    <h3>ğŸ§¾ Registrati</h3>
    <div class="row">
      <div>
        <div class="muted">Username (solo lettere/numeri)</div>
        <input id="regUser" type="text" autocomplete="username" placeholder="min 4 caratteri">
      </div>
      <div>
        <div class="muted">Nome</div>
        <input id="regNome" type="text" placeholder="Nome e cognome">
      </div>
    </div>
    <div class="row">
      <div>
        <div class="muted">Telefono</div>
        <input id="regTel" type="tel" placeholder="es. 393...">
      </div>
      <div>
        <div class="muted">Password</div>
        <input id="regPass" type="password" autocomplete="new-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
    </div>
    <div class="muted" id="regMsg" style="margin-top:6px;"></div>
    <div class="actions">
      <button class="btn btn-neutral" type="button" data-close="modalRegister">Annulla</button>
      <button class="btn btn-ok" id="btnDoRegister" type="button">Crea account</button>
    </div>
  </div>
</div>

<!-- MODAL RICHIESTA -->
<div class="modal-backdrop" id="modalReq">
  <div class="modal">
    <h3>ğŸ“ Richiedi prestito</h3>
    <div class="muted" style="margin-bottom:8px;">
      Titolo: <strong id="reqTitoloLabel"></strong>
    </div>
    <div class="row">
      <div>
        <div class="muted">Giocatori</div>
        <input id="reqGiocatori" type="text" disabled>
      </div>
      <div>
        <div class="muted">Nome</div>
        <input id="reqNome" type="text" placeholder="Il tuo nome">
      </div>
    </div>
    <div class="row">
      <div>
        <div class="muted">Telefono</div>
        <input id="reqTel" type="tel" placeholder="es. 393...">
      </div>
      <div>
        <div class="muted">Note</div>
        <input id="reqNote" type="text" placeholder="Opzionale">
      </div>
    </div>
    <div class="muted" id="reqMsg" style="margin-top:6px;"></div>
    <div class="actions">
      <button class="btn btn-neutral" type="button" data-close="modalReq">Annulla</button>
      <button class="btn btn-ok" id="btnSendReq" type="button">Invia richiesta</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby2LtiMH0OabM-O7ACudxF_K0q2X2MYHnCdyFBYi1Te41UcKlIjVh4I4eBODaUonbFv/exec";
const CSV_BASE_URL   = "/catalogo_ludoteca.csv";
const STATS_BASE_URL = "/stats_ludoteca.csv";

const AUTO_REFRESH_MS = 30000;

// bypass PIN (solo se vuoi)
const ADMIN_PIN = "1234";

// cache CSV (client-side)
const CSV_CACHE_TTL_MS = 30000; // 30s (ottimo per 500 righe)

// localStorage keys
const LS_USER_TOKEN     = "AB_USER_TOKEN";
const LS_USER_PROFILE   = "AB_USER_PROFILE";
const LS_PREVIEW        = "AB_PREVIEW";
const LS_ADMIN_BYPASS   = "AB_ADMIN_BYPASS";
const LS_CLEAR_VERSION  = "AB_CLEAR_VERSION_SEEN";

// CSV cache keys
const LS_CSV_CACHE      = "AB_CSV_CACHE_TEXT";
const LS_CSV_CACHE_TIME = "AB_CSV_CACHE_TIME";

/* ===== STATE ===== */
let table = null;
let requestedMap = {};
let appConfig = {
  requireLoginForRequest:false,
  countdownEnabled:true,
  revealAtIso:"",
  clearVersion:0,
  forceClearLocal:false
};
let REVEAL_AT = 0;
let countdownTimer = null;

// request modal state
let REQ_TITLE = "";
let REQ_GIOC = "";

/* ===== UI helpers ===== */
const E = (id)=> document.getElementById(id);

function renderEmoji(){
  try { twemoji.parse(document.body, { folder:"svg", ext:".svg" }); } catch(e){}
}
function showError(msg){ E("errorBox").style.display="block"; E("errorBox").textContent = msg; renderEmoji(); }
function clearError(){ E("errorBox").style.display="none"; E("errorBox").textContent = ""; }
function showInfo(msg){ E("infoBox").style.display="block"; E("infoBox").textContent = msg; renderEmoji(); }
function clearInfo(){ E("infoBox").style.display="none"; E("infoBox").textContent = ""; }

function openModal(id){ E(id).style.display="flex"; renderEmoji(); }
function closeModal(id){ E(id).style.display="none"; }
document.addEventListener("click",(e)=>{
  const close = e.target.getAttribute("data-close");
  if(close) closeModal(close);
});

function setLoading(on, detail){
  const ov = E("loadingOverlay");
  if(on){
    E("loadingDetail").textContent = detail || "Caricamentoâ€¦";
    ov.style.display = "flex";
    renderEmoji();
  }else{
    ov.style.display = "none";
  }
}

/* ===== JSONP ===== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 12000);

    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };

    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&v=" + Date.now();
    document.body.appendChild(s);
  });
}

/* ===== CSV (optimized cache) ===== */
async function fetchTextNoStore(path){
  const url = path + "?v=" + Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`Impossibile caricare ${path} (HTTP ${res.status})`);
  return await res.text();
}

async function getCatalogCsvCached(){
  const t = Number(localStorage.getItem(LS_CSV_CACHE_TIME) || 0);
  const cached = localStorage.getItem(LS_CSV_CACHE);
  const age = Date.now() - t;

  if(cached && t && age >= 0 && age < CSV_CACHE_TTL_MS){
    return { text: cached, fromCache:true };
  }

  const text = await fetchTextNoStore(CSV_BASE_URL);
  try{
    localStorage.setItem(LS_CSV_CACHE, text);
    localStorage.setItem(LS_CSV_CACHE_TIME, String(Date.now()));
  }catch(e){ /* storage pieno? pazienza */ }
  return { text, fromCache:false };
}

function parseCSVText(csvText){
  const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
  return parsed.data || [];
}

/* ===== CONFIG + COUNTDOWN ===== */
function computeRevealAtFromConfig(){
  if(!appConfig.countdownEnabled){ REVEAL_AT = 0; return; }
  if(appConfig.revealAtIso){
    const d = new Date(appConfig.revealAtIso);
    if(!isNaN(d.getTime())){ REVEAL_AT = d.getTime(); return; }
  }
  // fallback: domani 09:00
  const now = new Date();
  REVEAL_AT = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 9, 0, 0, 0).getTime();
}

function isBypassEnabled(){ return localStorage.getItem(LS_ADMIN_BYPASS) === "1"; }
function isPreviewEnabled(){ return localStorage.getItem(LS_PREVIEW) === "1"; }

async function caricaConfig(){
  try{
    const cfg = await jsonp(API_URL + "?action=get_config");
    if(cfg && cfg.ok && cfg.config){
      appConfig = cfg.config;

      // kill switch (opzionale)
      const seen = Number(localStorage.getItem(LS_CLEAR_VERSION) || 0);
      const serverVer = Number(appConfig.clearVersion || 0);
      if(serverVer > seen && appConfig.forceClearLocal){
        localStorage.setItem(LS_CLEAR_VERSION, String(serverVer));
        localStorage.clear();
        localStorage.setItem(LS_CLEAR_VERSION, String(serverVer));
        location.reload();
        return;
      }
      localStorage.setItem(LS_CLEAR_VERSION, String(serverVer));
    }
  }catch(e){}
  computeRevealAtFromConfig();
}

function startCountdownShield(){
  const banner = E("countdownBanner");
  const timeEl = E("countdownTime");

  function unlock(){
    document.body.classList.remove("spoiler-hidden");
    banner.style.display = "none";
    if(countdownTimer) clearInterval(countdownTimer);
  }

  function tick(){
    const prof = getProfile();
    const isAdmin = prof && String(prof.Ruolo||"") === "admin";
    if(isAdmin && isPreviewEnabled()){ unlock(); return; }
    if(isBypassEnabled()){ unlock(); return; }

    if(!appConfig.countdownEnabled){ unlock(); return; }

    const diff = REVEAL_AT - Date.now();
    if(diff <= 0){ unlock(); return; }

    document.body.classList.add("spoiler-hidden");
    banner.style.display = "block";

    const totalSec = Math.floor(diff/1000);
    const h = String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s = String(totalSec%60).padStart(2,"0");
    timeEl.textContent = `${h}:${m}:${s}`;
  }

  tick();
  countdownTimer = setInterval(tick, 1000);

  document.addEventListener("keydown",(e)=>{
    if(e.ctrlKey && e.shiftKey && (e.key||"").toLowerCase() === "b"){
      const pin = prompt("PIN Admin (bypass countdown):");
      if(pin === null) return;
      if(String(pin) === String(ADMIN_PIN)){
        localStorage.setItem(LS_ADMIN_BYPASS, "1");
        alert("Bypass attivato su questo browser.");
      }else{
        alert("PIN errato.");
      }
    }
  });
}

function isUnlocked(){
  const prof = getProfile();
  const isAdmin = prof && String(prof.Ruolo||"") === "admin";
  return (!appConfig.countdownEnabled) || (Date.now() >= REVEAL_AT) || isBypassEnabled() || (isAdmin && isPreviewEnabled());
}

/* ===== Requested map: badge + DISABILITA RICHIEDI ===== */
async function caricaRequestedMap(){
  try{
    const r = await jsonp(API_URL + "?action=requested_map");
    requestedMap = (r && r.ok && r.map) ? r.map : {};
  }catch(e){
    requestedMap = {};
  }
}

function gameBadge(title){
  const t = String(title||"").trim();
  const info = requestedMap[t];
  if(!info) return "";
  if(Number(info.approved||0) > 0) return ' <span class="badge badge-booked">ğŸ“Œ Prenotato</span>';
  if(Number(info.open||0) > 0) return ' <span class="badge badge-req">ğŸŸ£ Richiesto</span>';
  return "";
}

function canRequest(){
  if(!appConfig.requireLoginForRequest) return true;
  return !!localStorage.getItem(LS_USER_TOKEN);
}

function requestButtonHtml(title, gioc){
  const t = String(title||"").trim();
  const info = requestedMap[t];

  // BLOCCO "COME PRIMA": se giÃ  richiesto o prenotato
  if(info && (Number(info.open||0) > 0 || Number(info.approved||0) > 0)){
    const label = (Number(info.approved||0) > 0) ? "ğŸ“Œ Prenotato" : "ğŸŸ£ Richiesto";
    return `<button class="btn btn-neutral" type="button" disabled title="GiÃ  presente una richiesta per questo gioco.">${label}</button>`;
  }

  if(!canRequest()){
    return `<button class="btn btn-neutral" type="button" disabled title="Devi fare accesso per richiedere.">ğŸ”’ Accedi</button>`;
  }

  return `<button class="btn btn-ok btnReq" type="button" data-t="${escapeAttr(t)}" data-g="${escapeAttr(gioc||"")}">ğŸ“ Richiedi</button>`;
}

/* ===== DataTables + Catalogo ===== */
function ensureDataTablesLoaded(){
  if(!window.jQuery) { showError("Errore: jQuery non caricato."); return false; }
  if(!jQuery.fn || !jQuery.fn.DataTable) { showError("Errore: DataTables non caricato (CDN)."); return false; }
  return true;
}

function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function escapeAttr(s){ return escapeHtml(s).replace(/`/g,"&#96;"); }

function statoBadge(stato){
  stato = (stato || "").toLowerCase().trim();
  if(stato === "disponibile") return '<span class="badge badge-disponibile">ğŸ„ Disponibile</span>';
  if(stato === "in prestito") return '<span class="badge badge-prestato">ğŸ In prestito</span>';
  return escapeHtml(stato || "");
}

function buildDataFromRows(raw){
  const data = [];
  raw.forEach(row=>{
    if(!row["Titolo"]) return;
    data.push({
      Titolo: row["Titolo"] || "",
      Giocatori: row["NumeroGiocatori"] || "",
      Durata: row["Durata"] || "",
      Eta: row["Eta"] || "",
      Editore: row["Editore"] || "",
      Disponibili: row["CopieDisponibili"] || "",
      Stato: row["StatoDisponibilita"] || "",
      BGG: row["BGG"] || ""
    });
  });
  return data;
}

async function caricaCatalogoOptimized(){
  if(!ensureDataTablesLoaded()) return;

  setLoading(true, "Scarico e preparo il catalogoâ€¦");

  const { text, fromCache } = await getCatalogCsvCached();
  const raw = parseCSVText(text);
  const data = buildDataFromRows(raw);

  setLoading(true, fromCache ? "Uso cache (30s) + preparo tabellaâ€¦" : "Preparo tabella e filtriâ€¦");

  if(!table){
    table = $("#tblCatalogo").DataTable({
      data: data,
      columns: [
        { data:"Titolo", render:(d)=> `<strong>${escapeHtml(d)}</strong>${gameBadge(d)}` },
        { data:"Giocatori", render:(d)=> escapeHtml(d||"") },
        { data:"Durata", render:(d)=> escapeHtml(d||"") },
        { data:"Eta", render:(d)=> escapeHtml(d||"") },
        { data:"Editore", render:(d)=> escapeHtml(d||"") },
        { data:"Disponibili", render:(d)=> `<strong>${escapeHtml(d ?? "")}</strong>` },
        { data:"Stato", render:(d)=> statoBadge(d) },
        { data:"BGG", orderable:false, render:(d)=>{
            const safe = String(d||"").trim();
            if(!safe) return "";
            if(!/^https?:\/\//i.test(safe)) return "";
            return `<a class="bgg-link" href="${safe}" target="_blank" rel="noopener noreferrer">Scheda</a>`;
          }
        },
        { data:null, orderable:false, render:(d,t,row)=> requestButtonHtml(row.Titolo, row.Giocatori) }
      ],

      // ===== OPTIMIZZAZIONI =====
      deferRender: true,
      processing: true,
      autoWidth: false,
      searchDelay: 250,

      paging:false,
      info:false,
      lengthChange:false,
      order:[[0,"asc"]],
      language:{ url:"https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json" },
      createdRow: function(row,rowData){
        const st = (rowData.Stato||"").toLowerCase().trim();
        if(st === "disponibile") row.classList.add("disponibile-row");
        else if(st === "in prestito") row.classList.add("prestato-row");
      },
      drawCallback: function(){ renderEmoji(); }
    });

    E("filtroStato").addEventListener("change", function(){
      table.column(6).search(this.value, false, false).draw();
    });
    E("filtroGiocatori").addEventListener("keyup", function(){
      table.column(1).search(this.value, false, false).draw();
    });

    document.addEventListener("click",(e)=>{
      const btn = e.target.closest(".btnReq");
      if(!btn) return;
      openRequestModal(btn.getAttribute("data-t"), btn.getAttribute("data-g"));
    });
  } else {
    table.clear();
    table.rows.add(data).draw(false);
  }

  setLoading(false);
}

/* ===== Stats ===== */
async function caricaStats(){
  try{
    const text = await fetchTextNoStore(STATS_BASE_URL);
    const rows = parseCSVText(text);
    if(!rows.length) return;

    const s = rows[0];
    E("cntAttivi").textContent = s["PrestitiAttivi"] || "0";
    E("cntTotali").textContent = s["PrestitiTotali"] || "0";

    const topList = E("topList");
    topList.innerHTML = "";

    function addTop(tKey, cKey){
      const titolo = s[tKey];
      const cnt = s[cKey];
      if(titolo && cnt && Number(cnt) > 0){
        const li = document.createElement("li");
        li.textContent = `${titolo} (${cnt})`;
        topList.appendChild(li);
      }
    }

    addTop("Top1Titolo","Top1Prestiti");
    addTop("Top2Titolo","Top2Prestiti");
    addTop("Top3Titolo","Top3Prestiti");
  }catch(e){}
}

/* ===== Timestamp ===== */
function aggiornaTimestamp(){
  const now = new Date();
  E("lastUpdate").textContent =
    "Ultimo aggiornamento: " +
    now.toLocaleTimeString("it-IT", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
}

/* ===== Auth UI ===== */
function setProfile(profile){
  localStorage.setItem(LS_USER_PROFILE, JSON.stringify(profile||{}));
}
function getProfile(){
  try{ return JSON.parse(localStorage.getItem(LS_USER_PROFILE) || "null"); }catch(e){ return null; }
}
function refreshAuthUI(){
  const token = localStorage.getItem(LS_USER_TOKEN) || "";
  const prof = getProfile();
  const logged = !!token && !!prof;

  E("btnLogout").style.display = logged ? "inline-flex" : "none";
  E("btnAdminLink").style.display = (logged && prof && String(prof.Ruolo||"")==="admin") ? "inline-flex" : "none";
  E("btnLogin").style.display = logged ? "none" : "inline-flex";
  E("btnRegister").style.display = logged ? "none" : "inline-flex";
}

function logout(){
  localStorage.removeItem(LS_USER_TOKEN);
  localStorage.removeItem(LS_USER_PROFILE);
  refreshAuthUI();
  showInfo("Sei uscito.");
  if(table) table.rows().invalidate().draw(false);
}

/* ===== SHA256 (compat: no window.crypto needed) ===== */
function sha256hex(str){
  function r(n,x){return(x>>>n)|(x<<(32-n));}
  function ch(x,y,z){return(x&y)^(~x&z);}
  function maj(x,y,z){return(x&y)^(x&z)^(y&z);}
  function s0(x){return r(2,x)^r(13,x)^r(22,x);}
  function s1(x){return r(6,x)^r(11,x)^r(25,x);}
  function g0(x){return r(7,x)^r(18,x)^(x>>>3);}
  function g1(x){return r(17,x)^r(19,x)^(x>>>10);}
  function toBytes(s){
    const utf8 = unescape(encodeURIComponent(s));
    const b = [];
    for(let i=0;i<utf8.length;i++) b.push(utf8.charCodeAt(i));
    return b;
  }
  const K = [0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,
    0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,
    0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,
    0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,
    0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,
    0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,
    0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,
    0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];
  let H = [0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19];
  const bytes = toBytes(str);
  const l = bytes.length*8;
  bytes.push(0x80);
  while((bytes.length%64)!==56) bytes.push(0);
  for(let i=7;i>=0;i--) bytes.push((l>>> (i*8)) & 0xff);

  for(let i=0;i<bytes.length;i+=64){
    const w = new Array(64);
    for(let t=0;t<16;t++){
      w[t] = (bytes[i+4*t]<<24)|(bytes[i+4*t+1]<<16)|(bytes[i+4*t+2]<<8)|(bytes[i+4*t+3]);
    }
    for(let t=16;t<64;t++){
      w[t] = (g1(w[t-2]) + w[t-7] + g0(w[t-15]) + w[t-16])|0;
    }
    let a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7];
    for(let t=0;t<64;t++){
      const T1 = (h + s1(e) + ch(e,f,g) + K[t] + w[t])|0;
      const T2 = (s0(a) + maj(a,b,c))|0;
      h=g; g=f; f=e; e=(d+T1)|0; d=c; c=b; b=a; a=(T1+T2)|0;
    }
    H[0]=(H[0]+a)|0; H[1]=(H[1]+b)|0; H[2]=(H[2]+c)|0; H[3]=(H[3]+d)|0;
    H[4]=(H[4]+e)|0; H[5]=(H[5]+f)|0; H[6]=(H[6]+g)|0; H[7]=(H[7]+h)|0;
  }
  function hex(x){ return ('00000000'+(x>>>0).toString(16)).slice(-8); }
  return H.map(hex).join('');
}

/* ===== Login / Register ===== */
async function doLogin(){
  const u = (E("loginUser").value||"").trim().toLowerCase();
  const p = (E("loginPass").value||"");
  E("loginMsg").textContent = "";

  if(!u || !p){ E("loginMsg").textContent = "Inserisci username e password."; return; }

  const passHash = sha256hex(p);

  const r = await jsonp(
    API_URL
    + "?action=login"
    + "&username=" + encodeURIComponent(u)
    + "&passhash=" + encodeURIComponent(passHash)
  );

  if(!r || !r.ok){
    // MOSTRA lâ€™errore reale (cosÃ¬ se câ€™Ã¨ qualcosa di strano lo vediamo subito)
    E("loginMsg").textContent = "Login fallito: " + (r?.error || "sconosciuto");
    return;
  }

  localStorage.setItem(LS_USER_TOKEN, r.token);
  setProfile(r.profile);
  closeModal("modalLogin");
  refreshAuthUI();

  showInfo("Accesso effettuato.");
  await aggiornaTutto(true);
}


async function doRegister(){
  const u = (E("regUser").value||"").trim().toLowerCase();
  const nome = (E("regNome").value||"").trim();
  const tel = (E("regTel").value||"").trim();
  const p = (E("regPass").value||"");
  E("regMsg").textContent = "";

  if(!u || !nome || !p){ E("regMsg").textContent = "Compila username, nome e password."; return; }
  if(!/^[a-z0-9]{4,}$/.test(u)){ E("regMsg").textContent = "Username non valido (min 4, solo a-z 0-9)."; return; }

  const passhash = sha256hex(p);

  const url = API_URL + "?action=register"
    + "&username=" + encodeURIComponent(u)
    + "&nome=" + encodeURIComponent(nome)
    + "&telefono=" + encodeURIComponent(tel)
    + "&passhash=" + encodeURIComponent(passhash);

  const r = await jsonp(url);
  if(!r || !r.ok){
    E("regMsg").textContent = "Errore registrazione: " + (r?.error || "sconosciuto");
    return;
  }

  closeModal("modalRegister");
  showInfo("Account creato! Ora puoi fare login.");
}

/* ===== Richiesta prestito ===== */
function openRequestModal(titolo, gioc){
  const info = requestedMap[String(titolo||"").trim()];
  if(info && (Number(info.open||0) > 0 || Number(info.approved||0) > 0)){
    showInfo("Questo gioco Ã¨ giÃ  stato richiesto/prenotato.");
    return;
  }
  if(!canRequest()){
    showInfo("Devi effettuare lâ€™accesso per richiedere.");
    return;
  }

  REQ_TITLE = String(titolo||"").trim();
  REQ_GIOC = String(gioc||"").trim();
  E("reqTitoloLabel").textContent = REQ_TITLE;
  E("reqGiocatori").value = REQ_GIOC;
  E("reqMsg").textContent = "";

  const prof = getProfile();
  if(prof){
    E("reqNome").value = prof.Nome || "";
    E("reqTel").value = prof.Telefono || "";
  } else {
    E("reqNome").value = "";
    E("reqTel").value = "";
  }
  E("reqNote").value = "";

  openModal("modalReq");
}

async function sendRequest(){
  E("reqMsg").textContent = "";
  const nome = (E("reqNome").value||"").trim();
  const tel  = (E("reqTel").value||"").trim();
  const note = (E("reqNote").value||"").trim();

  if(!REQ_TITLE || !nome){ E("reqMsg").textContent = "Inserisci almeno il nome."; return; }

  const token = localStorage.getItem(LS_USER_TOKEN) || "";

  const url = API_URL + "?action=submit"
    + "&Titolo=" + encodeURIComponent(REQ_TITLE)
    + "&Giocatori=" + encodeURIComponent(REQ_GIOC)
    + "&Nome=" + encodeURIComponent(nome)
    + "&Telefono=" + encodeURIComponent(tel)
    + "&Note=" + encodeURIComponent(note)
    + (token ? ("&token=" + encodeURIComponent(token)) : "");

  const r = await jsonp(url);

  if(r && r.ok){
    closeModal("modalReq");
    showInfo("âœ… Richiesta inviata!");

    // disabilita subito (UX immediata)
    const t = REQ_TITLE.trim();
    requestedMap[t] = requestedMap[t] || { open:0, approved:0 };
    requestedMap[t].open = Number(requestedMap[t].open||0) + 1;
    if(table) table.rows().invalidate().draw(false);

    // riallinea da server (cache breve, molto veloce)
    await caricaRequestedMap();
    if(table) table.rows().invalidate().draw(false);
    return;
  }

  E("reqMsg").textContent = "Errore invio. Controlla connessione.";
}

/* ===== Aggiorna tutto (optimized parallel) ===== */
async function aggiornaTutto(force=false){
  clearError(); clearInfo();

  // config sempre prima (controllo countdown)
  await caricaConfig();

  if(!isUnlocked()){
    renderEmoji();
    return;
  }

  // parallelo: requested_map + stats + catalogo
  setLoading(true, "Recupero richieste e datiâ€¦");

  const pMap = caricaRequestedMap();
  const pStats = caricaStats();

  // catalogo: usa cache 30s
  await pMap; // serve per bottoni/badge corretti
  await Promise.all([pStats, caricaCatalogoOptimized()]);

  aggiornaTimestamp();
  setLoading(false);
  renderEmoji();
}

/* ===== Boot ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  await caricaConfig();
  startCountdownShield();

  refreshAuthUI();

  E("btnLogin").addEventListener("click", ()=> openModal("modalLogin"));
  E("btnRegister").addEventListener("click", ()=> openModal("modalRegister"));
  E("btnDoLogin").addEventListener("click", doLogin);
  E("btnDoRegister").addEventListener("click", doRegister);
  E("btnLogout").addEventListener("click", logout);

  E("btnSendReq").addEventListener("click", sendRequest);

  E("btnRefresh").addEventListener("click", ()=> aggiornaTutto(true));

  setInterval(()=> aggiornaTutto(false), AUTO_REFRESH_MS);

  await aggiornaTutto(true);
});
</script>

</body>
</html>
