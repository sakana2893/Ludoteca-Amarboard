<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Catalogo Giochi ‚Äì AmarBoard Natale</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --rosso-natale: #b02030;
      --verde-natale: #1f7a3a;
      --oro-soft:    #f3d08a;
      --bg-chiaro:   #fffaf3;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    .snowflake {
      position: fixed; top: -10px; color: #ffffff; font-size: 1.2rem;
      pointer-events: none; animation-name: fall; animation-timing-function: linear;
      animation-iteration-count: infinite; opacity: 0.85; z-index: 1;
      text-shadow: 0 0 3px rgba(0,0,0,0.3);
    }
    .snowflake:nth-child(1)  { left: 5%;  animation-duration: 12s; animation-delay: 0s; }
    .snowflake:nth-child(2)  { left: 18%; animation-duration: 15s; animation-delay: 2s; }
    .snowflake:nth-child(3)  { left: 32%; animation-duration: 11s; animation-delay: 4s; }
    .snowflake:nth-child(4)  { left: 46%; animation-duration: 13s; animation-delay: 1s; }
    .snowflake:nth-child(5)  { left: 60%; animation-duration: 16s; animation-delay: 3s; }
    .snowflake:nth-child(6)  { left: 74%; animation-duration: 10s; animation-delay: 5s; }
    .snowflake:nth-child(7)  { left: 88%; animation-duration: 14s; animation-delay: 1s; }
    @keyframes fall { 0%{ transform: translateY(0); opacity: 0.95; } 100%{ transform: translateY(110vh); opacity: 0; } }

    .garland {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px;
      background: radial-gradient(circle at center, rgba(31,122,58,0.7), rgba(0,0,0,0.3));
      display: flex; align-items: center; justify-content: center; gap: 10px;
      color: #ffe; font-size: 1.4rem; z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); user-select:none;
    }
    .garland span { animation: blink 2.2s linear infinite; }
    .garland span:nth-child(odd) { animation-delay: 0.7s; }
    @keyframes blink { 0%,100%{ opacity: 0.4; transform: translateY(0);} 50%{ opacity:1; transform: translateY(1px);} }

    #wrapper {
      max-width: 1200px;
      margin: 90px auto 40px;
      padding: 24px 26px 30px;
      background: rgba(255,250,243,0.96);
      border-radius: 20px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 18px rgba(176,32,48,0.4);
      position: relative; z-index: 3;
      border: 2px solid rgba(176,32,48,0.35);
    }
    #wrapper::before {
      content: ""; position: absolute; inset: 8px; border-radius: 16px;
      border: 2px dashed rgba(243,208,138,0.7); pointer-events: none;
    }

    .header-flex {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      position: relative; z-index: 4;
    }
    .header-left { min-height:1px; }
    .header-center { display:flex; align-items:center; justify-content:center; gap:12px; }
    .header-right { display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap; }

    .xmas-icon { font-size: 2rem; }
    .logo-amar {
      height: 76px; width: auto; border-radius: 999px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      background: #fff;
    }

    h1 {
      text-align: center;
      margin: 6px 0;
      font-size: 1.8rem;
      color: var(--rosso-natale);
      text-shadow: 0 1px 0 #fff, 0 0 6px rgba(176,32,48,0.35);
      position: relative; z-index: 4; font-weight: 900;
    }
    .subtitle {
      text-align: center; font-size: 0.9rem; color: #555;
      margin-bottom: 12px; position: relative; z-index: 4; font-weight: 800;
    }
    .subtitle span { color: var(--verde-natale); font-weight: 900; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900;
      background:rgba(255,250,243,0.95);
      border:1px solid rgba(243,208,138,0.85);
      color:#7a0f1a; user-select:none; white-space:nowrap;
    }

    .btn {
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ filter: brightness(0.98); }
    .btn-ok{ border: 1px solid rgba(31,122,58,.55); background: rgba(233,255,240,.95); color:#155724; }
    .btn-no{ border: 1px solid rgba(176,32,48,.45); background: rgba(255,231,231,.92); color:#7a0f1a; }
    .btn-neutral{ border: 1px solid rgba(0,0,0,.18); background: rgba(255,255,255,.92); color:#333; }

    #adminLink{
      display:none; font-weight:900; color:var(--rosso-natale); text-decoration:none;
      background:rgba(255,250,243,0.95); border:1px solid rgba(176,32,48,0.35);
      padding:6px 10px; border-radius:999px; user-select:none; white-space:nowrap;
    }
    #adminLink:hover{ text-decoration: underline; }
    #registerLink{
      font-weight:900; color:var(--verde-natale); text-decoration:none;
      background:rgba(255,250,243,0.95); border:1px solid rgba(31,122,58,0.25);
      padding:6px 10px; border-radius:999px; user-select:none; white-space:nowrap;
    }
    #registerLink:hover{ text-decoration: underline; }

    .stats-bar {
      display: grid; grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px; margin-bottom: 16px; position: relative; z-index: 4;
    }
    .stat-box {
      background: linear-gradient(135deg,#fff,#fffdf7);
      border-radius: 12px; padding: 10px 12px;
      border: 1px solid rgba(176,32,48,0.2);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 0.85rem;
    }
    .stat-label { text-transform: uppercase; color: #666; font-size: 0.75rem; letter-spacing: 0.05em; margin-bottom: 4px; font-weight: 900; }
    .stat-value { font-size: 1.4rem; font-weight: 900; color: var(--rosso-natale); font-variant-numeric: tabular-nums; }
    .stat-note { font-size: 0.75rem; color: #777; margin-top: 3px; font-weight: 800; }
    .stat-top ol { margin: 0; padding-left: 18px; font-size: 0.8rem; font-weight: 800; }

    .filters {
      display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 16px;
      align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
      position: relative; z-index: 4;
    }
    .filters-left { display: flex; flex-wrap: wrap; gap: 14px; align-items: center; }
    .filter-block { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { color: #444; font-size: 0.8rem; font-weight: 900; }
    select, input[type="text"] {
      padding: 6px 8px; border-radius: 10px; border: 1px solid #ccc;
      font-size: 0.85rem; min-width: 140px; background: #fff; font-weight: 800;
    }
    #btnRefresh {
      padding: 8px 12px; border-radius: 12px;
      border: 1px solid var(--verde-natale);
      background: #e9fff0; color: var(--verde-natale);
      font-size: 0.9rem; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      font-weight: 900; user-select:none;
    }
    #btnRefresh:hover { background: #d6ffe5; }

    #lastUpdate {
      font-size: 0.78rem; color: #666; font-weight: 800;
      text-align: right; margin-top: 8px; position: relative; z-index: 4;
    }

    #infoBox{
      display:none; margin: 10px 0 12px; padding: 10px 12px;
      border-radius: 12px; border: 1px solid rgba(31,122,58,0.25);
      background: rgba(233,255,240,0.95); color: #155724;
      font-size: 0.85rem; line-height: 1.35; font-weight: 900;
      position: relative; z-index: 4;
    }
    #errorBox{
      display:none; margin: 10px 0 12px; padding: 10px 12px;
      border-radius: 12px; border: 1px solid rgba(176,32,48,0.35);
      background: rgba(255, 231, 231, 0.85); color: #7a0f1a;
      font-size: 0.85rem; line-height: 1.35; font-weight: 900;
      position: relative; z-index: 4;
    }

    #tblCatalogo_wrapper { margin-top: 6px; position: relative; z-index: 4; }
    table.dataTable thead th {
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom: 2px solid var(--rosso-natale);
      font-weight: 900;
    }
    table.dataTable tbody tr:nth-child(even) { background-color: #fffaf5; }
    table.dataTable tbody tr.disponibile-row { background: linear-gradient(90deg, #f7fff7, #ffffff); }
    table.dataTable tbody tr.prestato-row    { background: linear-gradient(90deg, #fff7f7, #ffffff); }

    .badge {
      padding: 5px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 900;
      display: inline-block; white-space: nowrap; user-select:none;
    }
    .badge-disponibile { background: #d4edda; color: #155724; border: 1px solid #b1dfbb; }
    .badge-prestato    { background: #f8d7da; color: #721c24; border: 1px solid #f1b0b7; }
    .badge-req         { background:#efe1ff; border:1px solid #c9a7ff; color:#4a1a7a; }
    .badge-booked      { background:#ffe8c7; border:1px solid #ffc37a; color:#7a3d00; }

    a.bgg-link { color: var(--rosso-natale); font-size: 0.85rem; text-decoration: none; font-weight: 900; }
    a.bgg-link:hover { text-decoration: underline; }

    .footer-note {
      margin-top: 10px; font-size: 0.85rem; color: #777;
      text-align: right; font-weight: 800; position: relative; z-index: 4;
      display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }

    /* MODALI */
    .modal-backdrop{ position: fixed; inset: 0; z-index: 10050; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal{
      width: min(520px, 100%);
      background: rgba(255,250,243,.98);
      border:2px solid rgba(176,32,48,0.35);
      border-radius: 18px;
      box-shadow: 0 0 24px rgba(0,0,0,.35);
      padding: 14px 14px 12px;
      color:#222;
    }
    .modal h2{ margin:0 0 10px; color:#7a0f1a; font-size: 1.15rem; font-weight: 900; }
    .modal p{ margin:0 0 12px; color:#444; font-size:.9rem; line-height:1.35; font-weight: 800; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label{ font-size:.82rem; font-weight: 900; color:#333; }
    .field input, .field textarea{
      border:1px solid #ccc; border-radius: 12px; padding:10px 10px;
      font-weight: 800; font-family: inherit; background:#fff; font-size:.95rem;
    }
    .field textarea{ min-height: 90px; resize: vertical; }
    .modal .row{ display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap; margin-top: 8px; }
    .msg{
      display:none; margin-top:10px; padding:10px 12px;
      border-radius:12px; font-weight: 900;
      border:1px solid rgba(0,0,0,.1);
      background: rgba(255,255,255,.85);
      line-height:1.35;
    }
    .msg-ok{ border-color: rgba(31,122,58,.25); background: rgba(233,255,240,.95); color:#155724; }
    .msg-no{ border-color: rgba(176,32,48,.25); background: rgba(255,231,231,.92); color:#7a0f1a; }

    /* twemoji */
    img.emoji{ height: 1em; width: 1em; margin: 0 .05em 0 .1em; vertical-align: -0.1em; }

    /* COUNTDOWN */
    #countdownBanner{
      position: fixed;
      inset: 70px 16px auto 16px;
      max-width: 1200px;
      margin: 0 auto;
      z-index: 9999;
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.35);
      box-shadow: 0 0 18px rgba(176,32,48,0.25);
      border-radius: 16px;
      padding: 14px 16px;
      text-align: center;
      color: #7a0f1a;
      font-weight: 900;
    }
    #countdownBanner small{ display:block; margin-top:6px; font-weight: 800; color:#444; }
    #countdownTime{ font-variant-numeric: tabular-nums; font-size: 1.4rem; color: #b02030; }

    .spoiler-hidden #wrapper{
      filter: blur(10px);
      pointer-events: none;
      user-select: none;
    }
    .spoiler-hidden #wrapper::after{
      content:"Catalogo in arrivo‚Ä¶";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.4rem;
      font-weight: 900;
      color: rgba(122,15,26,0.85);
    }

    @media(max-width: 900px) { .stats-bar { grid-template-columns: 1fr; } .grid2{ grid-template-columns: 1fr; } }
    @media(max-width: 768px) {
      #wrapper { margin: 80px 10px 20px; padding: 14px; }
      .filters { flex-direction: column; align-items: stretch; }
      .logo-amar { height: 70px; }
      #lastUpdate { text-align:left; }
      .footer-note{ justify-content:flex-start; }
      .header-flex { grid-template-columns: 1fr; }
      .header-right { justify-content: center; }
    }
  </style>
</head>

<body>

<div id="countdownBanner" style="display:none;">
  üéÅ La pagina si sblocca tra <span id="countdownTime">--:--:--</span>
  <small>Fino a quell‚Äôora il catalogo resta ‚Äúcoperto‚Äù.</small>
</div>

<div class="garland">
  <span>‚ú®</span><span>üéÑ</span><span>‚≠ê</span><span>üïØÔ∏è</span>
  <span>üé≤ AmarBoard Romagna üé≤</span>
  <span>‚≠ê</span><span>üéÑ</span><span>‚ú®</span>
</div>

<div class="snowflake">‚ùÑ</div>
<div class="snowflake">‚úª</div>
<div class="snowflake">‚ùÖ</div>
<div class="snowflake">‚ùÜ</div>
<div class="snowflake">‚ùÑ</div>
<div class="snowflake">‚úµ</div>
<div class="snowflake">‚ùÑ</div>

<div id="wrapper">
  <div class="header-flex">
    <div class="header-left"></div>

    <div class="header-center">
      <span class="xmas-icon">üéÑ</span>
      <img class="logo-amar" src="logo_amarboard.png" alt="AmarBoard Romagna">
      <span class="xmas-icon">üé≤</span>
    </div>

    <div class="header-right">
      <a id="adminLink" href="admin.html">üõ°Ô∏è Area Admin</a>
      <a id="registerLink" href="register.html">üßæ Registrati</a>

      <span class="pill" id="userPill" style="display:none;">
        üë§ <span id="userName">‚Äì</span>
        <span id="userRole" style="display:none; opacity:.85;">(admin)</span>
      </span>

      <button class="btn btn-ok" id="btnLogin" type="button">üîë Accedi</button>
      <button class="btn btn-no" id="btnLogout" type="button" style="display:none;">üö™ Logout</button>
    </div>
  </div>

  <h1>Catalogo Giochi ‚Äì AmarBoard</h1>
  <div class="subtitle">
    <span>Speciale Natale:</span> trova il gioco giusto (o fatti suggerire dai nostri Volontari) da intavolare con gli amici sui nostri tavoli.
  </div>

  <div class="stats-bar">
    <div class="stat-box">
      <div class="stat-label">Giochi attualmente in prestito</div>
      <div class="stat-value" id="cntAttivi">‚Äì</div>
      <div class="stat-note">Numero di prestiti attivi in questo momento.</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Prestiti totali effettuati</div>
      <div class="stat-value" id="cntTotali">‚Äì</div>
      <div class="stat-note">Conteggio cumulativo dei prestiti registrati.</div>
    </div>
    <div class="stat-box stat-top">
      <div class="stat-label">Top 3 giochi pi√π prestati ora</div>
      <ol id="topList"></ol>
    </div>
  </div>

  <div class="filters">
    <div class="filters-left">
      <div class="filter-block">
        <span class="filter-label">Stato</span>
        <select id="filtroStato">
          <option value="">Tutti</option>
          <option value="Disponibile">Disponibile</option>
          <option value="In prestito">In prestito</option>
        </select>
      </div>

      <div class="filter-block">
        <span class="filter-label">Giocatori (contiene)</span>
        <input type="text" id="filtroGiocatori" placeholder="es. 2-4">
      </div>
    </div>

    <button id="btnRefresh" type="button">üîÑ Aggiorna dati</button>
  </div>

  <div id="infoBox"></div>
  <div id="errorBox"></div>
  <div id="lastUpdate">Ultimo aggiornamento: ‚Äì</div>

  <table id="tblCatalogo" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Titolo</th>
        <th>Giocatori</th>
        <th>Durata</th>
        <th>Et√†</th>
        <th>Editore</th>
        <th>Disponibili</th>
        <th>Stato</th>
        <th>BGG</th>
        <th>Richiedi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="footer-note">
    <span>üéÖ Catalogo generato dalla ludoteca AmarBoard ‚Äì versione natalizia</span>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-backdrop" id="loginBackdrop">
  <div class="modal">
    <h2>üîë Accesso Utente</h2>
    <p>Inserisci username e password.</p>

    <div class="grid2">
      <div class="field">
        <label for="loginUser">Username</label>
        <input id="loginUser" type="text" autocomplete="username">
      </div>
      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password">
      </div>
    </div>

    <div class="row">
      <button class="btn btn-neutral" id="btnLoginCancel" type="button">Annulla</button>
      <button class="btn btn-ok" id="btnLoginDo" type="button">Entra</button>
    </div>

    <div class="msg msg-no" id="loginMsg"></div>
  </div>
</div>

<!-- REQUEST MODAL -->
<div class="modal-backdrop" id="reqBackdrop">
  <div class="modal">
    <h2>üìù Richiedi Prestito</h2>
    <p>Compila i dati. Se sei loggato, nome e telefono verranno precompilati.</p>

    <div class="field">
      <label>Titolo</label>
      <input id="reqTitolo" type="text" readonly>
    </div>

    <div class="grid2">
      <div class="field">
        <label>Giocatori</label>
        <input id="reqGiocatori" type="text" readonly>
      </div>
      <div class="field">
        <label>Telefono</label>
        <input id="reqTelefono" type="text" placeholder="es. 3331234567">
      </div>
    </div>

    <div class="field">
      <label>Nome</label>
      <input id="reqNome" type="text" placeholder="Nome e cognome">
    </div>

    <div class="field">
      <label>Note (opzionale)</label>
      <textarea id="reqNote" placeholder="es. Arrivo alle 18:30..."></textarea>
    </div>

    <div class="row">
      <button class="btn btn-neutral" id="btnReqCancel" type="button">Annulla</button>
      <button class="btn btn-ok" id="btnReqSend" type="button">üì© Invia richiesta</button>
    </div>

    <div class="msg" id="reqMsg"></div>
  </div>
</div>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbymY3lNuMU13fv2NSXJBBAkGh0iOMzABjzuWnARGjsY_UHr7ZWEUM6wss9f1A2zbi9dcA/exec";
const CSV_BASE_URL   = "catalogo_ludoteca.csv";
const STATS_BASE_URL = "stats_ludoteca.csv";

const LS_USER_TOKEN   = "AB_USER_TOKEN";
const LS_USER_PROFILE = "AB_USER_PROFILE";

const LS_PREVIEW = "AB_PREVIEW";         // preview admin (da admin.html)
const LS_ADMIN_BYPASS = "AB_ADMIN_BYPASS"; // opzionale
const ADMIN_PIN = "1234"; // se vuoi ancora pin (opzionale)

const AUTO_REFRESH_MS = 30000;

let table = null;
let currentUser = null;
let requestedMap = {};
let countdownTimer = null;

let appConfig = {
  requireLoginForRequest: false,
  countdownEnabled: true,
  revealAtIso: "" // se vuoto -> fallback domani 09:00
};

let REVEAL_AT = 0; // calcolato da config

function E(id){ return document.getElementById(id); }
function renderEmoji(){ try { twemoji.parse(document.body, { folder:"svg", ext:".svg" }); } catch(e){} }

function showInfo(msg){ const box=E("infoBox"); box.style.display="block"; box.textContent=msg; }
function clearInfo(){ const box=E("infoBox"); box.style.display="none"; box.textContent=""; }
function showError(msg){ const box=E("errorBox"); box.style.display="block"; box.textContent=msg; }
function clearError(){ const box=E("errorBox"); box.style.display="none"; box.textContent=""; }

function aggiornaTimestamp(){
  const now = new Date();
  E("lastUpdate").textContent = "Ultimo aggiornamento: " +
    now.toLocaleTimeString("it-IT", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
}

function isAdminUser(){ return currentUser && String(currentUser.Ruolo||"") === "admin"; }
function isPreviewEnabled(){ return localStorage.getItem(LS_PREVIEW) === "1"; }
function isBypassEnabled(){ return localStorage.getItem(LS_ADMIN_BYPASS) === "1"; }
function setBypassEnabled(on){ localStorage.setItem(LS_ADMIN_BYPASS, on ? "1":"0"); }

function computeRevealAtFromConfig(){
  // Se countdown disattivo -> reveal immediato
  if(!appConfig.countdownEnabled){
    REVEAL_AT = 0;
    return;
  }

  // Se revealAtIso valido -> usalo
  if(appConfig.revealAtIso){
    const d = new Date(appConfig.revealAtIso);
    if(!isNaN(d.getTime())){
      REVEAL_AT = d.getTime();
      return;
    }
  }

  // Fallback: domani alle 09:00
  const now = new Date();
  REVEAL_AT = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 9, 0, 0, 0).getTime();
}

/* JSONP */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 10000);

    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };

    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&v=" + Date.now();
    document.body.appendChild(s);
  });
}

/* CSV fetch */
async function fetchTextNoStore(path){
  const url = path + "?v=" + Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`Impossibile caricare ${path} (HTTP ${res.status})`);
  return await res.text();
}
function parseCSVText(csvText){
  const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
  return parsed.data || [];
}

/* Config dal server */
async function caricaConfig(){
  try{
    const cfg = await jsonp(API_URL + "?action=get_config");
    if(cfg && cfg.ok && cfg.config){
      appConfig = cfg.config;
      computeRevealAtFromConfig();
    } else {
      computeRevealAtFromConfig();
    }
  }catch(e){
    computeRevealAtFromConfig();
  }
}

/* COUNTDOWN */
function startCountdownShield(){
  const banner = E("countdownBanner");
  const timeEl = E("countdownTime");

  function unlock(){
    document.body.classList.remove("spoiler-hidden");
    banner.style.display = "none";
    if(countdownTimer) clearInterval(countdownTimer);
  }

  function tick(){
    // preview/admin bypass countdown
    if(isAdminUser() && isPreviewEnabled()){
      unlock();
      return;
    }

    // opzionale: pin bypass
    if(isAdminUser() || isBypassEnabled()){
      unlock();
      return;
    }

    // countdown disattivo -> sempre sbloccato
    if(!appConfig.countdownEnabled){
      unlock();
      return;
    }

    const diff = REVEAL_AT - Date.now();
    if(diff <= 0){
      unlock();
      return;
    }

    document.body.classList.add("spoiler-hidden");
    banner.style.display = "block";

    const totalSec = Math.floor(diff/1000);
    const h = String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s = String(totalSec%60).padStart(2,"0");
    timeEl.textContent = `${h}:${m}:${s}`;
  }

  tick();
  countdownTimer = setInterval(tick, 1000);
}

/* Badge richiesto/prenotato */
function gameReqBadge(titolo){
  const t = String(titolo||"").trim();
  if(!t) return "";
  const x = requestedMap[t];
  if(!x) return "";
  if(Number(x.approved||0) > 0) return ' <span class="badge badge-booked">üìå Prenotato</span>';
  if(Number(x.open||0) > 0) return ' <span class="badge badge-req">üü£ Richiesto</span>';
  return "";
}

async function caricaRequestedMap(){
  try{
    const data = await jsonp(API_URL + "?action=requested_map");
    requestedMap = (data && data.ok && data.map) ? data.map : {};
  }catch(e){
    requestedMap = {};
  }
}

/* Stats */
async function caricaStats(){
  try{
    const text = await fetchTextNoStore(STATS_BASE_URL);
    const rows = parseCSVText(text);
    if(!rows.length) return;

    const s = rows[0];
    E("cntAttivi").textContent = s["PrestitiAttivi"] || "0";
    E("cntTotali").textContent = s["PrestitiTotali"] || "0";

    const topList = E("topList");
    topList.innerHTML = "";

    function addTop(tKey, cKey){
      const titolo = s[tKey];
      const cnt = s[cKey];
      if(titolo && cnt && Number(cnt) > 0){
        const li = document.createElement("li");
        li.textContent = `${titolo} (${cnt})`;
        topList.appendChild(li);
      }
    }

    addTop("Top1Titolo","Top1Prestiti");
    addTop("Top2Titolo","Top2Prestiti");
    addTop("Top3Titolo","Top3Prestiti");
    addTop("TopEvento1Titolo","TopEvento1Val");
    addTop("TopEvento2Titolo","TopEvento2Val");
    addTop("TopEvento3Titolo","TopEvento3Val");
  }catch(e){}
}

/* DataTables safe */
function ensureDataTablesLoaded(){
  if(!window.jQuery) { showError("Errore: jQuery non caricato."); return false; }
  if(!jQuery.fn || !jQuery.fn.DataTable) { showError("Errore: DataTables non caricato (CDN)."); return false; }
  if(!document.getElementById("tblCatalogo")) { showError("Errore: tabella non trovata."); return false; }
  return true;
}

function statoBadge(stato){
  stato = (stato || "").toLowerCase().trim();
  if(stato === "disponibile") return '<span class="badge badge-disponibile">üéÑ Disponibile</span>';
  if(stato === "in prestito") return '<span class="badge badge-prestato">üéÅ In prestito</span>';
  return stato || "";
}

/* Richieste solo utenti */
function canRequest(){
  if(!appConfig.requireLoginForRequest) return true;
  return !!localStorage.getItem(LS_USER_TOKEN);
}
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function escapeAttr(s){ return escapeHtml(s).replace(/`/g,"&#96;"); }

function requestButtonHtml(title, gioc){
  if(!canRequest()){
    return `<button class="btn btn-neutral" type="button" disabled title="Devi fare accesso per richiedere.">üîí Accedi</button>`;
  }
  return `<button class="btn btn-ok btnReq" type="button"
            data-titolo="${escapeAttr(title)}"
            data-giocatori="${escapeAttr(gioc)}">üìù Richiedi</button>`;
}

async function caricaCatalogo(){
  if(!ensureDataTablesLoaded()) return;

  const text = await fetchTextNoStore(CSV_BASE_URL);
  const raw = parseCSVText(text);

  const data = [];
  raw.forEach(row=>{
    if(!row["Titolo"]) return;
    data.push({
      Titolo: row["Titolo"] || "",
      Giocatori: row["NumeroGiocatori"] || "",
      Durata: row["Durata"] || "",
      Eta: row["Eta"] || "",
      Editore: row["Editore"] || "",
      Disponibili: row["CopieDisponibili"] || "",
      Stato: row["StatoDisponibilita"] || "",
      BGG: row["BGG"] || ""
    });
  });

  if(!table){
    try{
      table = $("#tblCatalogo").DataTable({
        data: data,
        destroy: true,
        retrieve: true,
        columns: [
          { data:"Titolo", render:(d)=> `<strong>${escapeHtml(d)}</strong>${gameReqBadge(d)}` },
          { data:"Giocatori" },
          { data:"Durata" },
          { data:"Eta" },
          { data:"Editore" },
          { data:"Disponibili", render:(d)=> `<strong>${escapeHtml(d ?? "")}</strong>` },
          { data:"Stato", render:(d)=> statoBadge(d) },
          { data:"BGG", orderable:false, render:(d)=>{
              const safe = String(d||"").trim();
              if(!safe) return "";
              if(!/^https?:\/\//i.test(safe)) return "";
              return `<a class="bgg-link" href="${safe}" target="_blank" rel="noopener noreferrer">Scheda</a>`;
            }
          },
          { data:null, orderable:false, render:(d,t,row)=> requestButtonHtml(String(row.Titolo||""), String(row.Giocatori||"")) }
        ],
        paging:false,
        info:false,
        lengthChange:false,
        order:[[0,"asc"]],
        language:{ url:"https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json" },
        createdRow:function(row,rowData){
          const st = (rowData.Stato||"").toLowerCase().trim();
          if(st === "disponibile") row.classList.add("disponibile-row");
          else if(st === "in prestito") row.classList.add("prestato-row");
        },
        drawCallback:function(){ renderEmoji(); }
      });

      E("filtroStato").addEventListener("change", function(){
        table.column(6).search(this.value, false, false).draw();
      });
      E("filtroGiocatori").addEventListener("keyup", function(){
        table.column(1).search(this.value, false, false).draw();
      });

      document.addEventListener("click", (e)=>{
        const btn = e.target.closest(".btnReq");
        if(!btn) return;
        openRequestModal(btn.getAttribute("data-titolo"), btn.getAttribute("data-giocatori"));
      });

    }catch(e){
      table = null;
      showError("Errore DataTables: " + (e?.message ?? String(e)));
    }
  } else {
    table.clear();
    table.rows.add(data).draw(false);
  }
}

/* Aggiorna tutto */
async function aggiornaTutto(){
  clearError(); clearInfo();
  try{
    await caricaConfig();

    if(appConfig.requireLoginForRequest && !localStorage.getItem(LS_USER_TOKEN)){
      showInfo("üîí Le richieste sono abilitate solo per utenti registrati: fai accesso o registrati.");
    }

    await caricaRequestedMap();
    await Promise.all([caricaStats(), caricaCatalogo()]);
    aggiornaTimestamp();
    renderEmoji();
  }catch(e){
    showError("Errore refresh: " + (e?.message ?? String(e)));
  }
}

/* MODALI */
function openLogin(){
  E("loginMsg").style.display="none"; E("loginMsg").textContent="";
  E("loginUser").value=""; E("loginPass").value="";
  E("loginBackdrop").style.display="flex";
  setTimeout(()=> E("loginUser").focus(), 50);
  renderEmoji();
}
function closeLogin(){ E("loginBackdrop").style.display="none"; }

function openRequestModal(titolo, giocatori){
  if(!canRequest()){
    showInfo("üîí Per richiedere devi essere registrato e fare accesso.");
    return;
  }

  E("reqTitolo").value = titolo || "";
  E("reqGiocatori").value = giocatori || "";

  let prof=null;
  try{ prof = JSON.parse(localStorage.getItem(LS_USER_PROFILE) || "null"); }catch(e){}
  E("reqNome").value = (prof && prof.Nome) ? prof.Nome : "";
  E("reqTelefono").value = (prof && prof.Telefono) ? prof.Telefono : "";
  E("reqNote").value = "";

  const m=E("reqMsg");
  m.style.display="none"; m.textContent=""; m.className="msg";

  E("reqBackdrop").style.display="flex";
  renderEmoji();
}
function closeRequestModal(){ E("reqBackdrop").style.display="none"; }

/* SHA256 (client) */
function sha256Hex(ascii){
  function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }
  const mathPow = Math.pow, maxWord = mathPow(2,32);
  let result = '';
  const words = [];
  const asciiBitLength = ascii.length*8;

  let hash = sha256Hex.h = sha256Hex.h || [];
  let k = sha256Hex.k = sha256Hex.k || [];
  let primeCounter = k.length;

  const isComposite = {};
  for (let candidate = 2; primeCounter < 64; candidate++) {
    if (!isComposite[candidate]) {
      for (let i = 0; i < 313; i += candidate) isComposite[i] = candidate;
      hash[primeCounter] = (mathPow(candidate, .5)*maxWord)|0;
      k[primeCounter++] = (mathPow(candidate, 1/3)*maxWord)|0;
    }
  }

  ascii += '\x80';
  while (ascii.length%64 - 56) ascii += '\x00';
  for (let i = 0; i < ascii.length; i++) {
    const j = ascii.charCodeAt(i);
    words[i>>2] |= j << ((3 - i)%4)*8;
  }
  words[words.length] = ((asciiBitLength/maxWord)|0);
  words[words.length] = (asciiBitLength);

  for (let j = 0; j < words.length;) {
    const w = words.slice(j, j += 16);
    const oldHash = hash.slice(0);

    for (let i = 0; i < 64; i++) {
      const w15 = w[i - 15], w2 = w[i - 2];
      const a = hash[0], e = hash[4];
      const temp1 = hash[7]
        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
        + ((e&hash[5]) ^ ((~e)&hash[6]))
        + k[i]
        + (w[i] = (i < 16) ? w[i] : (
          w[i - 16]
          + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3))
          + w[i - 7]
          + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
        )|0);

      const temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
        + ((a&hash[1]) ^ (a&hash[2]) ^ (hash[1]&hash[2]));

      hash = [(temp1 + temp2)|0].concat(hash);
      hash[4] = (hash[4] + temp1)|0;
      hash.pop();
    }
    for (let i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i])|0;
  }

  for (let i = 0; i < 8; i++) {
    for (let j = 3; j + 1; j--) {
      const b = (hash[i] >> (j * 8)) & 255;
      result += ((b < 16) ? 0 : '') + b.toString(16);
    }
  }
  return result;
}

/* Login flow */
async function doLogin(){
  const u = String(E("loginUser").value||"").trim().toLowerCase();
  const p = String(E("loginPass").value||"");
  if(!u || !p){
    const m=E("loginMsg"); m.style.display="block"; m.textContent="Inserisci username e password.";
    return;
  }
  try{
    const ch = await jsonp(API_URL + "?action=challenge&username=" + encodeURIComponent(u));
    if(!ch || !ch.ok || !ch.nonce) throw new Error("challenge_failed");
    const passHash = sha256Hex(p);
    const proof = sha256Hex(passHash + ":" + ch.nonce);

    const resp = await jsonp(API_URL + "?action=login_challenge&username=" + encodeURIComponent(u) + "&nonce=" + encodeURIComponent(ch.nonce) + "&proof=" + encodeURIComponent(proof));
    if(!resp || !resp.ok || !resp.token || !resp.profile) throw new Error("login_failed");

    localStorage.setItem(LS_USER_TOKEN, resp.token);
    localStorage.setItem(LS_USER_PROFILE, JSON.stringify(resp.profile));
    currentUser = resp.profile;

    refreshUserUI();
    closeLogin();

    await caricaConfig();
    startCountdownShield();

    await aggiornaTutto();
  }catch(e){
    const m=E("loginMsg"); m.style.display="block"; m.textContent="Credenziali non valide o utente disattivato.";
  }
}

async function restoreSession(){
  try{
    const token = localStorage.getItem(LS_USER_TOKEN) || "";
    if(!token) return;
    const me = await jsonp(API_URL + "?action=me&token=" + encodeURIComponent(token));
    if(me && me.ok && me.profile){
      currentUser = me.profile;
      localStorage.setItem(LS_USER_PROFILE, JSON.stringify(currentUser));
      refreshUserUI();
      return;
    }
  }catch(e){}
  localStorage.removeItem(LS_USER_TOKEN);
  localStorage.removeItem(LS_USER_PROFILE);
  currentUser = null;
  refreshUserUI();
}

function refreshUserUI(){
  const pill = E("userPill");
  const btnLogin = E("btnLogin");
  const btnLogout = E("btnLogout");
  const adminLink = E("adminLink");
  const role = E("userRole");

  if(currentUser){
    E("userName").textContent = currentUser.Nome || currentUser.Username || "Utente";
    pill.style.display="inline-flex";
    btnLogin.style.display="none";
    btnLogout.style.display="inline-flex";

    const a = isAdminUser();
    adminLink.style.display = a ? "inline-flex" : "none";
    role.style.display = a ? "inline" : "none";
  } else {
    pill.style.display="none";
    btnLogin.style.display="inline-flex";
    btnLogout.style.display="none";
    adminLink.style.display="none";
    role.style.display="none";
  }
  renderEmoji();
}

function doLogout(){
  localStorage.removeItem(LS_USER_TOKEN);
  localStorage.removeItem(LS_USER_PROFILE);
  currentUser = null;
  refreshUserUI();
  startCountdownShield();
  aggiornaTutto();
}

/* Submit richiesta */
async function sendRequest(){
  const titolo = String(E("reqTitolo").value||"").trim();
  const gioc = String(E("reqGiocatori").value||"").trim();
  const nome = String(E("reqNome").value||"").trim();
  const tel = String(E("reqTelefono").value||"").trim();
  const note = String(E("reqNote").value||"").trim();

  const msg = E("reqMsg");
  msg.style.display="none"; msg.textContent=""; msg.className="msg";

  if(!titolo || !nome){
    msg.className="msg msg-no"; msg.style.display="block"; msg.textContent="Compila almeno Titolo e Nome.";
    return;
  }

  const token = localStorage.getItem(LS_USER_TOKEN) || "";
  if(appConfig.requireLoginForRequest && !token){
    msg.className="msg msg-no"; msg.style.display="block"; msg.textContent="üîí Richieste solo per utenti registrati: fai accesso.";
    return;
  }

  E("btnReqSend").disabled = true; E("btnReqSend").style.opacity="0.7";

  const body = new URLSearchParams();
  body.set("action","submit");
  body.set("Titolo", titolo);
  body.set("Giocatori", gioc);
  body.set("Nome", nome);
  body.set("Telefono", tel);
  body.set("Note", note);
  if(token) body.set("token", token);

  try{
    let sent=false;

    try{
      const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body: body.toString() });
      const j = await res.json();
      if(j && j.ok) sent=true;
    }catch(e1){
      // fallback no-cors
      await fetch(API_URL, { method:"POST", mode:"no-cors", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body: body.toString() });
      sent=true;
    }

    if(sent){
      msg.className="msg msg-ok"; msg.style.display="block"; msg.textContent="‚úÖ Richiesta inviata!";
      setTimeout(async ()=>{ await aggiornaTutto(); }, 1200);
      setTimeout(()=> closeRequestModal(), 1600);
    } else {
      throw new Error("invio_non_riuscito");
    }
  }catch(e){
    msg.className="msg msg-no"; msg.style.display="block"; msg.textContent="‚ùå Errore invio. Controlla connessione e riprova.";
  }finally{
    E("btnReqSend").disabled = false; E("btnReqSend").style.opacity="1";
  }

  renderEmoji();
}

/* Boot */
document.addEventListener("DOMContentLoaded", async ()=>{
  E("btnLogin").addEventListener("click", openLogin);
  E("btnLogout").addEventListener("click", doLogout);
  E("btnLoginCancel").addEventListener("click", closeLogin);
  E("btnLoginDo").addEventListener("click", doLogin);
  E("loginBackdrop").addEventListener("click", (e)=>{ if(e.target === E("loginBackdrop")) closeLogin(); });
  E("loginPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  E("btnReqCancel").addEventListener("click", closeRequestModal);
  E("btnReqSend").addEventListener("click", sendRequest);
  E("reqBackdrop").addEventListener("click", (e)=>{ if(e.target === E("reqBackdrop")) closeRequestModal(); });

  E("btnRefresh").addEventListener("click", async ()=>{
    // non spoilerare se countdown attivo e non bypass
    if(appConfig.countdownEnabled && Date.now() < REVEAL_AT && !(isAdminUser() && isPreviewEnabled()) && !isBypassEnabled()) return;
    await aggiornaTutto();
  });

  // PIN bypass (opzionale)
  // Se non lo vuoi pi√π, puoi cancellare questo blocco senza toccare altro:
  document.addEventListener("keydown", async (e)=>{
    if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "b"){
      const pin = prompt("Inserisci PIN admin (bypass):");
      if(pin && String(pin).trim() === ADMIN_PIN){
        setBypassEnabled(true);
        await aggiornaTutto();
        startCountdownShield();
      } else if(pin !== null){
        alert("PIN errato.");
      }
    }
  });

  await restoreSession();
  await caricaConfig();
  startCountdownShield();

  // Se siamo coperti, non carico per non spoilerare
  if(appConfig.countdownEnabled && Date.now() < REVEAL_AT && !(isAdminUser() && isPreviewEnabled()) && !isBypassEnabled()){
    renderEmoji();
    return;
  }

  await aggiornaTutto();

  setInterval(()=>{
    if(appConfig.countdownEnabled && Date.now() < REVEAL_AT && !(isAdminUser() && isPreviewEnabled()) && !isBypassEnabled()) return;
    aggiornaTutto();
  }, AUTO_REFRESH_MS);

  renderEmoji();
});
</script>

</body>
</html>
