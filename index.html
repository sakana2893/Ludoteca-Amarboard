<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Catalogo Giochi â€“ AmarBoard</title>

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    background:#111;
    color:#f5f5f5;
  }
  #wrap{
    max-width:1200px;
    margin:20px auto;
    padding:20px;
    background:#181818;
    border-radius:14px;
    border:1px solid #333;
  }
  h1{
    margin:0 0 8px;
    color:#f3d08a;
  }
  .sub{
    color:#ccc;
    margin-bottom:16px;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .admin-link{
    font-size:.8rem;
    color:#8bd1ff;
    text-decoration:none;
  }

  button{
    padding:6px 10px;
    border-radius:8px;
    border:1px solid #444;
    background:#222;
    color:#fff;
    cursor:pointer;
    font-weight:700;
  }
  button:hover{ background:#2a2a2a; }

  table.dataTable{
    color:#f5f5f5;
  }
  table.dataTable thead th{
    background:#222;
    border-bottom:2px solid #b02030;
  }

  /* ===== MODAL ===== */
  #modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  #modal .box{
    width:360px;
    background:#181818;
    border:1px solid #444;
    border-radius:14px;
    padding:16px;
  }
  #modal h3{ margin-top:0; color:#f3d08a; }

  input, textarea{
    width:100%;
    margin-bottom:8px;
    padding:6px 8px;
    background:#111;
    color:#fff;
    border:1px solid #444;
    border-radius:8px;
  }
  .ok{ color:#a9ffbd; font-size:.85rem; }
  .err{ color:#ffd7d7; font-size:.85rem; }

  #pWebsite{ display:none; } /* honeypot */
</style>
</head>

<body>

<div id="wrap">
  <div class="topbar">
    <div></div>
    <a class="admin-link" href="admin.html" target="_blank">Admin</a>
  </div>

  <h1>Catalogo Giochi â€“ AmarBoard</h1>
  <div class="sub">
    Speciale Natale: scegli un gioco o richiedi la prenotazione al banco.
  </div>

  <table id="tbl" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Titolo</th>
        <th>Giocatori</th>
        <th>Durata</th>
        <th>Disponibili</th>
        <th>Azione</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- MODAL PRENOTA -->
<div id="modal">
  <div class="box">
    <h3 id="mTitolo">Richiedi</h3>

    <input id="pNome" placeholder="Nome e cognome">
    <input id="pTel" placeholder="Telefono (opzionale)">
    <textarea id="pNote" placeholder="Note (opzionale)"></textarea>
    <input id="pWebsite">

    <div id="mOk" class="ok"></div>
    <div id="mErr" class="err"></div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="pInvia" onclick="invia()">Invia</button>
      <button onclick="closeModal()">Annulla</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbwV70W8B8yHZZN9mvYEukuMq4gq8cJrgcie9ZL1KBE/dev";
const CSV_URL = "/catalogo_ludoteca.csv";

/* ===== STATE ===== */
let table;
let ctx = { titolo:"", giocatori:"" };

/* ===== MODAL ===== */
function openModal(t,g){
  ctx.titolo=t; ctx.giocatori=g;
  document.getElementById("mTitolo").textContent = "Prenota: " + t;
  document.getElementById("modal").style.display="flex";
}
function closeModal(){
  document.getElementById("modal").style.display="none";
  document.getElementById("mOk").textContent="";
  document.getElementById("mErr").textContent="";
}

/* ===== INVIO (NO-CORS) ===== */
async function invia(){
  const nome = pNome.value.trim();
  if(nome.length<2){ mErr.textContent="Inserisci il nome."; return; }

  const body = new URLSearchParams({
    titolo: ctx.titolo,
    giocatori: ctx.giocatori,
    nome,
    telefono: pTel.value.trim(),
    note: pNote.value.trim(),
    website: pWebsite.value.trim()
  });

  pInvia.disabled=true;
  try{
    await fetch(API_URL,{method:"POST",mode:"no-cors",body});
    mOk.textContent="Richiesta inviata âœ…";
    setTimeout(closeModal,900);
  }catch(e){
    mErr.textContent="Errore invio";
  }finally{
    pInvia.disabled=false;
  }
}

/* ===== LOAD CSV ===== */
Papa.parse(CSV_URL+"?v="+Date.now(),{
  download:true,
  header:true,
  complete:(res)=>{
    const data = res.data.filter(r=>r.Titolo);
    table = $("#tbl").DataTable({
      data,
      paging:false,
      info:false,
      columns:[
        {data:"Titolo"},
        {data:"NumeroGiocatori"},
        {data:"Durata"},
        {data:"CopieDisponibili"},
        {data:null,render:r=>
          `<button onclick="openModal('${r.Titolo.replace(/'/g,"\\'")}','${r.NumeroGiocatori||""}')">
            ðŸ“Œ Richiedi
          </button>`
        }
      ]
    });
  }
});
</script>

</body>
</html>
