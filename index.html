<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ludoteca Amarboard</title>

  <!-- Anti-cache browser -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: #fafafa;
      color: #111;
    }

    header {
      position: sticky;
      top: 0;
      background: white;
      border-bottom: 1px solid #e6e6e6;
      padding: 14px 16px;
      z-index: 10;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    .subtitle {
      margin-top: 6px;
      font-size: 14px;
      color: #333;
    }

    .sub {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      background: #fff;
    }

    main {
      padding: 12px 16px 20px;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 200px 200px;
      gap: 10px;
      margin-bottom: 12px;
    }

    input, select {
      font: inherit;
      padding: 10px;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      overflow: hidden;
    }

    thead th {
      position: sticky;
      top: 140px;
      background: #fff;
      border-bottom: 1px solid #e6e6e6;
      padding: 10px;
      font-size: 12px;
      text-align: left;
      cursor: pointer;
      white-space: nowrap;
    }

    tbody td {
      border-bottom: 1px solid #f1f1f1;
      padding: 10px;
      font-size: 13px;
    }

    tbody tr:hover {
      background: #fcfcff;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #e6e6e6;
      font-size: 12px;
      background: #fff;
    }

    .status {
      font-size: 13px;
      margin-bottom: 10px;
    }

    .error {
      color: #b00020;
      background: #fff;
      border: 1px solid #ffd1d1;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .controls {
        grid-template-columns: 1fr;
      }
      thead th {
        top: 200px;
      }
    }
  </style>
</head>

<body>

<header>
  <h1>Ludoteca Amarboard</h1>

  <div class="subtitle">
    <strong>Speciale Natale:</strong>
    trova il gioco perfetto da intavolare con gli amici,
    oppure lasciati consigliare dai nostri Volontari direttamente ai tavoli.
  </div>

  <div class="sub">
    <span class="pill"><strong id="countTotal">0</strong> totali</span>
    <span class="pill"><strong id="countShown">0</strong> mostrati</span>
    <span class="pill">Ultimo aggiornamento: <span id="lastUpdated">—</span></span>
  </div>
</header>

<main>
  <div class="controls">
    <input id="q" type="search" placeholder="Cerca un gioco…" autocomplete="off" />
    <select id="statusFilter">
      <option value="">Tutti gli stati</option>
      <option value="Disponibile">Disponibile</option>
      <option value="In prestito">In prestito</option>
      <option value="Non disponibile">Non disponibile</option>
    </select>
    <select id="autoRefresh">
      <option value="0">Auto-refresh OFF</option>
      <option value="10">Auto-refresh 10s</option>
      <option value="15" selected>Auto-refresh 15s</option>
      <option value="30">Auto-refresh 30s</option>
      <option value="60">Auto-refresh 60s</option>
    </select>
  </div>

  <div id="statusLine" class="status">Pronto.</div>
  <div id="errorBox" class="error" style="display:none;"></div>

  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</main>

<script>
  const CSV_PATH = "/catalogo_ludoteca.csv";

  let rows = [];
  let columns = [];
  let sortKey = null;
  let sortDir = 1;
  let refreshTimer = null;

  function formatNow() {
    return new Date().toLocaleString("it-IT", { hour12: false });
  }

  function normalize(v) {
    return (v ?? "").toString().toLowerCase().trim();
  }

  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const split = (line) => {
      const out = [];
      let cur = "", q = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') { q = !q; continue; }
        if (c === "," && !q) { out.push(cur); cur = ""; continue; }
        cur += c;
      }
      out.push(cur);
      return out;
    };

    const header = split(lines[0]);
    const data = lines.slice(1).map(l => {
      const cells = split(l);
      const o = {};
      header.forEach((h, i) => o[h] = cells[i] ?? "");
      return o;
    });

    return { header, data };
  }

  async function loadCSV() {
    const res = await fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: "no-store" });
    if (!res.ok) throw new Error("Errore caricamento CSV");
    const text = await res.text();
    const parsed = parseCSV(text);

    columns = parsed.header;
    rows = parsed.data;

    document.getElementById("countTotal").textContent = rows.length;
    document.getElementById("lastUpdated").textContent = formatNow();
  }

  function render() {
    const q = normalize(document.getElementById("q").value);
    const st = normalize(document.getElementById("statusFilter").value);

    let data = rows.filter(r => {
      if (st && normalize(r["Stato"]) !== st) return false;
      if (!q) return true;
      return columns.some(c => normalize(r[c]).includes(q));
    });

    if (sortKey) {
      data.sort((a, b) =>
        a[sortKey].localeCompare(b[sortKey], "it", { numeric: true }) * sortDir
      );
    }

    document.getElementById("countShown").textContent = data.length;

    const thead = document.getElementById("thead");
    thead.innerHTML = "<tr>" + columns.map(c =>
      `<th>${c}${sortKey === c ? (sortDir > 0 ? " ▲" : " ▼") : ""}</th>`
    ).join("") + "</tr>";

    [...thead.querySelectorAll("th")].forEach((th, i) => {
      th.onclick = () => {
        if (sortKey === columns[i]) sortDir *= -1;
        else { sortKey = columns[i]; sortDir = 1; }
        render();
      };
    });

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
      const tr = document.createElement("tr");
      columns.forEach(c => {
        const td = document.createElement("td");
        td.innerHTML = c === "Stato"
          ? `<span class="badge">${r[c]}</span>`
          : r[c];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function setupAutoRefresh() {
    document.getElementById("autoRefresh").onchange = e => {
      if (refreshTimer) clearInterval(refreshTimer);
      const s = Number(e.target.value);
      if (s > 0) {
        refreshTimer = setInterval(async () => {
          await loadCSV();
          render();
        }, s * 1000);
      }
    };
  }

  (async function boot() {
    try {
      setupAutoRefresh();
      await loadCSV();
      render();
      document.getElementById("autoRefresh").dispatchEvent(new Event("change"));
    } catch (e) {
      document.getElementById("errorBox").style.display = "block";
      document.getElementById("errorBox").textContent = e.message;
    }
  })();
</script>

</body>
</html>
