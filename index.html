<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Catalogo Giochi ‚Äì AmarBoard Natale</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* (stile identico a quello che mi hai dato, abbreviato qui per spazio)
       üëâ INCOLLA IL TUO CSS NATALIZIO QUI INVARIATO
       e aggiungi solo le 2 classi sotto (bottoni + modal) */
    .btn-small{
      padding:6px 10px;border-radius:10px;border:1px solid rgba(176,32,48,0.35);
      background:#fff;cursor:pointer;font-weight:700;
    }
    .btn-small:disabled{opacity:.55;cursor:not-allowed;}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:99999;align-items:center;justify-content:center;padding:16px;}
    .modal{max-width:520px;width:100%;background:#fff;border-radius:16px;border:2px solid rgba(176,32,48,0.25);padding:14px 14px 10px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .modal h3{margin:4px 0 8px;color:#b02030}
    .modal .row{display:flex;gap:10px;flex-wrap:wrap}
    .modal label{font-size:.85rem;color:#444}
    .modal input,.modal textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:10px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .topbar{display:flex;gap:10px;justify-content:flex-end;margin:10px 0 0}
    .topbar button{border-radius:12px}
  </style>
</head>
<body>

<!-- QUI: incolla i tuoi elementi grafici (garland, snowflake, wrapper) come nel tuo html -->

<div id="wrapper">
  <div class="header-flex">
    <img class="logo-amar" src="logo_amarboard.png" alt="AmarBoard Romagna">
  </div>

  <h1>Catalogo Giochi ‚Äì AmarBoard</h1>
  <div class="subtitle">
    <span>Speciale Natale:</span> trova il gioco giusto (o fatti suggerire dai nostri Volontari) da intavolare con gli amici sui nostri tavoli.
  </div>

  <div class="topbar">
    <button id="btnLogin" class="btn-small">üîê Login</button>
    <button id="btnLogout" class="btn-small" style="display:none;">üö™ Logout</button>
    <a id="btnAdmin" class="btn-small" href="admin.html" style="display:none;text-decoration:none;display:inline-flex;align-items:center;">üõ†Ô∏è Admin</a>
  </div>

  <table id="tblCatalogo" class="display" style="width:100%;margin-top:10px">
    <thead>
      <tr>
        <th>Titolo</th>
        <th>Giocatori</th>
        <th>Durata</th>
        <th>Et√†</th>
        <th>Editore</th>
        <th>Disponibili</th>
        <th>Stato</th>
        <th>Richiedi</th>
        <th>BGG</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="footer-note">üéÖ Catalogo AmarBoard ‚Äì versione natalizia</div>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" class="modal-backdrop">
  <div class="modal">
    <h3>Login</h3>
    <div class="row">
      <div style="flex:1;min-width:180px">
        <label>Username</label>
        <input id="loginUser" autocomplete="username">
      </div>
      <div style="flex:1;min-width:180px">
        <label>Password</label>
        <input id="loginPass" type="password" autocomplete="current-password">
      </div>
    </div>
    <div class="actions">
      <button class="btn-small" id="btnLoginCancel">Annulla</button>
      <button class="btn-small" id="btnLoginDo">Entra</button>
    </div>
    <div id="loginErr" style="margin-top:8px;color:#b02030;font-weight:700"></div>
    <div style="margin-top:10px;font-size:.9rem">
      Non hai un account? <a href="register.html">Registrati</a>
    </div>
  </div>
</div>

<!-- MODAL RICHIESTA -->
<div id="modalReq" class="modal-backdrop">
  <div class="modal">
    <h3>Richiedi prestito</h3>
    <div style="margin-bottom:6px;color:#444"><strong id="reqTitolo">‚Äî</strong> <span id="reqBadge"></span></div>
    <div class="row">
      <div style="flex:1;min-width:180px">
        <label>Nome</label>
        <input id="reqNome">
      </div>
      <div style="flex:1;min-width:180px">
        <label>Telefono</label>
        <input id="reqTel">
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Note</label>
      <textarea id="reqNote" rows="3"></textarea>
    </div>
    <div class="actions">
      <button class="btn-small" id="btnReqCancel">Annulla</button>
      <button class="btn-small" id="btnReqSend">Invia richiesta</button>
    </div>
    <div id="reqErr" style="margin-top:8px;color:#b02030;font-weight:700"></div>
  </div>
</div>

<!-- CODE.JS + LOGICA CATALOGO -->
<script>
<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbyoQBfaYvxQBTS_EnK1-IOlPjLoFT0sWn1jcHPuDg5t0nUkwrvKPY-x8Qg8ii5BmtLDYg/exec";

/* ===== STORAGE KEYS ===== */
const LS_TOKEN = "AB_TOKEN";
const LS_PROFILE = "AB_PROFILE";

/* ===== JSONP ===== */
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const sep = url.includes("?") ? "&" : "?";
    s.src = url + sep + "callback=" + cb + "&_=" + Date.now();
    s.async = true;

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      cleanup();
      reject(new Error("JSONP load error"));
    };

    function cleanup(){
      try { delete window[cb]; } catch(e){ window[cb] = undefined; }
      if (s.parentNode) s.parentNode.removeChild(s);
    }

    document.body.appendChild(s);
  });
}

function api(action, params={}) {
  const qs = new URLSearchParams({ action, ...params }).toString();
  return jsonp(`${API_URL}?${qs}`);
}

/* ===== AUTH HELPERS ===== */
function getToken(){ return localStorage.getItem(LS_TOKEN) || ""; }
function setSession(token, profile){
  localStorage.setItem(LS_TOKEN, token);
  localStorage.setItem(LS_PROFILE, JSON.stringify(profile||{}));
}
function clearSession(){
  localStorage.removeItem(LS_TOKEN);
  localStorage.removeItem(LS_PROFILE);
}
function getProfile(){
  try { return JSON.parse(localStorage.getItem(LS_PROFILE)||"{}"); } catch(e){ return {}; }
}

/* ===== SHA-256 (browser) ===== */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ===== UI helpers ===== */
const E = (id)=>document.getElementById(id);
function show(el){ el.style.display=""; }
function hide(el){ el.style.display="none"; }

function badgeHtml(stato){
  const s = (stato||"").toLowerCase();
  if (s==="inviata") return `<span class="badge badge-prestato">üìå Richiesto</span>`;
  if (s==="approvata") return `<span class="badge badge-disponibile">‚úÖ Prenotato</span>`;
  return "";
}

/* ===== RESERVATION STATUS CACHE ===== */
let reservationMap = {}; // titoloLower -> Stato

async function refreshReservationMap(titles){
  if (!titles.length) return;
  const joined = titles.join("|");
  const r = await api("reservations_status", { titoli: joined });
  if (r && r.ok) reservationMap = r.map || {};
}

/* ===== INDEX: apply badges + disable buttons ===== */
function applyBadgesAndButtons(){
  // Cerca elementi con data-title (li metti sul bottone ‚ÄúRichiedi‚Äù)
  const btns = document.querySelectorAll("[data-action='richiedi']");
  btns.forEach(btn=>{
    const titolo = (btn.getAttribute("data-title")||"").trim();
    const key = titolo.toLowerCase();
    const stato = reservationMap[key] || "";

    // badge container vicino al bottone
    const badgeBoxId = btn.getAttribute("data-badge-id");
    const badgeBox = badgeBoxId ? document.getElementById(badgeBoxId) : null;
    if (badgeBox) badgeBox.innerHTML = badgeHtml(stato);

    const blocked = (stato === "Inviata" || stato === "Approvata");
    btn.disabled = blocked;
    btn.style.opacity = blocked ? "0.55" : "1";
    btn.style.cursor = blocked ? "not-allowed" : "pointer";
  });
}

/* ===== LOGIN / LOGOUT ===== */
async function doLogin(username, password){
  const passhash = await sha256Hex(password);
  const r = await api("login", { username, passhash });
  if (!r.ok) throw new Error(r.error || "Login fallito");
  setSession(r.token, r.profile);
  return r.profile;
}

async function doLogout(){
  const token = getToken();
  if (token) {
    try { await api("logout", { token }); } catch(e){}
  }
  clearSession();
}

/* ===== ME ===== */
async function loadMe(){
  const token = getToken();
  if (!token) return { ok:false };
  const r = await api("me", { token });
  if (!r.ok) { clearSession(); return { ok:false, error:r.error }; }
  localStorage.setItem(LS_PROFILE, JSON.stringify(r.profile||{}));
  return r;
}

/* ===== SUBMIT REQUEST ===== */
async function submitRequest({titolo, giocatori, nome, telefono, note}){
  const token = getToken();
  const r = await api("submit_request", { token, titolo, giocatori, nome, telefono, note });
  if (!r.ok) throw new Error(r.error || "Errore invio");
  return r;
}

/* ===== AUTO REFRESH (index) ===== */
let AUTO_TIMER = null;
function startAutoRefresh(getTitlesFn, intervalMs=8000){
  if (AUTO_TIMER) clearInterval(AUTO_TIMER);
  AUTO_TIMER = setInterval(async ()=>{
    try{
      const titles = getTitlesFn();
      await refreshReservationMap(titles);
      applyBadgesAndButtons();
    }catch(e){
      // silenzioso: non rompere UX
    }
  }, intervalMs);
}
</script>

</script>

<script>
const CSV_BASE_URL = "/catalogo_ludoteca.csv";

let table = null;
let lastTitles = [];

function statoBadge(stato){
  stato = (stato||"").toLowerCase().trim();
  if (stato==="disponibile") return '<span class="badge badge-disponibile">üéÑ Disponibile</span>';
  if (stato==="in prestito") return '<span class="badge badge-prestato">üéÅ In prestito</span>';
  return stato||"";
}

async function fetchTextNoStore(path){
  const url = path + "?v=" + Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP "+res.status);
  return await res.text();
}
function parseCSVText(csvText){
  const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
  return parsed.data || [];
}

function titlesFromTableData(){
  return lastTitles.slice();
}

function open(el){ el.style.display="flex"; }
function close(el){ el.style.display="none"; }

async function initSessionUI(){
  const me = await loadMe();
  const tokenOk = me && me.ok;
  if (tokenOk){
    hide(E("btnLogin"));
    show(E("btnLogout"));
    const isAdmin = (me.profile && me.profile.Ruolo === "admin");
    E("btnAdmin").style.display = isAdmin ? "inline-flex" : "none";
  } else {
    show(E("btnLogin"));
    hide(E("btnLogout"));
    E("btnAdmin").style.display = "none";
  }
}

async function caricaCatalogo(){
  const text = await fetchTextNoStore(CSV_BASE_URL);
  const raw = parseCSVText(text);

  const data = [];
  lastTitles = [];

  raw.forEach((row, idx)=>{
    if (!row["Titolo"]) return;
    const titolo = String(row["Titolo"]||"");
    const gioc = String(row["NumeroGiocatori"]||"");
    lastTitles.push(titolo);

    const badgeId = "badge_" + idx;

    data.push({
      Titolo: titolo,
      Giocatori: gioc,
      Durata: String(row["Durata"]||""),
      Eta: String(row["Eta"]||""),
      Editore: String(row["Editore"]||""),
      Disponibili: String(row["CopieDisponibili"]||""),
      Stato: String(row["StatoDisponibilita"]||""),
      Richiedi: { titolo, giocatori: gioc, badgeId },
      BGG: String(row["BGG"]||"")
    });
  });

  if (!table){
    table = $("#tblCatalogo").DataTable({
      data,
      columns: [
        { data:"Titolo" },
        { data:"Giocatori" },
        { data:"Durata" },
        { data:"Eta" },
        { data:"Editore" },
        { data:"Disponibili", render:d=>`<strong>${d??""}</strong>` },
        { data:"Stato", render:d=>statoBadge(d) },
        { data:"Richiedi", orderable:false, render: (d, type, row, meta) => {
            const titolo = d.titolo.replace(/"/g,"&quot;");
            const gioc = (d.giocatori||"").replace(/"/g,"&quot;");
            return `
              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
                <button class="btn-small"
                        data-action="richiedi"
                        data-title="${titolo}"
                        data-gioc="${gioc}"
                        data-badge-id="${d.badgeId}">
                  ‚ûï Richiedi
                </button>
                <div id="${d.badgeId}"></div>
              </div>`;
          }
        },
        { data:"BGG", orderable:false, render:d=>{
            if(!d) return "";
            const safe = String(d).trim();
            if(!/^https?:\/\//i.test(safe)) return "";
            return `<a class="bgg-link" href="${safe}" target="_blank" rel="noopener noreferrer">Scheda</a>`;
          }
        }
      ],
      paging:false,
      info:false,
      lengthChange:false,
      order:[[0,"asc"]],
      language:{ url:"https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json" }
    });

    // click su richiedi
    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action='richiedi']");
      if(!btn) return;
      if (btn.disabled) return;

      const titolo = btn.getAttribute("data-title") || "";
      const gioc = btn.getAttribute("data-gioc") || "";
      const key = titolo.toLowerCase();
      const stato = reservationMap[key] || "";
      E("reqTitolo").textContent = titolo;
      E("reqBadge").innerHTML = badgeHtml(stato);
      E("reqErr").textContent = "";
      open(E("modalReq"));

      E("btnReqSend").onclick = async ()=>{
        try{
          E("reqErr").textContent = "";
          await submitRequest({
            titolo,
            giocatori: gioc,
            nome: E("reqNome").value.trim(),
            telefono: E("reqTel").value.trim(),
            note: E("reqNote").value.trim()
          });
          close(E("modalReq"));

          // refresh immediato badge
          await refreshReservationMap(titlesFromTableData());
          applyBadgesAndButtons();
        }catch(e){
          E("reqErr").textContent = e.message || "Errore invio";
        }
      };
    });

    E("btnReqCancel").onclick = ()=> close(E("modalReq"));
    E("modalReq").onclick = (ev)=>{ if(ev.target===E("modalReq")) close(E("modalReq")); };
  } else {
    table.clear();
    table.rows.add(data).draw(false);
  }

  // primo refresh stati + applica badge
  await refreshReservationMap(titlesFromTableData());
  applyBadgesAndButtons();
}

document.addEventListener("DOMContentLoaded", async ()=>{
  // Login modal
  E("btnLogin").onclick = ()=>{ E("loginErr").textContent=""; open(E("modalLogin")); };
  E("btnLoginCancel").onclick = ()=> close(E("modalLogin"));
  E("modalLogin").onclick = (ev)=>{ if(ev.target===E("modalLogin")) close(E("modalLogin")); };
  E("btnLoginDo").onclick = async ()=>{
    try{
      E("loginErr").textContent="";
      const u = E("loginUser").value.trim().toLowerCase();
      const p = E("loginPass").value;
      await doLogin(u,p);
      close(E("modalLogin"));
      await initSessionUI();
    }catch(e){
      E("loginErr").textContent = e.message || "Login fallito";
    }
  };

  E("btnLogout").onclick = async ()=>{
    await doLogout();
    await initSessionUI();
    await refreshReservationMap(titlesFromTableData());
    applyBadgesAndButtons();
  };

  await initSessionUI();
  await caricaCatalogo();

  // AUTO REFRESH per badge istantanei
  startAutoRefresh(titlesFromTableData, 8000);

  // refresh catalogo ogni 30s (opzionale, se i CSV cambiano)
  setInterval(async ()=>{
    try{ await caricaCatalogo(); }catch(e){}
  }, 30000);
});
</script>

</body>
</html>
