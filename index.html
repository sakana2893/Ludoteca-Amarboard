<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Catalogo Giochi â€“ AmarBoard Natale</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <!-- jQuery (PRIMA) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- DataTables JS (DOPO jQuery) -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --rosso-natale: #b02030;
      --verde-natale: #1f7a3a;
      --oro-soft:    #f3d08a;
      --bg-chiaro:   #fffaf3;
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    .snowflake {
      position: fixed;
      top: -10px;
      color: #ffffff;
      font-size: 1.2rem;
      pointer-events: none;
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      opacity: 0.85;
      z-index: 1;
      text-shadow: 0 0 3px rgba(0,0,0,0.3);
    }
    .snowflake:nth-child(1)  { left: 5%;  animation-duration: 12s; animation-delay: 0s; }
    .snowflake:nth-child(2)  { left: 18%; animation-duration: 15s; animation-delay: 2s; }
    .snowflake:nth-child(3)  { left: 32%; animation-duration: 11s; animation-delay: 4s; }
    .snowflake:nth-child(4)  { left: 46%; animation-duration: 13s; animation-delay: 1s; }
    .snowflake:nth-child(5)  { left: 60%; animation-duration: 16s; animation-delay: 3s; }
    .snowflake:nth-child(6)  { left: 74%; animation-duration: 10s; animation-delay: 5s; }
    .snowflake:nth-child(7)  { left: 88%; animation-duration: 14s; animation-delay: 1s; }

    @keyframes fall {
      0%   { transform: translateY(0); opacity: 0.95; }
      100% { transform: translateY(110vh); opacity: 0; }
    }

    .garland {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: radial-gradient(circle at center, rgba(31,122,58,0.7), rgba(0,0,0,0.3));
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #ffe;
      font-size: 1.4rem;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .garland span { animation: blink 2.2s linear infinite; }
    .garland span:nth-child(odd) { animation-delay: 0.7s; }

    @keyframes blink {
      0%, 100% { opacity: 0.4; transform: translateY(0); }
      50%      { opacity: 1;   transform: translateY(1px); }
    }

    #wrapper {
      max-width: 1200px;
      margin: 90px auto 40px;
      padding: 24px 26px 30px;
      background: rgba(255,250,243,0.96);
      border-radius: 20px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8),
                  0 0 18px rgba(176,32,48,0.4);
      position: relative;
      z-index: 3;
      border: 2px solid rgba(176,32,48,0.35);
    }
    #wrapper::before {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 16px;
      border: 2px dashed rgba(243,208,138,0.7);
      pointer-events: none;
    }

    .header-flex {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin-bottom: 6px;
    }
    .xmas-icon { font-size: 2rem; }

    .logo-amar {
      height: 80px;
      width: auto;
      border-radius: 999px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      background: #fff;
    }

    h1 {
      text-align: center;
      margin: 6px 0;
      font-size: 1.8rem;
      color: var(--rosso-natale);
      text-shadow: 0 1px 0 #fff, 0 0 6px rgba(176,32,48,0.35);
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 12px;
    }
    .subtitle span { color: var(--verde-natale); font-weight: 600; }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
    }

    .topbar-left{
      display:flex;
      align-items:center;
      flex-wrap: wrap;
      gap: 8px;
      color:#333;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .btn {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: #333;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      white-space: nowrap;
    }
    .btn:hover { filter: brightness(0.98); }
    .btn-green { border-color: rgba(31,122,58,0.35); background:#e9fff0; color: var(--verde-natale); }
    .btn-red { border-color: rgba(176,32,48,0.35); background:#fff0f0; color: var(--rosso-natale); }
    .btn-gray { border-color: rgba(0,0,0,0.12); background:#f6f6f6; color:#444; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: linear-gradient(135deg,#fff,#fffdf7);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(176,32,48,0.2);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 0.85rem;
    }
    .stat-label {
      text-transform: uppercase;
      color: #666;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--rosso-natale);
    }
    .stat-note {
      font-size: 0.75rem;
      color: #777;
      margin-top: 3px;
    }
    .stat-top ol {
      margin: 0;
      padding-left: 18px;
      font-size: 0.8rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
    }

    .filters-left {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }

    .filter-block { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { color: #444; font-size: 0.8rem; }

    select, input[type="text"], input[type="password"], textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      min-width: 140px;
      background: #fff;
    }
    textarea { min-width: 220px; resize: vertical; }

    #tblCatalogo_wrapper { margin-top: 6px; }

    table.dataTable thead th {
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom: 2px solid var(--rosso-natale);
    }
    table.dataTable tbody tr:nth-child(even) { background-color: #fffaf5; }
    table.dataTable tbody tr.disponibile-row { background: linear-gradient(90deg, #f7fff7, #ffffff); }
    table.dataTable tbody tr.prestato-row { background: linear-gradient(90deg, #fff7f7, #ffffff); }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 800;
      display: inline-block;
      white-space: nowrap;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .badge-disponibile { background:#d4edda; color:#155724; border-color:#b1dfbb; }
    .badge-prestato    { background:#f8d7da; color:#721c24; border-color:#f1b0b7; }
    .badge-rich        { background:#fff3cd; color:#856404; border-color:#ffeeba; }
    .badge-pren        { background:#cce5ff; color:#004085; border-color:#b8daff; }

    a.bgg-link {
      color: var(--rosso-natale);
      font-size: 0.85rem;
      text-decoration: none;
      font-weight: 800;
    }
    a.bgg-link:hover { text-decoration: underline; }

    .footer-note {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #777;
      text-align: right;
    }

    /* Error box */
    #errorBox {
      display: none;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(176,32,48,0.35);
      background: rgba(255, 231, 231, 0.85);
      color: #7a0f1a;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    /* COUNTDOWN */
    #countdownBanner{
      position: fixed;
      inset: 70px 16px auto 16px;
      max-width: 1200px;
      margin: 0 auto;
      z-index: 9999;
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.35);
      box-shadow: 0 0 18px rgba(176,32,48,0.25);
      border-radius: 16px;
      padding: 14px 16px;
      text-align: center;
      color: #7a0f1a;
      font-weight: 800;
    }
    #countdownBanner small{
      display:block;
      margin-top:6px;
      font-weight: 700;
      color:#444;
    }
    #countdownTime{
      font-variant-numeric: tabular-nums;
      font-size: 1.4rem;
      color: #b02030;
    }
    .spoiler-hidden #wrapper{
      filter: blur(10px);
      pointer-events: none;
      user-select: none;
    }
    .spoiler-hidden #wrapper::after{
      content:"Catalogo in arrivoâ€¦";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.4rem;
      font-weight: 900;
      color: rgba(122,15,26,0.85);
    }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 14px;
    }
    .modal{
      width: min(560px, 100%);
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      padding: 14px 14px 12px;
      position: relative;
    }
    .modal h3{
      margin: 6px 8px 10px;
      color: var(--rosso-natale);
      text-shadow: 0 1px 0 #fff;
    }
    .modal .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px;
    }
    .modal .row > div{ flex: 1 1 180px; }
    .modal .actions{
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      padding: 8px;
    }
    .smallmuted{ font-size: 0.8rem; color:#555; padding: 0 8px 10px; }

    @media(max-width: 900px) {
      .stats-bar { grid-template-columns: 1fr; }
    }
    @media(max-width: 768px) {
      #wrapper { margin: 80px 10px 20px; padding: 14px; }
      .filters { flex-direction: column; align-items: stretch; }
      .header-flex { flex-direction: column; }
      .logo-amar { height: 70px; }
      .topbar { flex-direction: column; align-items: stretch; }
      .topbar-left { justify-content: center; }
    }
  </style>
</head>

<body>
  <div id="countdownBanner" style="display:none;">
    ğŸ La pagina della nostra Ludoteca si sbloccherÃ  tra <span id="countdownTime">--:--:--</span>
    <small>Stiamo â€œintavolandoâ€ la paginaâ€¦</small>
  </div>

  <div class="garland">
    <span>âœ¨</span><span>ğŸ„</span><span>â­</span><span>ğŸ•¯ï¸</span>
    <span>ğŸ² AmarBoard Romagna ğŸ²</span>
    <span>â­</span><span>ğŸ„</span><span>âœ¨</span>
  </div>

  <!-- Fiocchi di neve -->
  <div class="snowflake">â„</div>
  <div class="snowflake">âœ»</div>
  <div class="snowflake">â…</div>
  <div class="snowflake">â†</div>
  <div class="snowflake">â„</div>
  <div class="snowflake">âœµ</div>
  <div class="snowflake">â„</div>

  <div id="wrapper">
    <div class="header-flex">
      <span class="xmas-icon">ğŸ„</span>
      <img class="logo-amar" src="logo_amarboard.png" alt="AmarBoard Romagna">
      <span class="xmas-icon">ğŸ²</span>
    </div>

    <h1>Catalogo Giochi â€“ AmarBoard</h1>

    <div class="subtitle">
      <span>Speciale Natale:</span> trova il gioco giusto (o fatti suggerire dai nostri Volontari) da intavolare con gli amici sui nostri tavoli.
    </div>

    <div class="topbar">
      <div class="topbar-left">
        <span id="whoami">ğŸ‘¤ Ospite</span>
        <span id="onlyRegHint" style="display:none;">â€¢ ğŸ”’ Solo utenti registrati</span>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-gray" id="btnLogin">ğŸ”‘ Login</button>
        <button class="btn btn-gray" id="btnRegister" onclick="location.href='register.html'">ğŸ“ Registrati</button>
        <button class="btn btn-red"  id="btnLogout" style="display:none;">ğŸšª Logout</button>

        <button class="btn btn-green" id="btnPreview" style="display:none;">ğŸ‘ï¸ Preview</button>
        <button class="btn btn-red"  id="btnAdmin" style="display:none;">ğŸ› ï¸ Admin</button>
      </div>
    </div>

    <!-- STATS -->
    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-label">Giochi attualmente in prestito</div>
        <div class="stat-value" id="cntAttivi">â€“</div>
        <div class="stat-note">Numero di prestiti attivi in questo momento.</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Prestiti totali effettuati</div>
        <div class="stat-value" id="cntTotali">â€“</div>
        <div class="stat-note">Conteggio cumulativo dei prestiti registrati.</div>
      </div>
      <div class="stat-box stat-top">
        <div class="stat-label">Top 3 giochi piÃ¹ prestati ora</div>
        <ol id="topList"></ol>
      </div>
    </div>

    <!-- FILTRI -->
    <div class="filters">
      <div class="filters-left">
        <div class="filter-block">
          <span class="filter-label">Stato</span>
          <select id="filtroStato">
            <option value="">Tutti</option>
            <option value="Disponibile">Disponibile</option>
            <option value="In prestito">In prestito</option>
          </select>
        </div>

        <div class="filter-block">
          <span class="filter-label">Giocatori (numero compreso)</span>
          <input type="text" id="filtroGiocatori" placeholder="es. 3">
        </div>
      </div>

      <button class="btn btn-green" id="btnRefresh" type="button">ğŸ”„ Aggiorna dati</button>
    </div>

    <div id="errorBox"></div>

    <table id="tblCatalogo" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Titolo</th>
          <th>Giocatori</th>
          <th>Durata</th>
          <th>EtÃ </th>
          <th>Editore</th>
          <th>Disponibili</th>
          <th>Stato</th>
          <th>BGG</th>
          <th>Richiedi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer-note">
      ğŸ… Catalogo generato dalla ludoteca AmarBoard â€“ versione natalizia
    </div>
  </div>

  <!-- MODAL LOGIN -->
  <div class="modal-backdrop" id="loginModal">
    <div class="modal">
      <h3>ğŸ”‘ Login</h3>
      <div class="smallmuted">Se sei admin, dopo login comparirÃ  il tasto â€œAdminâ€.</div>
      <div class="row">
        <div>
          <div class="filter-label">Username</div>
          <input id="loginUser" type="text" placeholder="es. sacha">
        </div>
        <div>
          <div class="filter-label">Password</div>
          <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-gray" id="btnLoginCancel">Annulla</button>
        <button class="btn btn-green" id="btnLoginGo">Entra</button>
      </div>
    </div>
  </div>

  <!-- MODAL RICHIESTA -->
  <div class="modal-backdrop" id="reqModal">
    <div class="modal">
      <h3>ğŸ Richiedi prestito</h3>
      <div class="smallmuted">
        Titolo: <b id="reqTitle">â€“</b>
        <span id="reqHints" style="display:block; margin-top:6px;"></span>
      </div>

      <div class="row">
        <div>
          <div class="filter-label">Nome</div>
          <input id="reqNome" type="text" placeholder="Nome e cognome">
        </div>
        <div>
          <div class="filter-label">Telefono</div>
          <input id="reqTel" type="text" placeholder="393...">
        </div>
      </div>

      <div class="row">
        <div style="flex:1 1 100%;">
          <div class="filter-label">Note (opzionali)</div>
          <textarea id="reqNote" rows="2" placeholder="Es. passo alle 17:00"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-gray" id="btnReqCancel">Annulla</button>
        <button class="btn btn-green" id="btnReqSend">Invia richiesta</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyoQBfaYvxQBTS_EnK1-IOlPjLoFT0sWn1jcHPuDg5t0nUkwrvKPY-x8Qg8ii5BmtLDYg/exec";

// CSV
const CSV_BASE_URL   = "/catalogo_ludoteca.csv";
const STATS_BASE_URL = "/stats_ludoteca.csv";

// COUNTDOWN: imposta data/ora sblocco.
// Per DISATTIVARE countdown: metti REVEAL_AT = 0
// Esempio: "2025-12-12T09:00:00+01:00"
const REVEAL_AT = 0; // <--- metti la tua data/ora, oppure 0 per niente countdown

// Preview bypass (quando admin clicca "Preview"), durata in minuti
const PREVIEW_MINUTES = 180;

/* =========================
   STATE
========================= */
let table = null;
let onlyRegistered = false;

// titoloLower -> "requested" | "reserved"
let bookingStateByTitle = new Map();

// valore corrente del filtro giocatori
let playerFilterValue = "";

let countdownTimer = null;

const LS = {
  TOKEN: "AB_TOKEN",
  PROFILE: "AB_PROFILE",
  PREVIEW_UNTIL: "AB_PREVIEW_UNTIL"
};

function E(id){ return document.getElementById(id); }
function showError(msg){
  const box = E("errorBox");
  box.style.display = "block";
  box.textContent = msg;
}
function clearError(){
  const box = E("errorBox");
  box.style.display = "none";
  box.textContent = "";
}

/* =========================
   JSONP helper (no CORS)
========================= */
function jsonp(url, params={}, timeoutMs=12000){
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    const qs = new URLSearchParams({ ...params, callback: cbName }).toString();
    const full = url + (url.includes("?") ? "&" : "?") + qs;

    const script = document.createElement("script");
    let done = false;

    window[cbName] = (data) => {
      done = true;
      cleanup();
      resolve(data);
    };

    const t = setTimeout(() => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    }

    script.onerror = () => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error("JSONP load error"));
    };

    script.src = full;
    document.body.appendChild(script);
  });
}

/* =========================
   SHA-256 (crypto.subtle or fallback)
========================= */
async function sha256hex(text){
  if (window.crypto && crypto.subtle && window.isSecureContext) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  }
  return sha256_fallback_(text);
}

/* Minimal SHA256 fallback */
function sha256_fallback_(ascii) {
  function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }

  var mathPow = Math.pow; var maxWord = mathPow(2, 32);
  var lengthProperty = 'length';
  var i, j; var result = '';

  var words = [];
  var asciiBitLength = ascii[lengthProperty]*8;

  var hash = sha256_fallback_.h = sha256_fallback_.h || [];
  var k = sha256_fallback_.k = sha256_fallback_.k || [];
  var primeCounter = k[lengthProperty];

  var isComposite = {};
  for (var candidate = 2; primeCounter < 64; candidate++) {
    if (!isComposite[candidate]) {
      for (i = 0; i < 313; i += candidate) isComposite[i] = candidate;
      hash[primeCounter] = (mathPow(candidate, .5)*maxWord)|0;
      k[primeCounter++] = (mathPow(candidate, 1/3)*maxWord)|0;
    }
  }

  ascii += '\x80';
  while (ascii[lengthProperty]%64 - 56) ascii += '\x00';
  for (i = 0; i < ascii[lengthProperty]; i++) {
    j = ascii.charCodeAt(i);
    words[i>>2] |= j << ((3 - i)%4)*8;
  }
  words[words[lengthProperty]] = ((asciiBitLength/maxWord)|0);
  words[words[lengthProperty]] = (asciiBitLength);

  for (j = 0; j < words[lengthProperty];) {
    var w = words.slice(j, j += 16);
    var oldHash = hash.slice(0);

    for (i = 0; i < 64; i++) {
      var w15 = w[i - 15], w2 = w[i - 2];

      var a = hash[0], e = hash[4];
      var temp1 = hash[7]
        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
        + ((e&hash[5])^((~e)&hash[6]))
        + k[i]
        + (w[i] = (i < 16) ? w[i] : (
            w[i - 16]
            + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3))
            + w[i - 7]
            + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
          )|0
        );

      var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
        + ((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));

      hash = [(temp1+temp2)|0].concat(hash);
      hash[4] = (hash[4]+temp1)|0;
      hash.pop();
    }

    for (i = 0; i < 8; i++) hash[i] = (hash[i]+oldHash[i])|0;
  }

  for (i = 0; i < 8; i++) {
    for (j = 3; j + 1; j--) {
      var b = (hash[i]>>(j*8))&255;
      result += ((b < 16) ? 0 : '') + b.toString(16);
    }
  }
  return result;
}

/* =========================
   AUTH UI
========================= */
function getToken(){ return localStorage.getItem(LS.TOKEN) || ""; }
function setSession(token, profile){
  localStorage.setItem(LS.TOKEN, token);
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile || {}));
}
function clearSession(){
  localStorage.removeItem(LS.TOKEN);
  localStorage.removeItem(LS.PROFILE);
}
function getProfile(){
  try { return JSON.parse(localStorage.getItem(LS.PROFILE) || "{}"); } catch { return {}; }
}
function isAdmin(){
  const p = getProfile();
  return String(p.Ruolo||"").toLowerCase() === "admin";
}

function setWhoami(){
  const tok = getToken();
  const p = getProfile();

  if (tok && p && p.Username){
    E("whoami").textContent = `ğŸ‘¤ ${p.Username}${isAdmin() ? " (admin)" : ""}`;
    E("btnLogin").style.display = "none";
    E("btnRegister").style.display = "none";
    E("btnLogout").style.display = "inline-flex";
    E("btnAdmin").style.display = isAdmin() ? "inline-flex" : "none";
    E("btnPreview").style.display = isAdmin() ? "inline-flex" : "none";
  } else {
    E("whoami").textContent = "ğŸ‘¤ Ospite";
    E("btnLogin").style.display = "inline-flex";
    E("btnRegister").style.display = "inline-flex";
    E("btnLogout").style.display = "none";
    E("btnAdmin").style.display = "none";
    E("btnPreview").style.display = "none";
  }
}

function openModal(id){ E(id).style.display = "flex"; }
function closeModal(id){ E(id).style.display = "none"; }

/* =========================
   COUNTDOWN / PREVIEW
========================= */
function hasPreviewBypass(){
  const until = Number(localStorage.getItem(LS.PREVIEW_UNTIL) || "0");
  return until && Date.now() < until;
}
function enablePreviewBypass(){
  const until = Date.now() + PREVIEW_MINUTES*60*1000;
  localStorage.setItem(LS.PREVIEW_UNTIL, String(until));
}
function clearPreviewBypass(){
  localStorage.removeItem(LS.PREVIEW_UNTIL);
}

function startCountdownShield(){
  const banner = E("countdownBanner");
  const timeEl = E("countdownTime");

  if (!REVEAL_AT || REVEAL_AT === 0){
    document.body.classList.remove("spoiler-hidden");
    banner.style.display = "none";
    return;
  }

  function tick(){
    const now = Date.now();

    // bypass per admin preview
    if (hasPreviewBypass()){
      document.body.classList.remove("spoiler-hidden");
      banner.style.display = "none";
      return;
    }

    const diff = new Date(REVEAL_AT).getTime() - now;
    if (diff <= 0){
      document.body.classList.remove("spoiler-hidden");
      banner.style.display = "none";
      if (countdownTimer) clearInterval(countdownTimer);
      return;
    }

    document.body.classList.add("spoiler-hidden");
    banner.style.display = "block";

    const totalSec = Math.floor(diff/1000);
    const h = String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s = String(totalSec%60).padStart(2,"0");
    timeEl.textContent = `${h}:${m}:${s}`;
  }

  tick();
  countdownTimer = setInterval(tick, 1000);
}

/* =========================
   CSV load (no-store)
========================= */
async function fetchTextNoStore(path){
  const url = path + "?v=" + Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`Impossibile caricare ${path} (HTTP ${res.status})`);
  return await res.text();
}
function parseCSVText(csvText){
  const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
  return parsed.data || [];
}

/* =========================
   Badges
========================= */
function statoBadge(stato){
  const s = String(stato||"").toLowerCase().trim();
  if (s === "disponibile") return '<span class="badge badge-disponibile">ğŸ„ Disponibile</span>';
  if (s === "in prestito") return '<span class="badge badge-prestato">ğŸ In prestito</span>';
  return (stato || "");
}

function bookingBadgeForTitle(titolo){
  const key = String(titolo||"").trim().toLowerCase();
  const st = bookingStateByTitle.get(key) || "";
  if (st === "requested") return '<span class="badge badge-rich">â³ Richiesto</span>';
  if (st === "reserved")  return '<span class="badge badge-pren">âœ… Prenotato</span>';
  return "";
}

/* =========================
   API: me + settings
========================= */
async function refreshMeAndSettings(){
  const tok = getToken();
  if (!tok){
    onlyRegistered = false;
    E("onlyRegHint").style.display = "none";
    setWhoami();
    return;
  }

  try {
    const r = await jsonp(API_URL, { action:"me", token: tok });
    if (!r.ok){
      clearSession();
      onlyRegistered = false;
      E("onlyRegHint").style.display = "none";
      setWhoami();
      return;
    }
    localStorage.setItem(LS.PROFILE, JSON.stringify(r.profile || {}));
    onlyRegistered = !!r.onlyRegistered;
    E("onlyRegHint").style.display = onlyRegistered ? "inline" : "none";
    setWhoami();
  } catch (e){
    setWhoami();
  }
}

/* =========================
   PRENOTAZIONI: status per titolo (NUOVO)
========================= */
async function refreshTitleStatus(){
  try{
    const r = await jsonp(API_URL, { action:"title_status" });
    if (!r.ok) return;

    bookingStateByTitle = new Map();
    const m = r.map || {};
    Object.keys(m).forEach(k => {
      const st = String(m[k]||"").trim();
      if (st === "requested" || st === "reserved"){
        bookingStateByTitle.set(String(k).trim().toLowerCase(), st);
      }
    });

    if (table) table.rows().invalidate().draw(false);
  } catch {}
}

/* =========================
   Carica stats + catalogo
========================= */
async function caricaStats(){
  try{
    const text = await fetchTextNoStore(STATS_BASE_URL);
    const rows = parseCSVText(text);
    if (!rows.length) return;

    const s = rows[0];
    E("cntAttivi").textContent = s["PrestitiAttivi"] || "0";
    E("cntTotali").textContent = s["PrestitiTotali"] || "0";

    const topList = E("topList");
    topList.innerHTML = "";

    function addTop(titoloKey, countKey){
      const titolo = s[titoloKey];
      const cnt = s[countKey];
      if (titolo && cnt && Number(cnt) > 0){
        const li = document.createElement("li");
        li.textContent = `${titolo} (${cnt})`;
        topList.appendChild(li);
      }
    }
    addTop("Top1Titolo", "Top1Prestiti");
    addTop("Top2Titolo", "Top2Prestiti");
    addTop("Top3Titolo", "Top3Prestiti");
  } catch {
    // stats opzionali
  }
}

async function caricaCatalogo(){
  const text = await fetchTextNoStore(CSV_BASE_URL);
  const raw = parseCSVText(text);

  const data = [];
  raw.forEach(row => {
    if (!row["Titolo"]) return;
    data.push({
      Titolo: row["Titolo"] || "",
      Giocatori: row["NumeroGiocatori"] || "",
      Durata: row["Durata"] || "",
      Eta: row["Eta"] || "",
      Editore: row["Editore"] || "",
      Disponibili: row["CopieDisponibili"] || "",
      Stato: row["StatoDisponibilita"] || "",
      BGG: row["BGG"] || ""
    });
  });

  if (!table){
    table = $("#tblCatalogo").DataTable({
      data,
      deferRender: true,
      pageLength: 50,
      lengthMenu: [25, 50, 100, 200],
      columns: [
        { data:"Titolo" },
        { data:"Giocatori" },
        { data:"Durata" },
        { data:"Eta" },
        { data:"Editore" },
        { data:"Disponibili", render: d => `<strong>${d ?? ""}</strong>` },
        { data:"Stato", render: d => statoBadge(d) },
        {
          data:"BGG",
          orderable:false,
          render: d => {
            const s = String(d||"").trim();
            if (!s) return "";
            if (!/^https?:\/\//i.test(s)) return "";
            return `<a class="bgg-link" href="${s}" target="_blank" rel="noopener noreferrer">Scheda</a>`;
          }
        },
        {
          data:null,
          orderable:false,
          searchable:false,
          render: (row) => {
            const titolo = row.Titolo || "";
            const key = String(titolo).trim().toLowerCase();
            const badge = bookingBadgeForTitle(titolo);

            // se countdown attivo e non bypass -> blocca
            const spoilerBlocked = (REVEAL_AT && REVEAL_AT !== 0 && !hasPreviewBypass() && Date.now() < new Date(REVEAL_AT).getTime());
            if (spoilerBlocked){
              return `<span style="opacity:.7;">â€”</span>`;
            }

            const st = bookingStateByTitle.get(key) || "";
            const can = !st; // se requested/reserved -> no
            const disabled = can ? "" : "disabled";
            const label = can ? "Richiedi" : "Non disponibile";
            const btn = `<button class="btn btn-green" style="padding:6px 9px;border-radius:999px;" data-action="req" data-title="${escapeHtml_(titolo)}" ${disabled}>ğŸ ${label}</button>`;
            return `${badge} ${btn}`;
          }
        }
      ],
      order: [[0,"asc"]],
      language: { url:"https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json" },
      createdRow: function(row, rowData){
        row.setAttribute("data-title", rowData.Titolo || "");
        row.classList.remove("disponibile-row","prestato-row");
        const s = String(rowData.Stato||"").toLowerCase().trim();
        if (s === "disponibile") row.classList.add("disponibile-row");
        else if (s === "in prestito") row.classList.add("prestato-row");
      }
    });

    // Filtri
    E("filtroStato").addEventListener("change", function(){
      table.column(6).search(this.value, false, false).draw();
    });

    // ğŸ”¢ Filtro giocatori: numero compreso nell'intervallo (2-4 ecc.)
    E("filtroGiocatori").addEventListener("keyup", function(){
      playerFilterValue = this.value.trim();
      table.draw();
    });
    E("filtroGiocatori").addEventListener("change", function(){
      playerFilterValue = this.value.trim();
      table.draw();
    });

    // Click su Richiedi
    $("#tblCatalogo tbody").on("click", "button[data-action='req']", function(){
      if (this.disabled) return;
      const titolo = this.getAttribute("data-title") || "";
      openRequestModal(titolo);
    });

  } else {
    table.clear();
    table.rows.add(data).draw(false);
  }
}

function escapeHtml_(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

/* =========================
   FILTRO GIOCATORI (numero compreso nell'intervallo)
========================= */
$.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
  // Applica solo alla nostra tabella catalogo
  if (settings.nTable && settings.nTable.id !== "tblCatalogo") return true;

  const val = (playerFilterValue || "").trim();
  if (!val) return true; // nessun filtro inserito

  const text = (data[1] || "").toString(); // colonna "Giocatori"
  if (!text) return false;

  const num = parseInt(val, 10);
  // Se l'utente non mette un numero, fallback a "contiene"
  if (isNaN(num)) {
    return text.toLowerCase().includes(val.toLowerCase());
  }

  // Esempi di text: "2-4", "1-5", "3", "2â€“4"
  const parts = text.split(/[-â€“]/).map(p => parseInt(p, 10)).filter(n => !isNaN(n));

  if (parts.length === 1) {
    // Tipo "3" -> match solo se uguale
    return num === parts[0];
  }
  if (parts.length >= 2) {
    const min = Math.min(parts[0], parts[1]);
    const max = Math.max(parts[0], parts[1]);
    return num >= min && num <= max; // numero compreso tra estremi
  }

  return false;
});

/* =========================
   Request modal logic
========================= */
let currentReqTitle = "";
let currentReqGiocatori = "";

function openRequestModal(titolo){
  currentReqTitle = String(titolo||"");
  E("reqTitle").textContent = currentReqTitle;

  // precompila se loggato
  const p = getProfile();
  if (p && p.Nome) E("reqNome").value = p.Nome;
  if (p && p.Telefono) E("reqTel").value = p.Telefono;

  // hint se solo registrati
  E("reqHints").textContent = onlyRegistered ? "ğŸ”’ Richiesta consentita solo a utenti registrati (sei ok se sei loggato)." : "";

  // trova giocatori dalla tabella (se disponibile)
  if (table){
    const row = table.rows().data().toArray().find(r => String(r.Titolo||"") === currentReqTitle);
    currentReqGiocatori = row ? String(row.Giocatori||"") : "";
  } else {
    currentReqGiocatori = "";
  }

  openModal("reqModal");
}

async function sendRequest(){
  const nome = E("reqNome").value.trim();
  const tel  = E("reqTel").value.trim();
  const note = E("reqNote").value.trim();

  if (!nome){
    showError("Inserisci il tuo nome.");
    return;
  }

  // se onlyRegistered -> devi essere loggato
  if (onlyRegistered && !getToken()){
    showError("Accesso richiesto: fai login prima di inviare la richiesta.");
    closeModal("reqModal");
    openModal("loginModal");
    return;
  }

  clearError();

  try{
    const r = await jsonp(API_URL, {
      action: "submit_request",
      token: getToken(),
      titolo: currentReqTitle,
      giocatori: currentReqGiocatori,
      nome,
      telefono: tel,
      note
    });

    if (!r.ok) throw new Error(r.error || "Errore invio");

    // segna localmente come requested
    bookingStateByTitle.set(currentReqTitle.trim().toLowerCase(), "requested");
    if (table) table.rows().invalidate().draw(false);

    closeModal("reqModal");
    alert("âœ… Richiesta inviata!");

  } catch (e){
    showError("Errore invio: " + (e?.message || String(e)));
  }
}

/* =========================
   Full refresh
========================= */
async function aggiornaTutto(){
  clearError();

  // blocco se countdown attivo e non bypass
  if (REVEAL_AT && REVEAL_AT !== 0 && !hasPreviewBypass() && Date.now() < new Date(REVEAL_AT).getTime()){
    return;
  }

  try{
    // 1) prima aggiorno i badge richiesto/prenotato
    await refreshTitleStatus();
    // 2) poi stats e catalogo
    await Promise.all([caricaStats(), caricaCatalogo()]);
    // 3) ridisegno con badge aggiornati (se la tabella Ã¨ appena nata)
    if (table) table.rows().invalidate().draw(false);
  } catch (e){
    showError("Errore refresh: " + (e?.message || String(e)));
  }
}

/* =========================
   Events
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  startCountdownShield();

  // inizializza sessione UI
  setWhoami();
  await refreshMeAndSettings();

  // se countdown non blocca -> carica
  await aggiornaTutto();

  // auto refresh (solo se sbloccato o bypass)
  setInterval(() => {
    const blocked = (REVEAL_AT && REVEAL_AT !== 0 && !hasPreviewBypass() && Date.now() < new Date(REVEAL_AT).getTime());
    if (!blocked) aggiornaTutto();
  }, 30000);

  // refresh button
  E("btnRefresh").addEventListener("click", () => aggiornaTutto());

  // login modal controls
  E("btnLogin").addEventListener("click", () => openModal("loginModal"));
  E("btnLoginCancel").addEventListener("click", () => closeModal("loginModal"));
  E("loginModal").addEventListener("click", (ev) => { if (ev.target === E("loginModal")) closeModal("loginModal"); });

  E("btnLoginGo").addEventListener("click", async () => {
    clearError();
    const u = E("loginUser").value.trim().toLowerCase();
    const p = E("loginPass").value;
    if (!u || !p){ showError("Inserisci username e password."); return; }

    try{
      const passhash = await sha256hex(p);
      const r = await jsonp(API_URL, { action:"login", username:u, passhash });

      if (!r.ok) throw new Error(r.error || "Login fallito");

      setSession(r.token, r.profile);
      closeModal("loginModal");
      await refreshMeAndSettings();

      setWhoami();
      alert("âœ… Login ok");

    } catch (e){
      showError("Login: " + (e?.message || String(e)));
    }
  });

  // logout
  E("btnLogout").addEventListener("click", async () => {
    const tok = getToken();
    clearSession();
    clearPreviewBypass();
    setWhoami();
    onlyRegistered = false;
    E("onlyRegHint").style.display = "none";
    try { if (tok) await jsonp(API_URL, { action:"logout", token: tok }); } catch {}
    alert("Logout effettuato");
  });

  // admin link
  E("btnAdmin").addEventListener("click", () => {
    location.href = "admin.html";
  });

  // preview bypass
  E("btnPreview").addEventListener("click", () => {
    if (!isAdmin()){
      alert("Solo admin puÃ² attivare preview.");
      return;
    }
    enablePreviewBypass();
    startCountdownShield();
    aggiornaTutto();
    alert("ğŸ‘ï¸ Preview attivata (bypass countdown temporaneo).");
  });

  // request modal controls
  E("btnReqCancel").addEventListener("click", () => closeModal("reqModal"));
  E("btnReqSend").addEventListener("click", () => sendRequest());
  E("reqModal").addEventListener("click", (ev) => { if (ev.target === E("reqModal")) closeModal("reqModal"); });
});
</script>
</body>
</html>