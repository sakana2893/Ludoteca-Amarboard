<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Admin Prenotazioni ‚Äì AmarBoard</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --rosso:#b02030;
      --verde:#1f7a3a;
      --oro:#f3d08a;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin:0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height:100vh;
      padding: 22px 14px 30px;
      color:#222;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      background: rgba(255,250,243,0.96);
      border-radius:20px;
      border: 2px solid rgba(176,32,48,0.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 18px rgba(176,32,48,0.2);
      padding: 18px 18px 16px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .left{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .logo{
      height:56px;
      border-radius:999px;
      background:#fff;
      box-shadow:0 0 6px rgba(0,0,0,0.15);
    }
    h1{
      margin:0;
      color:var(--rosso);
      font-size:1.35rem;
      font-weight:900;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      background:rgba(255,250,243,0.95);
      border:1px solid rgba(243,208,138,0.85);
      color:#7a0f1a;
      white-space:nowrap;
    }
    .btn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      text-decoration:none;
      color:#222;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn-ok{ border-color: rgba(31,122,58,.55); background: rgba(233,255,240,.95); color:#155724; }
    .btn-no{ border-color: rgba(176,32,48,.45); background: rgba(255,231,231,.92); color:#7a0f1a; }
    .btn-neutral{ border-color: rgba(0,0,0,.18); background: rgba(255,255,255,.92); color:#333; }

    .bar{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(31,122,58,0.18);
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      align-items:center;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#333;
    }
    .toggle input{ transform:scale(1.2); }

    #msg{
      display:none;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.1);
      background: rgba(255,255,255,.85);
      font-weight:900;
    }
    .ok{ border-color: rgba(31,122,58,.25); background: rgba(233,255,240,.95); color:#155724; }
    .no{ border-color: rgba(176,32,48,.25); background: rgba(255,231,231,.92); color:#7a0f1a; }

    table.dataTable thead th{
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom: 2px solid var(--rosso);
      font-weight:900;
    }

    .badge{
      padding:5px 10px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:900;
      display:inline-block;
      white-space:nowrap;
    }
    .b-new{ background:#efe1ff; border:1px solid #c9a7ff; color:#4a1a7a; }
    .b-ok{ background:#ffe8c7; border:1px solid #ffc37a; color:#7a3d00; }
    .b-rej{ background:#f8d7da; border:1px solid #f1b0b7; color:#721c24; }
    .b-del{ background:#eee; border:1px solid #ddd; color:#444; }

    img.emoji{ height: 1em; width: 1em; margin: 0 .05em 0 .1em; vertical-align: -0.1em; }

    @media (max-width: 700px){
      .wrap{ padding:14px; }
      .logo{ height:48px; }
      h1{ font-size:1.2rem; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <img class="logo" src="logo_amarboard.png" alt="AmarBoard">
        <div>
          <h1>Admin Prenotazioni</h1>
          <div style="font-weight:900; color:#555; font-size:.9rem;">Gestione richieste + storico</div>
        </div>
      </div>

      <div class="right" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <a class="btn btn-neutral" href="index.html">‚¨Ö Torna al catalogo</a>
        <span class="pill" id="who">üë§ ‚Äì</span>
        <button class="btn btn-no" id="btnLogout" type="button">üö™ Logout</button>
      </div>
    </div>

    <div class="bar">
      <div class="toggle">
        <input id="chkRequireLogin" type="checkbox">
        <label for="chkRequireLogin">üîí Abilita richieste <u>solo</u> per utenti registrati</label>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-neutral" id="btnRefresh" type="button">üîÑ Aggiorna</button>
      </div>
    </div>

    <div id="msg"></div>

    <table id="tbl" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Data</th>
          <th>ID</th>
          <th>Titolo</th>
          <th>Giocatori</th>
          <th>Nome</th>
          <th>Telefono</th>
          <th>Note</th>
          <th>Stato</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbymY3lNuMU13fv2NSXJBBAkGh0iOMzABjzuWnARGjsY_UHr7ZWEUM6wss9f1A2zbi9dcA/exec";
const LS_USER_TOKEN   = "AB_USER_TOKEN";
const LS_USER_PROFILE = "AB_USER_PROFILE";

let table = null;
let me = null;

/* UI */
function showMsg(text, ok=true){
  const el = document.getElementById("msg");
  el.className = ok ? "ok" : "no";
  el.style.display = "block";
  el.textContent = text;
  try{ twemoji.parse(document.body, { folder:"svg", ext:".svg" }); }catch(e){}
}
function clearMsg(){
  const el = document.getElementById("msg");
  el.style.display = "none";
  el.textContent = "";
}
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 10000);

    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&v=" + Date.now();
    document.body.appendChild(s);
  });
}
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function badgeStato(st){
  const s = String(st||"").toLowerCase().trim();
  if(s === "nuova" || s === "richiesta") return '<span class="badge b-new">üü£ Nuova</span>';
  if(s === "approvata" || s === "prenotata") return '<span class="badge b-ok">üìå Approvata</span>';
  if(s === "rifiutata") return '<span class="badge b-rej">‚õî Rifiutata</span>';
  if(s === "eliminata" || s === "cancellata") return '<span class="badge b-del">üóëÔ∏è Eliminata</span>';
  return escapeHtml(st||"");
}

async function loadMe(){
  const token = localStorage.getItem(LS_USER_TOKEN) || "";
  if(!token) throw new Error("Non autenticato");
  const r = await jsonp(API_URL + "?action=me&token=" + encodeURIComponent(token));
  if(!r || !r.ok || !r.profile) throw new Error("Token non valido");
  me = r.profile;
  if(String(me.Ruolo||"") !== "admin") throw new Error("Non sei admin");
  document.getElementById("who").textContent = "üë§ " + (me.Nome || me.Username || "admin");
  try{ twemoji.parse(document.body, { folder:"svg", ext:".svg" }); }catch(e){}
  return token;
}

async function loadConfig(token){
  const r = await jsonp(API_URL + "?action=get_config&token=" + encodeURIComponent(token));
  if(r && r.ok && r.config){
    document.getElementById("chkRequireLogin").checked = !!r.config.requireLoginForRequest;
  }
}

async function setConfigRequireLogin(token, value){
  const r = await jsonp(API_URL + "?action=set_config&token=" + encodeURIComponent(token) + "&requireLoginForRequest=" + (value ? "1":"0"));
  if(!r || !r.ok) throw new Error(r?.error || "Errore set config");
}

async function loadRequests(token){
  clearMsg();
  const r = await jsonp(API_URL + "?action=list_requests&token=" + encodeURIComponent(token));
  if(!r || !r.ok) throw new Error(r?.error || "Errore list");
  const rows = r.rows || [];

  if(!table){
    table = $("#tbl").DataTable({
      data: rows,
      columns: [
        { data:"DataISO", render:(d)=> escapeHtml(d||"") },
        { data:"ID", render:(d)=> `<strong>${escapeHtml(d||"")}</strong>` },
        { data:"Titolo", render:(d)=> `<strong>${escapeHtml(d||"")}</strong>` },
        { data:"Giocatori", render:(d)=> escapeHtml(d||"") },
        { data:"Nome", render:(d)=> escapeHtml(d||"") },
        { data:"Telefono", render:(d)=> escapeHtml(d||"") },
        { data:"Note", render:(d)=> escapeHtml(d||"") },
        { data:"Stato", render:(d)=> badgeStato(d) },
        { data:null, orderable:false, render:(d,t,row)=>{
            const id = encodeURIComponent(row.ID||"");
            return `
              <button class="btn btn-ok act" data-act="approve" data-id="${id}">‚úÖ Approva</button>
              <button class="btn btn-no act" data-act="reject" data-id="${id}">‚õî Rifiuta</button>
              <button class="btn btn-neutral act" data-act="delete" data-id="${id}">üóëÔ∏è Elimina</button>
            `;
          }
        }
      ],
      order: [[0,"desc"]],   /* ordina per nuove (DataISO) */
      pageLength: 25,        /* ‚úÖ paginazione (A) */
      lengthMenu: [10, 25, 50, 100],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json" }
    });

    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest(".act");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      const id  = decodeURIComponent(btn.getAttribute("data-id")||"");
      if(!id) return;

      if(act === "delete"){
        if(!confirm("Eliminare la richiesta? (Non cancella righe da Sheets: mette Stato=Eliminata)")) return;
      }
      await doAction(token, act, id);
    });
  } else {
    table.clear();
    table.rows.add(rows).draw(false);
  }

  try{ twemoji.parse(document.body, { folder:"svg", ext:".svg" }); }catch(e){}
}

async function doAction(token, act, id){
  clearMsg();
  const url = API_URL + "?action=admin_" + act + "&token=" + encodeURIComponent(token) + "&id=" + encodeURIComponent(id);
  const r = await jsonp(url);
  if(!r || !r.ok) throw new Error(r?.error || "Errore azione");
  showMsg("‚úÖ Operazione eseguita.");
  await loadRequests(token);
}

function logout(){
  localStorage.removeItem(LS_USER_TOKEN);
  localStorage.removeItem(LS_USER_PROFILE);
  location.href = "index.html";
}

document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const token = await loadMe();
    await loadConfig(token);
    await loadRequests(token);

    document.getElementById("btnRefresh").addEventListener("click", ()=> loadRequests(token));

    document.getElementById("chkRequireLogin").addEventListener("change", async function(){
      try{
        await setConfigRequireLogin(token, this.checked);
        showMsg(this.checked
          ? "üîí Ora SOLO utenti registrati possono inviare richieste."
          : "‚úÖ Ora chiunque pu√≤ inviare richieste (anche senza login)."
        , true);
      }catch(e){
        this.checked = !this.checked;
        showMsg("Errore: " + (e?.message || String(e)), false);
      }
    });

    document.getElementById("btnLogout").addEventListener("click", logout);

  }catch(e){
    showMsg("Accesso negato: " + (e?.message || String(e)), false);
    setTimeout(()=> location.href = "index.html", 1200);
  }
});
</script>
</body>
</html>
