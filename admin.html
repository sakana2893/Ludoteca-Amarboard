<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Admin Prenotazioni ‚Äì AmarBoard</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:0;background:#111;color:#f5f5f5}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    .card{background:#181818;border:1px solid #333;border-radius:14px;padding:14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #444;background:#222;color:#fff;cursor:pointer}
    .btn:hover{background:#2a2a2a}
    .btn-ok{border-color:#1f7a3a;background:#102818}
    .btn-no{border-color:#b02030;background:#2a1216}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.8rem;border:1px solid #444}
    .p-inv{background:#2b1b1b}
    .p-app{background:#1b2b1b}
    .p-rif{background:#2b2b1b}
    .row{display:grid;grid-template-columns:1.6fr .7fr .7fr .7fr 1fr;gap:10px;align-items:center;padding:10px;border-bottom:1px solid #2a2a2a}
    .row:last-child{border-bottom:none}
    .small{color:#aaa;font-size:.85rem}
    .toggle{display:flex;gap:10px;align-items:center}
    .err{color:#ffb3b3;font-weight:800;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn" href="index.html" style="text-decoration:none;display:inline-block">‚¨ÖÔ∏è Torna al catalogo</a>
      <button class="btn" id="btnLogout">üö™ Logout</button>
    </div>
    <div class="toggle">
      <span class="small">Solo utenti registrati:</span>
      <button class="btn" id="btnOnlyOff">OFF</button>
      <button class="btn" id="btnOnlyOn">ON</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">Richieste (pi√π nuove sopra)</h2>
      <button class="btn" id="btnRefresh">üîÑ Aggiorna</button>
    </div>

    <div class="small" id="who"></div>
    <div id="list"></div>
    <div class="err" id="err"></div>
  </div>
</div>

<script>
/* incolla QUI lo stesso code.js, con lo stesso API_URL */
</script>

<script>
function pill(st){
  const s=(st||"").toLowerCase();
  if(s==="inviata") return `<span class="pill p-inv">üìå Inviata</span>`;
  if(s==="approvata") return `<span class="pill p-app">‚úÖ Approvata</span>`;
  if(s==="rifiutata") return `<span class="pill p-rif">‚õî Rifiutata</span>`;
  if(s==="cancellata") return `<span class="pill">üóëÔ∏è Cancellata</span>`;
  return `<span class="pill">${st||"‚Äî"}</span>`;
}

async function guardAdmin(){
  const me = await loadMe();
  if(!me.ok) { location.href="index.html"; return; }
  if(!me.profile || me.profile.Ruolo!=="admin") { location.href="index.html"; return; }
  E("who").textContent = `Loggato come: ${me.profile.Username} (admin)`;
}

async function loadList(){
  E("err").textContent="";
  const token = getToken();
  const r = await api("admin_list", { token });
  if(!r.ok) throw new Error(r.error||"Errore admin_list");

  // UI toggle
  const on = !!r.onlyRegistered;
  E("btnOnlyOn").style.opacity = on ? "1":"0.5";
  E("btnOnlyOff").style.opacity = on ? "0.5":"1";

  const box = E("list");
  box.innerHTML = "";

  const items = r.items || [];
  if(!items.length){
    box.innerHTML = `<div class="small">Nessuna richiesta.</div>`;
    return;
  }

  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>
        <div style="font-weight:800">${it.Titolo||"‚Äî"}</div>
        <div class="small">${it.Nome||""} ‚Ä¢ ${it.Telefono||""} ‚Ä¢ ${it.Giocatori||""}</div>
        <div class="small">${it.DataISO||""}${it.Note?(" ‚Ä¢ Note: "+it.Note):""}</div>
      </div>
      <div>${pill(it.Stato)}</div>
      <div><button class="btn btn-ok" data-act="ok" data-id="${it.ID}">Approva</button></div>
      <div><button class="btn btn-no" data-act="no" data-id="${it.ID}">Rifiuta</button></div>
      <div><button class="btn" data-act="del" data-id="${it.ID}">Cancella</button></div>
    `;
    box.appendChild(div);
  });
}

document.addEventListener("click", async (ev)=>{
  const b = ev.target.closest("button[data-act]");
  if(!b) return;
  const id = b.getAttribute("data-id");
  const act = b.getAttribute("data-act");
  const token = getToken();

  try{
    if(act==="ok") {
      const r = await api("admin_set_status", { token, id, stato:"Approvata" });
      if(!r.ok) throw new Error(r.error||"Errore approva");
    } else if(act==="no") {
      const r = await api("admin_set_status", { token, id, stato:"Rifiutata" });
      if(!r.ok) throw new Error(r.error||"Errore rifiuta");
    } else if(act==="del") {
      const r = await api("admin_delete", { token, id });
      if(!r.ok) throw new Error(r.error||"Errore cancella");
    }
    await loadList();
  }catch(e){
    E("err").textContent = e.message || "Errore";
  }
});

E("btnRefresh").onclick = async ()=>{ try{ await loadList(); }catch(e){ E("err").textContent=e.message; } };

E("btnLogout").onclick = async ()=>{
  await doLogout();
  location.href="index.html";
};

E("btnOnlyOn").onclick = async ()=>{
  try{
    const token = getToken();
    const r = await api("admin_set_only_registered", { token, value:"true" });
    if(!r.ok) throw new Error(r.error||"Errore");
    await loadList();
  }catch(e){ E("err").textContent=e.message; }
};
E("btnOnlyOff").onclick = async ()=>{
  try{
    const token = getToken();
    const r = await api("admin_set_only_registered", { token, value:"false" });
    if(!r.ok) throw new Error(r.error||"Errore");
    await loadList();
  }catch(e){ E("err").textContent=e.message; }
};

document.addEventListener("DOMContentLoaded", async ()=>{
  await guardAdmin();
  await loadList();

  // auto refresh admin ogni 10s
  setInterval(async ()=>{ try{ await loadList(); }catch(e){} }, 10000);
});
</script>
</body>
</html>
