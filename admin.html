<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>AmarBoard ‚Äì Admin Prenotazioni</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <style>
    :root{ --rosso:#b02030; --verde:#1f7a3a; --oro:#f3d08a; }
    *{ box-sizing:border-box; }
    body{
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      margin:0; padding:0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height:100vh;
      overflow-x:hidden;
    }
    .garland{
      position:fixed; top:0; left:0; width:100%; height:60px;
      background: radial-gradient(circle at center, rgba(31,122,58,0.7), rgba(0,0,0,0.3));
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:#ffe; font-size:1.4rem; z-index:2;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      user-select:none;
    }
    .garland span{ animation: blink 2.2s linear infinite; }
    .garland span:nth-child(odd){ animation-delay:0.7s; }
    @keyframes blink{ 0%,100%{opacity:.4} 50%{opacity:1} }

    #wrapper{
      max-width:1200px;
      margin:90px auto 40px;
      padding:24px 26px 30px;
      background: rgba(255,250,243,0.96);
      border-radius:20px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 18px rgba(176,32,48,0.4);
      border:2px solid rgba(176,32,48,0.35);
      position:relative; z-index:3;
    }
    #wrapper::before{
      content:""; position:absolute; inset:8px;
      border-radius:16px;
      border:2px dashed rgba(243,208,138,0.7);
      pointer-events:none;
    }
    h1{
      margin:4px 0 6px;
      text-align:center;
      font-size:1.8rem;
      color:var(--rosso);
      text-shadow: 0 1px 0 #fff, 0 0 6px rgba(176,32,48,0.35);
      font-weight:900;
    }
    .subtitle{
      text-align:center;
      font-size:0.9rem;
      color:#555;
      margin-bottom:14px;
      font-weight:800;
    }

    .panel{
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
      position:relative; z-index:4;
    }
    .left, .right{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn-ok{ border-color: rgba(31,122,58,.55); background:rgba(233,255,240,.95); color:#155724; }
    .btn-no{ border-color: rgba(176,32,48,.45); background:rgba(255,231,231,.92); color:#7a0f1a; }
    .btn-neutral{ border-color: rgba(0,0,0,.18); background:rgba(255,255,255,.92); color:#333; }
    .btn-del{ border-color: rgba(0,0,0,.25); background:rgba(255,255,255,.92); color:#111; }

    input[type="text"]{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      font-weight:800;
      min-width:220px;
    }
    label{ font-weight:900; color:#333; user-select:none; display:inline-flex; align-items:center; gap:8px; }
    .counts{
      font-weight:900;
      color:#7a0f1a;
      background:rgba(255,250,243,0.95);
      border:1px solid rgba(243,208,138,0.9);
      border-radius:999px;
      padding:6px 10px;
    }
    #errBox{
      display:none;
      margin:12px 0 0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(176,32,48,0.35);
      background: rgba(255, 231, 231, 0.85);
      color:#7a0f1a;
      font-weight:900;
      position:relative; z-index:5;
    }
    #loading{
      display:none;
      margin:12px 0 0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(31,122,58,0.25);
      background: rgba(233,255,240,0.95);
      color:#155724;
      font-weight:900;
      position:relative; z-index:5;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      border:1px solid rgba(0,0,0,0.06);
      position:relative; z-index:4;
    }
    thead th{
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom:2px solid var(--rosso);
      text-align:left;
      padding:10px 10px;
      font-weight:900;
      color:#222;
      font-size:0.9rem;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(0,0,0,0.06);
      vertical-align:top;
      font-weight:800;
      color:#222;
      font-size:0.9rem;
    }
    tbody tr:nth-child(even){ background:#fffaf5; }
    tbody tr:hover{ background:#fff3f3; }

    .mono{ font-variant-numeric: tabular-nums; }
    .note{ max-width:360px; white-space:pre-wrap; color:#333; opacity:.95; font-weight:800; }

    .stato{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.78rem;
      border:1px solid rgba(0,0,0,0.08);
      background:#f3f3f3;
      color:#333;
      letter-spacing:.03em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .stato-NUOVA{ background:#efe1ff; border-color:#c9a7ff; color:#4a1a7a; }
    .stato-APPROVATA{ background:#ffe8c7; border-color:#ffc37a; color:#7a3d00; }
    .stato-RIFIUTATA{ background:#f8d7da; border-color:#f1b0b7; color:#721c24; }

    .footer-note{
      margin-top:10px;
      font-size:0.8rem;
      color:#777;
      text-align:right;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="garland">
    <span>‚ú®</span><span>üéÑ</span><span>‚≠ê</span><span>üïØÔ∏è</span>
    <span>üõ°Ô∏è AmarBoard Admin ‚Äì Prenotazioni üõ°Ô∏è</span>
    <span>‚≠ê</span><span>üéÑ</span><span>‚ú®</span>
  </div>

  <div id="wrapper">
    <h1>Admin Prenotazioni ‚Äì AmarBoard</h1>
    <div class="subtitle">
      Accesso riservato agli admin. Ordinamento: <b>pi√π nuove</b>.
    </div>

    <div id="gate" class="panel">
      <div class="left">
        <span class="counts">Sessione richiesta</span>
        <span id="gateMsg" style="font-weight:900;color:#333">Apri prima il catalogo e fai login.</span>
      </div>
      <div class="right">
        <a class="btn btn-ok" href="index.html">üîë Vai al Catalogo</a>
      </div>
    </div>

    <div id="adminArea" style="display:none;">
      <div class="panel">
        <div class="left">
          <button class="btn btn-neutral" id="btnRefresh" type="button">üîÑ Aggiorna</button>
          <label><input id="chkOnlyOpen" type="checkbox"> Solo NUOVA</label>
          <input id="txtSearch" type="text" placeholder="Cerca titolo/nome/tel/note...">
          <span class="counts">Tot: <span id="cntTot">0</span> ‚Äî Visibili: <span id="cntVis">0</span></span>
        </div>
        <div class="right">
          <button class="btn btn-no" id="btnLogout" type="button">üö™ Logout</button>
        </div>
      </div>

      <div id="errBox"></div>
      <div id="loading">Caricamento‚Ä¶</div>

      <table>
        <thead>
          <tr>
            <th>Data</th><th>Titolo</th><th>Nome</th><th>Tel</th><th>Note</th>
            <th>Stato</th><th>GestitoDa</th><th>GestitoIl</th><th>Azioni</th>
          </tr>
        </thead>
        <tbody id="tblBody"></tbody>
      </table>

      <div class="footer-note">AmarBoard ‚Äì admin con ruolo (token utente) + Apps Script</div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymY3lNuMU13fv2NSXJBBAkGh0iOMzABjzuWnARGjsY_UHr7ZWEUM6wss9f1A2zbi9dcA/exec";

    // Deve combaciare con index.html
    const LS_USER_TOKEN = "AB_USER_TOKEN";
    const LS_USER_PROFILE = "AB_USER_PROFILE";

    const REFRESH_EVERY_MS = 15000;

    let token = "";
    let profile = null;
    let lastRows = [];

    function $(id){ return document.getElementById(id); }
    function renderEmoji(){ try{ twemoji.parse(document.body, { folder:"svg", ext:".svg" }); }catch(e){} }

    function esc(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function fmtDate(iso){
      const s = String(iso||"").trim();
      if(!s) return "";
      const d = new Date(s);
      if(isNaN(d.getTime())) return s;
      return d.toLocaleString("it-IT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }

    function showErr(msg){
      $("errBox").style.display = "block";
      $("errBox").textContent = msg;
    }
    function clearErr(){
      $("errBox").style.display = "none";
      $("errBox").textContent = "";
    }
    function showLoading(on){
      $("loading").style.display = on ? "block" : "none";
    }

    // JSONP helper (GET) ‚Äì evita CORS
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 8000);

        function cleanup(){
          clearTimeout(t);
          try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
          if(s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };

        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&v=" + Date.now();
        document.body.appendChild(s);
      });
    }

    async function loadMe(){
      token = localStorage.getItem(LS_USER_TOKEN) || "";
      if(!token) return { ok:false, error:"missing_token" };

      const data = await jsonp(API_URL + "?action=me&token=" + encodeURIComponent(token));
      return data;
    }

    function logout(){
      localStorage.removeItem(LS_USER_TOKEN);
      localStorage.removeItem(LS_USER_PROFILE);
      location.reload();
    }

    function renderTable(rows){
      rows = [...rows].sort((a,b)=> String(b.DataISO||"").localeCompare(String(a.DataISO||"")));
      lastRows = rows;

      $("cntTot").textContent = String(rows.length);

      const onlyOpen = $("chkOnlyOpen").checked;
      const q = ($("txtSearch").value || "").trim().toLowerCase();

      let filtered = rows;
      if(onlyOpen){
        filtered = filtered.filter(r => String(r.Stato||"").toUpperCase() === "NUOVA");
      }
      if(q){
        filtered = filtered.filter(r => {
          const blob = [r.Titolo,r.Nome,r.Telefono,r.Giocatori,r.Note,r.Stato,r.ID]
            .map(x=>String(x||"").toLowerCase()).join(" | ");
          return blob.includes(q);
        });
      }

      $("cntVis").textContent = String(filtered.length);

      const tbody = $("tblBody");
      tbody.innerHTML = "";

      filtered.forEach(r=>{
        const stato = String(r.Stato||"").toUpperCase();
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="mono">${esc(fmtDate(r.DataISO))}</td>
          <td>
            <strong>${esc(r.Titolo)}</strong>
            <div style="opacity:.75;font-size:.85em">${esc(r.Giocatori||"")}</div>
            <div style="opacity:.55;font-size:.78em" class="mono">ID: ${esc(r.ID||"")}</div>
          </td>
          <td>${esc(r.Nome||"")}</td>
          <td>${esc(r.Telefono||"")}</td>
          <td class="note">${esc(r.Note||"")}</td>
          <td><span class="stato stato-${esc(stato)}">${esc(stato||"")}</span></td>
          <td>${esc(r.GestitoDa||"")}</td>
          <td class="mono">${esc(fmtDate(r.GestitoIl||""))}</td>
          <td style="white-space:nowrap">
            <button class="btn btn-ok" data-act="approve" data-id="${esc(r.ID)}">‚úÖ Approva</button>
            <button class="btn btn-no" data-act="reject" data-id="${esc(r.ID)}">‚õî Rifiuta</button>
            <button class="btn btn-neutral" data-act="new" data-id="${esc(r.ID)}">‚Ü©Ô∏è Nuova</button>
            <button class="btn btn-del" data-act="del" data-id="${esc(r.ID)}">üóëÔ∏è Elimina</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderEmoji();
    }

    async function loadAdminList(){
      clearErr();
      showLoading(true);
      try{
        const data = await jsonp(API_URL + "?action=list_admin&limit=500&token=" + encodeURIComponent(token));
        if(!data || !data.ok) throw new Error(data?.error || "Errore list_admin");
        renderTable(data.rows || []);
      }catch(e){
        showErr("Errore refresh admin: " + (e?.message ?? String(e)));
      }finally{
        showLoading(false);
      }
    }

    async function setStatus(id, stato){
      try{
        const data = await jsonp(
          API_URL + "?action=admin_set_status&id=" + encodeURIComponent(id) +
          "&stato=" + encodeURIComponent(stato) +
          "&token=" + encodeURIComponent(token)
        );
        if(!data || !data.ok) throw new Error(data?.error || "Errore admin_set_status");
        await loadAdminList();
      }catch(e){
        alert("Errore cambio stato: " + (e?.message ?? String(e)));
      }
    }

    async function deleteReq(id){
      if(!confirm("Vuoi cancellare DEFINITIVAMENTE questa richiesta?")) return;
      try{
        const data = await jsonp(
          API_URL + "?action=admin_delete&id=" + encodeURIComponent(id) +
          "&token=" + encodeURIComponent(token)
        );
        if(!data || !data.ok) throw new Error(data?.error || "Errore admin_delete");
        await loadAdminList();
      }catch(e){
        alert("Errore cancellazione: " + (e?.message ?? String(e)));
      }
    }

    function wire(){
      $("btnRefresh").addEventListener("click", loadAdminList);
      $("btnLogout").addEventListener("click", logout);

      $("chkOnlyOpen").addEventListener("change", ()=>renderTable(lastRows));
      $("txtSearch").addEventListener("input", ()=>renderTable(lastRows));

      $("tblBody").addEventListener("click", (e)=>{
        const b = e.target.closest("button");
        if(!b) return;
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        if(!id || !act) return;

        if(act==="approve") setStatus(id, "APPROVATA");
        else if(act==="reject") setStatus(id, "RIFIUTATA");
        else if(act==="new") setStatus(id, "NUOVA");
        else if(act==="del") deleteReq(id);
      });
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      wire();
      renderEmoji();

      try{
        const me = await loadMe();
        if(!me || !me.ok){
          $("gate").style.display = "flex";
          $("adminArea").style.display = "none";
          $("gateMsg").textContent = "Sessione mancante o scaduta. Fai login dal catalogo.";
          return;
        }

        profile = me.profile;
        localStorage.setItem(LS_USER_PROFILE, JSON.stringify(profile));

        if(String(profile.Ruolo||"") !== "admin"){
          $("gate").style.display = "flex";
          $("adminArea").style.display = "none";
          $("gateMsg").textContent = "Accesso negato: il tuo account non √® admin.";
          return;
        }

        $("gate").style.display = "none";
        $("adminArea").style.display = "block";

        await loadAdminList();
        setInterval(loadAdminList, REFRESH_EVERY_MS);

      }catch(e){
        $("gate").style.display = "flex";
        $("adminArea").style.display = "none";
        $("gateMsg").textContent = "Errore: " + (e?.message ?? String(e));
      }
    });
  </script>
</body>
</html>
