<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Admin Prenotazioni ‚Äì AmarBoard</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

  <style>
    :root { --rosso:#b02030; --verde:#1f7a3a; --oro:#f3d08a; }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
      margin:0; padding:0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height:100vh;
    }
    .garland{
      position: fixed; top:0; left:0; width:100%; height:60px;
      background: radial-gradient(circle at center, rgba(31,122,58,0.7), rgba(0,0,0,0.3));
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:#ffe; font-size:1.2rem; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    #wrap{
      max-width:1200px;
      margin: 90px auto 40px;
      padding: 22px 24px 26px;
      background: rgba(255,250,243,0.96);
      border-radius: 20px;
      border: 2px solid rgba(176,32,48,0.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 18px rgba(176,32,48,0.35);
      position: relative;
    }
    #wrap::before{
      content:""; position:absolute; inset:8px;
      border-radius: 16px;
      border: 2px dashed rgba(243,208,138,0.7);
      pointer-events:none;
    }
    h1{
      margin: 6px 0 2px;
      text-align:center;
      color: var(--rosso);
      text-shadow: 0 1px 0 #fff, 0 0 6px rgba(176,32,48,0.25);
      font-size: 1.7rem;
      font-weight: 900;
    }
    .sub{
      text-align:center;
      color:#555;
      margin: 0 0 14px;
      font-weight: 800;
      font-size: 0.9rem;
    }
    .topbar{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(31,122,58,0.18);
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }
    .left, .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(176,32,48,0.25);
      background: rgba(255,255,255,0.75);
      font-weight: 900;
      color:#7a0f1a;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-weight: 900;
    }
    .btn-ok{ border:1px solid rgba(31,122,58,0.55); background: rgba(233,255,240,0.95); color:#155724; }
    .btn-warn{ border:1px solid rgba(176,32,48,0.55); background: rgba(255,231,231,0.95); color:#7a0f1a; }
    input[type="text"], select{
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      font-weight: 800;
    }
    #errorBox{
      display:none;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(176,32,48,0.35);
      background: rgba(255,231,231,0.85);
      color:#7a0f1a;
      font-weight: 900;
    }
    .act{ display:flex; gap:6px; flex-wrap: wrap; }
    .mini{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      font-size: 0.85rem;
    }
    .mini.ok{ border-color: rgba(31,122,58,0.55); background: rgba(233,255,240,0.95); color:#155724; }
    .mini.bad{ border-color: rgba(176,32,48,0.55); background: rgba(255,231,231,0.95); color:#7a0f1a; }
    .mini.neu{ border-color: rgba(243,208,138,0.9); background: rgba(255,250,243,0.95); color:#7a3d00; }

    .badge{ padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:900;display:inline-block;white-space:nowrap }
    .b-nuova{ background:#efe1ff; color:#4a1a7a; border:1px solid #c9a7ff; }
    .b-presa{ background:#e6f3ff; color:#0b3d6b; border:1px solid #a9d0ff; }
    .b-app{ background:#ffe8c7; color:#7a3d00; border:1px solid #ffc37a; }
    .b-rif{ background:#f8d7da; color:#721c24; border:1px solid #f1b0b7; }
    .b-eva{ background:#d4edda; color:#155724; border:1px solid #b1dfbb; }
    .b-del{ background:#eee; color:#555; border:1px solid #ccc; }

    #pinModal{
      position: fixed; inset:0; z-index: 9999;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.55);
      padding: 16px;
    }
    #pinModal .card{
      width: min(420px, 100%);
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.35);
      border-radius: 16px;
      padding: 16px 14px;
      box-shadow: 0 0 24px rgba(0,0,0,0.35);
      color:#222;
    }
    #pinModal h2{ margin:0 0 8px; color:#7a0f1a; font-size: 1.15rem; }
    #pinModal p{ margin:0 0 12px; color:#444; font-size:0.9rem; line-height:1.35; font-weight:800; }
    #pinModal input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background:#fff;
      font-size: 1rem;
      font-weight:900;
    }
    #pinModal .row{ display:flex; gap:10px; margin-top: 12px; }
    #pinModal .row button{
      flex:1; padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; background:#fff;
      cursor:pointer; font-weight:900;
    }
    #pinModal .row .ok{ border-color: rgba(31,122,58,0.55); background: rgba(233,255,240,0.95); color:#155724; }
    #pinModal .row .cancel{ border-color: rgba(0,0,0,0.2); background: rgba(255,255,255,0.9); color:#333; }
    #pinErr{
      display:none; margin-top:10px; color:#7a0f1a; background: rgba(255,231,231,0.9);
      border: 1px solid rgba(176,32,48,0.4); padding: 8px 10px; border-radius: 12px; font-weight:900;
    }
    @media(max-width:768px){
      #wrap{ margin:80px 10px 20px; padding: 14px; }
      .topbar{ flex-direction: column; align-items: stretch; }
    }
  </style>
</head>

<body>
  <div class="garland">
    <span>‚ú®</span><span>üéÑ</span><span>‚≠ê</span><span>üïØÔ∏è</span>
    <span>üé≤ Admin AmarBoard üé≤</span>
    <span>‚≠ê</span><span>üéÑ</span><span>‚ú®</span>
  </div>

  <div id="pinModal">
    <div class="card">
      <h2>Accesso Admin</h2>
      <p>PIN (2486) per entrare nella dashboard prenotazioni.</p>
      <input id="pinInput" type="password" inputmode="numeric" autocomplete="off" placeholder="PIN">
      <div class="row">
        <button class="cancel" id="btnPinCancel" type="button">Chiudi</button>
        <button class="ok" id="btnPinOk" type="button">Entra</button>
      </div>
      <div id="pinErr">PIN errato.</div>
    </div>
  </div>

  <div id="wrap">
    <h1>Admin Prenotazioni</h1>
    <div class="sub">Foglio: <b>prenotazioni</b> ‚Ä¢ GestitoDa: <b>AmarBoard</b></div>

    <div class="topbar">
      <div class="left">
        <span class="pill" id="pillNew">üü£ Nuove: 0</span>
        <span class="pill" id="pillTot">üìö Totali: 0</span>

        <select id="filtroStato">
          <option value="">Tutti gli stati</option>
          <option value="NUOVA">NUOVA</option>
          <option value="PRESA_IN_CARICO">PRESA_IN_CARICO</option>
          <option value="APPROVATA">APPROVATA</option>
          <option value="RIFIUTATA">RIFIUTATA</option>
          <option value="EVASA">EVASA</option>
          <option value="ELIMINATA">ELIMINATA</option>
        </select>

        <input id="q" type="text" placeholder="Cerca titolo/nome/tel/note">
      </div>

      <div class="right">
        <button class="btn btn-ok" id="btnRefresh" type="button">üîÑ Aggiorna</button>
        <button class="btn btn-warn" id="btnLogout" type="button">üö™ Logout</button>
      </div>
    </div>

    <div id="errorBox"></div>

    <table id="tbl" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Data</th>
          <th>Titolo</th>
          <th>Nome</th>
          <th>Telefono</th>
          <th>Note</th>
          <th>Stato</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbymY3lNuMU13fv2NSXJBBAkGh0iOMzABjzuWnARGjsY_UHr7ZWEUM6wss9f1A2zbi9dcA/exec";
  const ADMIN_KEY = "amarboard00102030405060708090";
  const ADMIN_PIN = "2486";
  const ADMIN_TTL_HOURS = 10;
  const MANAGED_BY = "AmarBoard";
  const REFRESH_MS = 12000;

  let table = null;
  let timer = null;

  function renderEmoji(){ try{ twemoji.parse(document.body,{folder:"svg",ext:".svg"}); }catch(e){} }

  function showError(msg){
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearError(){
    const box = document.getElementById("errorBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      const s=document.createElement("script");
      const timeout=setTimeout(()=>{cleanup(); reject(new Error("JSONP timeout"));},7000);

      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb]=(data)=>{ cleanup(); resolve(data); };
      s.onerror=()=>{ cleanup(); reject(new Error("JSONP load error")); };

      s.src = url + (url.includes("?")?"&":"?") + "callback=" + cb + "&v=" + Date.now();
      document.body.appendChild(s);
    });
  }

  function badgeStatoHtml(st){
    const s = String(st||"").toUpperCase().trim();
    if(s==="NUOVA") return '<span class="badge b-nuova">üü£ NUOVA</span>';
    if(s==="PRESA_IN_CARICO") return '<span class="badge b-presa">üîµ PRESA</span>';
    if(s==="APPROVATA") return '<span class="badge b-app">üü† APPROVATA</span>';
    if(s==="RIFIUTATA") return '<span class="badge b-rif">üî¥ RIFIUTATA</span>';
    if(s==="EVASA") return '<span class="badge b-eva">üü¢ EVASA</span>';
    if(s==="ELIMINATA") return '<span class="badge b-del">‚ö™ ELIMINATA</span>';
    return s;
  }

  function fmtData(iso){
    if(!iso) return "";
    try{
      const d = new Date(iso);
      return d.toLocaleString("it-IT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch{ return iso; }
  }

  function isAdmin(){
    try{
      const raw=localStorage.getItem("AB_ADMIN_ADMINPAGE");
      if(!raw) return false;
      const obj=JSON.parse(raw);
      return obj && obj.until && Date.now() < obj.until;
    }catch{ return false; }
  }
  function setAdminSession(){
    localStorage.setItem("AB_ADMIN_ADMINPAGE", JSON.stringify({ until: Date.now()+ADMIN_TTL_HOURS*3600000 }));
  }
  function clearAdminSession(){
    localStorage.removeItem("AB_ADMIN_ADMINPAGE");
  }
  function submitPin(){
    const v=document.getElementById("pinInput").value;
    if(v===ADMIN_PIN){
      setAdminSession();
      document.getElementById("pinModal").style.display="none";
      init();
    } else {
      document.getElementById("pinErr").style.display="block";
    }
  }

  function countNew(rows){
    return rows.filter(r => String(r.Stato||"").toUpperCase().trim()==="NUOVA").length;
  }
  function sortNewFirst(rows){
    return rows.slice().sort((a,b)=>{
      const sa=String(a.Stato||"").toUpperCase().trim();
      const sb=String(b.Stato||"").toUpperCase().trim();
      const pa=(sa==="NUOVA")?0:(sa==="PRESA_IN_CARICO")?1:2;
      const pb=(sb==="NUOVA")?0:(sb==="PRESA_IN_CARICO")?1:2;
      if(pa!==pb) return pa-pb;
      return String(b.DataISO||"").localeCompare(String(a.DataISO||""));
    });
  }

  async function fetchList(){
    const only = document.getElementById("filtroStato").value || "";
    const q = (document.getElementById("q").value || "").trim();
    const url = API_URL + "?action=list&key=" + encodeURIComponent(ADMIN_KEY) +
                "&only=" + encodeURIComponent(only) +
                "&q=" + encodeURIComponent(q);
    const data = await jsonp(url);
    if(!data || !data.ok) throw new Error(data?.error || "Errore list");
    return data.rows || [];
  }

  async function updateRow(id, stato){
    const url = API_URL + "?action=update&key=" + encodeURIComponent(ADMIN_KEY) +
                "&id=" + encodeURIComponent(id) +
                "&stato=" + encodeURIComponent(stato) +
                "&by=" + encodeURIComponent(MANAGED_BY);
    const data = await jsonp(url);
    if(!data || !data.ok) throw new Error(data?.error || "Errore update");
    return true;
  }

  async function archiveRow(id){
    const url = API_URL + "?action=archive&key=" + encodeURIComponent(ADMIN_KEY) +
                "&id=" + encodeURIComponent(id) +
                "&by=" + encodeURIComponent(MANAGED_BY);
    const data = await jsonp(url);
    if(!data || !data.ok) throw new Error(data?.error || "Errore archive");
    return true;
  }

  async function refresh(){
    clearError();
    try{
      let rows = await fetchList();
      rows = sortNewFirst(rows);

      document.getElementById("pillNew").innerHTML = `üü£ Nuove: ${countNew(rows)}`;
      document.getElementById("pillTot").innerHTML = `üìö Totali: ${rows.length}`;

      if(!table){
        table = $("#tbl").DataTable({
          data: rows,
          columns: [
            { data:"DataISO", render: d => fmtData(d) },
            { data:"Titolo" },
            { data:"Nome" },
            { data:"Telefono" },
            { data:"Note" },
            { data:"Stato", render: d => badgeStatoHtml(d) },
            {
              data: null,
              orderable: false,
              render: r => {
                const id = String(r.ID||"");
                return `
                  <div class="act">
                    <button class="mini neu" data-act="take" data-id="${id}">üîµ Presa</button>
                    <button class="mini ok"  data-act="ok"   data-id="${id}">üü† Approva</button>
                    <button class="mini bad" data-act="no"   data-id="${id}">üî¥ Rifiuta</button>
                    <button class="mini ok"  data-act="done" data-id="${id}">üü¢ Evasa</button>
                    <button class="mini bad" data-act="del"  data-id="${id}">üóëÔ∏è Elimina</button>
                  </div>`;
              }
            }
          ],
          paging: false,
          info: false,
          searching: false,
          order: []
        });
      } else {
        table.clear();
        table.rows.add(rows).draw(false);
      }
      renderEmoji();
    }catch(e){
      showError("Errore refresh: " + (e?.message ?? String(e)));
    }
  }

  function init(){
    refresh();
    if(timer) clearInterval(timer);
    timer = setInterval(refresh, REFRESH_MS);

    document.getElementById("btnRefresh").addEventListener("click", refresh);
    document.getElementById("btnLogout").addEventListener("click", ()=>{
      clearAdminSession();
      location.reload();
    });

    document.getElementById("filtroStato").addEventListener("change", refresh);
    document.getElementById("q").addEventListener("keyup", ()=>{
      if(window.__t) clearTimeout(window.__t);
      window.__t = setTimeout(refresh, 250);
    });

    document.body.addEventListener("click", async (ev)=>{
      const t = ev.target;
      if(!t || !t.dataset || !t.dataset.act) return;

      const id = t.dataset.id;
      const act = t.dataset.act;

      try{
        t.disabled = true;
        if(act === "take") await updateRow(id, "PRESA_IN_CARICO");
        if(act === "ok")   await updateRow(id, "APPROVATA");
        if(act === "no")   await updateRow(id, "RIFIUTATA");
        if(act === "done") await updateRow(id, "EVASA");
        if(act === "del"){
          const conf = confirm("Eliminare la richiesta? (Stato=ELIMINATA, resta nello storico)");
          if(!conf){ t.disabled=false; return; }
          await archiveRow(id);
        }
        await refresh();
      }catch(e){
        showError("Errore azione: " + (e?.message ?? String(e)));
      }finally{
        t.disabled = false;
      }
    });

    renderEmoji();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    if(isAdmin()){
      document.getElementById("pinModal").style.display="none";
      init();
    } else {
      document.getElementById("pinModal").style.display="flex";
      document.getElementById("pinErr").style.display="none";
      document.getElementById("pinInput").value="";
      setTimeout(()=>document.getElementById("pinInput").focus(),50);
    }

    document.getElementById("btnPinOk").addEventListener("click", submitPin);
    document.getElementById("pinInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") submitPin(); });
    renderEmoji();
  });
</script>

</body>
</html>
