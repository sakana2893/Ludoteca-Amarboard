<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Registrazione ‚Äì AmarBoard</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root{ --rosso:#b02030; --verde:#1f7a3a; }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin:0; padding:0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .card{
      width: min(560px, 100%);
      background: rgba(255,250,243,0.96);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      padding: 14px;
    }
    h1{
      margin: 6px 8px 10px;
      text-align:center;
      color: var(--rosso);
      text-shadow: 0 1px 0 #fff;
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px;
    }
    .row > div{ flex:1 1 220px; }
    .label{ font-size:.85rem; color:#444; font-weight:800; margin-bottom: 4px; }
    input{
      width:100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      background:#fff;
    }
    .actions{
      display:flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-green{ border-color: rgba(31,122,58,0.35); background:#e9fff0; color: var(--verde); }
    .btn-gray{ border-color: rgba(0,0,0,0.12); background:#f6f6f6; color:#444; }

    #errorBox{
      display:none;
      margin: 10px 8px 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(176,32,48,0.35);
      background: rgba(255, 231, 231, 0.85);
      color: #7a0f1a;
      font-size: .95rem;
      line-height: 1.35;
    }
    .muted{ color:#666; font-size:.9rem; font-weight:700; padding: 0 8px 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üìù Registrazione AmarBoard</h1>
    <div class="muted">Scegli uno username semplice (minuscolo, senza spazi). La password viene salvata come hash (non in chiaro).</div>

    <div id="errorBox"></div>

    <div class="row">
      <div>
        <div class="label">Username</div>
        <input id="u" placeholder="es. mario.rossi">
      </div>
      <div>
        <div class="label">Nome</div>
        <input id="n" placeholder="Nome e cognome">
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Telefono</div>
        <input id="t" placeholder="393...">
      </div>
      <div>
        <div class="label">Password</div>
        <input id="p" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-gray" onclick="location.href='index.html'">‚¨ÖÔ∏è Torna al catalogo</button>
      <button class="btn btn-green" id="go">‚úÖ Crea account</button>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyoQBfaYvxQBTS_EnK1-IOlPjLoFT0sWn1jcHPuDg5t0nUkwrvKPY-x8Qg8ii5BmtLDYg/exec";

function E(id){ return document.getElementById(id); }
function showError(msg){ const b=E("errorBox"); b.style.display="block"; b.textContent=msg; }
function clearError(){ const b=E("errorBox"); b.style.display="none"; b.textContent=""; }

function jsonp(url, params={}, timeoutMs=12000){
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    const qs = new URLSearchParams({ ...params, callback: cbName }).toString();
    const full = url + (url.includes("?") ? "&" : "?") + qs;

    const script = document.createElement("script");
    let done=false;

    window[cbName] = (data) => { done=true; cleanup(); resolve(data); };

    const t = setTimeout(() => {
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    }

    script.onerror = () => { if(done) return; done=true; cleanup(); reject(new Error("JSONP load error")); };
    script.src = full;
    document.body.appendChild(script);
  });
}

async function sha256hex(text){
  if (window.crypto && crypto.subtle && window.isSecureContext){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  return sha256_fallback_(text);
}
function sha256_fallback_(ascii){
  function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }
  var mathPow=Math.pow; var maxWord=mathPow(2,32); var lengthProperty='length';
  var i,j; var result=''; var words=[]; var asciiBitLength=ascii[lengthProperty]*8;
  var hash=sha256_fallback_.h=sha256_fallback_.h||[]; var k=sha256_fallback_.k=sha256_fallback_.k||[];
  var primeCounter=k[lengthProperty]; var isComposite={};
  for (var candidate=2; primeCounter<64; candidate++){
    if(!isComposite[candidate]){
      for(i=0;i<313;i+=candidate) isComposite[i]=candidate;
      hash[primeCounter]=(mathPow(candidate,.5)*maxWord)|0;
      k[primeCounter++]=(mathPow(candidate,1/3)*maxWord)|0;
    }
  }
  ascii+='\x80';
  while(ascii[lengthProperty]%64-56) ascii+='\x00';
  for(i=0;i<ascii[lengthProperty];i++){
    j=ascii.charCodeAt(i);
    words[i>>2]|=j<<((3-i)%4)*8;
  }
  words[words[lengthProperty]]=((asciiBitLength/maxWord)|0);
  words[words[lengthProperty]]=(asciiBitLength);
  for(j=0;j<words[lengthProperty];){
    var w=words.slice(j,j+=16); var oldHash=hash.slice(0);
    for(i=0;i<64;i++){
      var w15=w[i-15], w2=w[i-2];
      var a=hash[0], e=hash[4];
      var temp1=hash[7]+(rightRotate(e,6)^rightRotate(e,11)^rightRotate(e,25))+((e&hash[5])^((~e)&hash[6]))+k[i]+
        (w[i]=(i<16)?w[i]:(w[i-16]+(rightRotate(w15,7)^rightRotate(w15,18)^(w15>>>3))+w[i-7]+(rightRotate(w2,17)^rightRotate(w2,19)^(w2>>>10)))|0);
      var temp2=(rightRotate(a,2)^rightRotate(a,13)^rightRotate(a,22))+((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));
      hash=[(temp1+temp2)|0].concat(hash); hash[4]=(hash[4]+temp1)|0; hash.pop();
    }
    for(i=0;i<8;i++) hash[i]=(hash[i]+oldHash[i])|0;
  }
  for(i=0;i<8;i++) for(j=3;j+1;j--){
    var b=(hash[i]>>(j*8))&255; result+=((b<16)?0:'')+b.toString(16);
  }
  return result;
}

document.addEventListener("DOMContentLoaded", () => {
  E("go").addEventListener("click", async () => {
    clearError();

    const username = E("u").value.trim().toLowerCase();
    const nome = E("n").value.trim();
    const tel = E("t").value.trim();
    const pass = E("p").value;

    if (!username || username.length < 3) { showError("Username troppo corto."); return; }
    if (!/^[a-z0-9._-]{3,40}$/.test(username)) { showError("Username non valido (usa solo a-z 0-9 . _ -)"); return; }
    if (!pass || pass.length < 6) { showError("Password troppo corta (min 6)."); return; }

    try{
      const passhash = await sha256hex(pass);
      const r = await jsonp(API_URL, { action:"register", username, nome, telefono: tel, passhash });
      if (!r.ok) throw new Error(r.error || "register failed");

      alert("‚úÖ Account creato! Ora puoi fare login dal catalogo.");
      location.href = "index.html";

    } catch(e){
      showError("Errore: " + (e?.message || String(e)));
    }
  });
});
</script>
</body>
</html>
