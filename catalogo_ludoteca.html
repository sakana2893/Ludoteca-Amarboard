<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Catalogo Giochi Ludoteca</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <!-- PapaParse per leggere il CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    #wrapper {
      max-width: 1200px;
      margin: 20px auto 40px;
      background: #ffffff;
      padding: 20px 24px 30px;
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
    }

    h1 {
      text-align: center;
      margin: 0 0 8px;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 20px;
      color: #666;
      font-size: 0.9rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .filters-left,
    .filters-right {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filter-label {
      font-size: 0.85rem;
      color: #555;
    }

    select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
    }

    table.dataTable thead th {
      background-color: #ececec;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
      white-space: nowrap;
    }

    .badge-disponibile {
      background-color: #d4edda;
      color: #155724;
    }

    .badge-prestato {
      background-color: #f8d7da;
      color: #721c24;
    }

    .small-meta {
      font-size: 0.8rem;
      color: #666;
      line-height: 1.3;
    }

    a.bgg-link {
      font-size: 0.8rem;
      text-decoration: none;
      color: #0056b3;
    }

    a.bgg-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      #wrapper {
        margin: 10px;
        padding: 12px;
      }
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      .filters-left,
      .filters-right {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<div id="wrapper">
  <h1>Catalogo Giochi</h1>
  <div class="subtitle">
    Catalogo aggiornato dalla ludoteca ‚Ä¢ Ricerca per titolo, categoria, giocatori‚Ä¶
  </div>

  <div class="filters">
    <div class="filters-left">
      <div class="filter-label">Filtro categoria:</div>
      <select id="filtroCategoria">
        <option value="">Tutte</option>
      </select>

      <div class="filter-label">Stato:</div>
      <select id="filtroStato">
        <option value="">Tutti</option>
        <option value="Disponibile">Disponibili</option>
        <option value="In prestito">In prestito</option>
      </select>
    </div>
    <div class="filters-right">
      <span class="filter-label">Usa anche la ricerca in alto a destra per filtrare per titolo, editore‚Ä¶</span>
    </div>
  </div>

  <table id="tblCatalogo" class="display" style="width:100%">
    <thead>
    <tr>
      <th>Titolo</th>
      <th>Giocatori / Durata / Et√†</th>
      <th>Categoria</th>
      <th>Editore</th>
      <th>Disponibili</th>
      <th>Stato</th>
      <th>BGG</th>
    </tr>
    </thead>
    <tbody>
    <!-- riempito da JS -->
    </tbody>
  </table>
</div>

<script>
  // üëâ Sostituisci con il link RAW del CSV su GitHub
// URL base del CSV
const CSV_BASE_URL = "https://raw.githubusercontent.com/sakana2893/Ludoteca-Amarboard/main/catalogo_ludoteca.csv";

document.addEventListener("DOMContentLoaded", function () {
  // aggiunge un parametro finto per evitare la cache (?v=timestamp)
  const csvUrl = CSV_BASE_URL + "?v=" + Date.now();

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function (results) {
      const raw = results.data || [];
      // ... tutto il resto come prima ...
    },
    error: function (err) {
      console.error("Errore nel caricamento del CSV:", err);
      alert("Impossibile caricare il catalogo. Controlla l'URL CSV.");
    }
  });
});

  document.addEventListener("DOMContentLoaded", function () {
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function (results) {
        const raw = results.data || [];
        const data = [];
        const categorieSet = new Set();

        raw.forEach(function (row) {
          if (!row["Titolo"]) return; // salta righe vuote

          const titolo = row["Titolo"] || "";
          const giocatori = row["NumeroGiocatori"] || "";
          const durata = row["Durata"] || "";
          const eta = row["Eta"] || "";
          const categoria = row["Categoria"] || "";
          const editore = row["Editore"] || "";
          const copieDisp = row["CopieDisponibili"] || "";
          const stato = row["StatoDisponibilita"] || "";
          const bgg = row["BGG"] || "";

          if (categoria) categorieSet.add(categoria);

          data.push({
            Titolo: titolo,
            NumeroGiocatori: giocatori,
            Durata: durata,
            Eta: eta,
            Categoria: categoria,
            Editore: editore,
            CopieDisponibili: copieDisp,
            Stato: stato,
            BGG: bgg
          });
        });

        // Popola combo categoria
        const catSelect = document.getElementById("filtroCategoria");
        Array.from(categorieSet).sort().forEach(function (cat) {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          catSelect.appendChild(opt);
        });

        const table = $('#tblCatalogo').DataTable({
          data: data,
          columns: [
            {
              data: "Titolo",
              title: "Titolo",
              render: function (data, type, row) {
                if (type === "display") {
                  let meta = [];
                  if (row.Editore) meta.push(row.Editore);
                  if (row.Categoria) meta.push(row.Categoria);
                  return `<div><strong>${data}</strong></div>
                          <div class="small-meta">${meta.join(" ‚Ä¢ ")}</div>`;
                }
                return data;
              }
            },
            {
              data: null,
              title: "Giocatori / Durata / Et√†",
              render: function (data, type, row) {
                if (type === "display") {
                  const g = row.NumeroGiocatori || "";
                  const d = row.Durata || "";
                  const e = row.Eta || "";
                  let line1 = g ? `üë• ${g}` : "";
                  let line2 = d ? `‚è± ${d}` : "";
                  let line3 = e ? `üéÇ ${e}` : "";
                  return `<div class="small-meta">
                            ${line1}${line1 && (line2 || line3) ? "<br>" : ""}
                            ${line2}${(line2 && line3) ? "<br>" : ""}
                            ${line3}
                          </div>`;
                }
                return (row.NumeroGiocatori || "") + " " + (row.Durata || "") + " " + (row.Eta || "");
              }
            },
            { data: "Categoria", title: "Categoria" },
            { data: "Editore", title: "Editore" },
            {
              data: "CopieDisponibili",
              title: "Disponibili",
              render: function (data, type, row) {
                if (type === "display") {
                  const n = data !== undefined && data !== null ? data : "";
                  return `<strong>${n}</strong>`;
                }
                return data;
              }
            },
            {
              data: "Stato",
              title: "Stato",
              render: function (data) {
                return statoBadge(data);
              }
            },
            {
              data: "BGG",
              title: "BGG",
              orderable: false,
              render: function (data) {
                if (!data) return "";
                return `<a class="bgg-link" href="${data}" target="_blank">Scheda</a>`;
              }
            }
          ],
          pageLength: 25,
          order: [[0, "asc"]],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json"
          }
        });

        // Filtro categoria
        catSelect.addEventListener("change", function () {
          const val = this.value;
          table.column(2).search(val ? '^' + $.fn.dataTable.util.escapeRegex(val) + '$' : '', true, false).draw();
        });

        // Filtro stato
        document.getElementById("filtroStato").addEventListener("change", function () {
          const val = this.value;
          table.column(5).search(val ? val : '', true, false).draw();
        });
      },
      error: function (err) {
        console.error("Errore nel caricamento del CSV:", err);
        alert("Impossibile caricare il catalogo. Controlla l'URL CSV in alto nel file HTML.");
      }
    });
  });
</script>
</body>
</html>
