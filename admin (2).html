<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Admin â€“ Prenotazioni AmarBoard</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root{
      --rosso: #b02030;
      --verde: #1f7a3a;
      --oro: #f3d08a;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin:0; padding:0;
      background: radial-gradient(circle at top, #ffe9e9, #fdf5e6 45%, #e4f5ea 100%);
      min-height:100vh;
    }
    .wrap{
      max-width: 1200px;
      margin: 20px auto;
      padding: 18px;
    }
    .card{
      background: rgba(255,250,243,0.96);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 14px;
      position: relative;
    }
    h1{
      margin: 6px 0 12px;
      text-align:center;
      color: var(--rosso);
      text-shadow: 0 1px 0 #fff;
    }
    .topbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, #fffdf7, #f7fff7);
      border: 1px solid rgba(31,122,58,0.18);
      margin-bottom: 12px;
    }
    .btn{
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space: nowrap;
    }
    .btn-green{ border-color: rgba(31,122,58,0.35); background:#e9fff0; color: var(--verde); }
    .btn-red{ border-color: rgba(176,32,48,0.35); background:#fff0f0; color: var(--rosso); }
    .btn-gray{ border-color: rgba(0,0,0,0.12); background:#f6f6f6; color:#444; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,0.10);
      display:inline-block;
      white-space: nowrap;
    }
    .pill-inv{ background:#fff3cd; color:#856404; border-color:#ffeeba; }
    .pill-app{ background:#cce5ff; color:#004085; border-color:#b8daff; }
    .pill-rif{ background:#f8d7da; color:#721c24; border-color:#f1b0b7; }
    .pill-can{ background:#e2e3e5; color:#383d41; border-color:#d6d8db; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .box{
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .label{ font-size: .8rem; color:#555; font-weight:700; }
    .value{ font-size: 1.1rem; font-weight: 900; color: var(--rosso); }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
    }
    input[type="text"]{
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      min-width: 220px;
      font-size: .95rem;
    }
    select{
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: .95rem;
      min-width: 170px;
      background:#fff;
    }

    table{
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      overflow:hidden;
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      vertical-align: top;
      font-size: .95rem;
    }
    th{
      background: linear-gradient(180deg,#f7f7f7,#e3e3e3);
      border-bottom: 2px solid var(--rosso);
      font-weight: 900;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
    }

    #errorBox{
      display:none;
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(176,32,48,0.35);
      background: rgba(255, 231, 231, 0.85);
      color: #7a0f1a;
      font-size: .95rem;
      line-height: 1.35;
    }

    .pager{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .muted{ color:#666; font-size: .9rem; font-weight:700; }

    /* Login modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 14px;
    }
    .modal{
      width: min(560px, 100%);
      background: rgba(255,250,243,0.98);
      border: 2px solid rgba(176,32,48,0.25);
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      padding: 14px 14px 12px;
    }
    .modal h3{
      margin: 6px 8px 10px;
      color: var(--rosso);
      text-shadow: 0 1px 0 #fff;
    }
    .modal .row2{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px;
    }
    .modal .row2 > div{ flex:1 1 180px; }
    .modal .actions2{
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      padding: 8px;
    }
    input[type="password"]{
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      min-width: 220px;
      font-size: .95rem;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px){
      .grid{ grid-template-columns: 1fr; }
      input[type="text"]{ min-width: 100%; }
      select{ min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ› ï¸ Admin â€“ Prenotazioni</h1>

      <div class="topbar">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span id="whoami" class="muted">ğŸ‘¤ â€¦</span>
          <span id="onlyRegPill" class="pill" style="display:none;">ğŸ”’ Solo utenti registrati</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-gray" id="btnBack">â¬…ï¸ Catalogo</button>
          <button class="btn btn-green" id="btnToggleOnlyReg">ğŸ”’ Toggle registrati</button>
          <button class="btn btn-green" id="btnPreview">ğŸ‘ï¸ Preview</button>
          <button class="btn btn-green" id="btnRefresh">ğŸ”„ Aggiorna</button>
          <button class="btn btn-red" id="btnLogout">ğŸšª Logout</button>
        </div>
      </div>

      <div id="errorBox"></div>

      <div class="grid">
        <div class="box">
          <div class="label">Tot richieste</div>
          <div class="value" id="cntAll">â€“</div>
        </div>
        <div class="box">
          <div class="label">Inviate</div>
          <div class="value" id="cntInv">â€“</div>
        </div>
        <div class="box">
          <div class="label">Approvate</div>
          <div class="value" id="cntApp">â€“</div>
        </div>
        <div class="box">
          <div class="label">Rifiutate/Cancellate</div>
          <div class="value" id="cntOther">â€“</div>
        </div>
      </div>

      <div class="row">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input id="q" type="text" placeholder="Cerca (titolo/nome/telefono)â€¦">
          <select id="fStato">
            <option value="">Tutti</option>
            <option value="Inviata">Inviata</option>
            <option value="Approvata">Approvata</option>
            <option value="Rifiutata">Rifiutata</option>
            <option value="Cancellata">Cancellata</option>
          </select>
          <select id="pageSize">
            <option value="10">10 / pagina</option>
            <option value="25" selected>25 / pagina</option>
            <option value="50">50 / pagina</option>
            <option value="100">100 / pagina</option>
          </select>
        </div>

        <div class="muted" id="pagerInfo">â€“</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Quando</th>
            <th>Titolo</th>
            <th>Richiedente</th>
            <th>Note</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="pager">
        <button class="btn btn-gray" id="prev">â—€</button>
        <span class="muted" id="pageLabel">Pagina 1</span>
        <button class="btn btn-gray" id="next">â–¶</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal-backdrop" id="loginModal">
    <div class="modal">
      <h3>ğŸ”‘ Login Admin</h3>
      <div class="row2">
        <div>
          <div class="label">Username</div>
          <input id="loginUser" type="text" placeholder="es. sacha">
        </div>
        <div>
          <div class="label">Password</div>
          <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
      </div>
      <div class="actions2">
        <button class="btn btn-gray" id="btnLoginCancel">Annulla</button>
        <button class="btn btn-green" id="btnLoginGo">Entra</button>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyoQBfaYvxQBTS_EnK1-IOlPjLoFT0sWn1jcHPuDg5t0nUkwrvKPY-x8Qg8ii5BmtLDYg/exec";

const LS = { TOKEN:"AB_TOKEN", PROFILE:"AB_PROFILE", PREVIEW_UNTIL:"AB_PREVIEW_UNTIL" };
const PREVIEW_MINUTES = 180;

let items = [];
let page = 1;

function E(id){ return document.getElementById(id); }
function showError(msg){ const b=E("errorBox"); b.style.display="block"; b.textContent=msg; }
function clearError(){ const b=E("errorBox"); b.style.display="none"; b.textContent=""; }

function jsonp(url, params={}, timeoutMs=12000){
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    const qs = new URLSearchParams({ ...params, callback: cbName }).toString();
    const full = url + (url.includes("?") ? "&" : "?") + qs;

    const script = document.createElement("script");
    let done = false;

    window[cbName] = (data) => { done=true; cleanup(); resolve(data); };

    const t = setTimeout(() => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    }
    script.onerror = () => { if(done) return; done=true; cleanup(); reject(new Error("JSONP load error")); };
    script.src = full;
    document.body.appendChild(script);
  });
}

async function sha256hex(text){
  if (window.crypto && crypto.subtle && window.isSecureContext){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  return sha256_fallback_(text);
}
function sha256_fallback_(ascii){
  function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }
  var mathPow=Math.pow; var maxWord=mathPow(2,32); var lengthProperty='length';
  var i,j; var result=''; var words=[]; var asciiBitLength=ascii[lengthProperty]*8;
  var hash=sha256_fallback_.h=sha256_fallback_.h||[]; var k=sha256_fallback_.k=sha256_fallback_.k||[];
  var primeCounter=k[lengthProperty]; var isComposite={};
  for (var candidate=2; primeCounter<64; candidate++){
    if(!isComposite[candidate]){
      for(i=0;i<313;i+=candidate) isComposite[i]=candidate;
      hash[primeCounter]=(mathPow(candidate,.5)*maxWord)|0;
      k[primeCounter++]=(mathPow(candidate,1/3)*maxWord)|0;
    }
  }
  ascii+='\x80';
  while(ascii[lengthProperty]%64-56) ascii+='\x00';
  for(i=0;i<ascii[lengthProperty];i++){
    j=ascii.charCodeAt(i);
    words[i>>2]|=j<<((3-i)%4)*8;
  }
  words[words[lengthProperty]]=((asciiBitLength/maxWord)|0);
  words[words[lengthProperty]]=(asciiBitLength);
  for(j=0;j<words[lengthProperty];){
    var w=words.slice(j,j+=16); var oldHash=hash.slice(0);
    for(i=0;i<64;i++){
      var w15=w[i-15], w2=w[i-2];
      var a=hash[0], e=hash[4];
      var temp1=hash[7]+(rightRotate(e,6)^rightRotate(e,11)^rightRotate(e,25))+((e&hash[5])^((~e)&hash[6]))+k[i]+
        (w[i]=(i<16)?w[i]:(w[i-16]+(rightRotate(w15,7)^rightRotate(w15,18)^(w15>>>3))+w[i-7]+(rightRotate(w2,17)^rightRotate(w2,19)^(w2>>>10)))|0);
      var temp2=(rightRotate(a,2)^rightRotate(a,13)^rightRotate(a,22))+((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));
      hash=[(temp1+temp2)|0].concat(hash); hash[4]=(hash[4]+temp1)|0; hash.pop();
    }
    for(i=0;i<8;i++) hash[i]=(hash[i]+oldHash[i])|0;
  }
  for(i=0;i<8;i++) for(j=3;j+1;j--){
    var b=(hash[i]>>(j*8))&255; result+=((b<16)?0:'')+b.toString(16);
  }
  return result;
}

function getToken(){ return localStorage.getItem(LS.TOKEN) || ""; }
function setSession(token, profile){
  localStorage.setItem(LS.TOKEN, token);
  localStorage.setItem(LS.PROFILE, JSON.stringify(profile || {}));
}
function clearSession(){
  localStorage.removeItem(LS.TOKEN);
  localStorage.removeItem(LS.PROFILE);
}
function getProfile(){ try{ return JSON.parse(localStorage.getItem(LS.PROFILE)||"{}"); }catch{ return {}; } }

function openModal(id){ E(id).style.display="flex"; }
function closeModal(id){ E(id).style.display="none"; }

function enablePreviewBypass(){
  const until = Date.now() + PREVIEW_MINUTES*60*1000;
  localStorage.setItem(LS.PREVIEW_UNTIL, String(until));
}

function pillForStatus(s){
  const st = String(s||"");
  if (st==="Inviata") return `<span class="pill pill-inv">â³ Inviata</span>`;
  if (st==="Approvata") return `<span class="pill pill-app">âœ… Approvata</span>`;
  if (st==="Rifiutata") return `<span class="pill pill-rif">âŒ Rifiutata</span>`;
  if (st==="Cancellata") return `<span class="pill pill-can">ğŸ—‘ï¸ Cancellata</span>`;
  return `<span class="pill">${st}</span>`;
}

function fmtIso(iso){
  const d = new Date(String(iso||""));
  if (!isFinite(d.getTime())) return String(iso||"");
  return d.toLocaleString("it-IT", { year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

function matchesFilter(it, q, stato){
  if (stato && String(it.Stato||"") !== stato) return false;
  if (!q) return true;
  const hay = [
    it.Titolo, it.Nome, it.Telefono, it.Note, it.Giocatori, it.Stato
  ].map(v=>String(v||"").toLowerCase()).join(" | ");
  return hay.includes(q.toLowerCase());
}

function pageSize(){ return Number(E("pageSize").value || "25"); }

function render(){
  const q = E("q").value.trim();
  const stato = E("fStato").value;

  const filtered = items.filter(it => matchesFilter(it, q, stato));
  const ps = pageSize();
  const pages = Math.max(1, Math.ceil(filtered.length / ps));
  if (page > pages) page = pages;
  if (page < 1) page = 1;

  const start = (page-1)*ps;
  const slice = filtered.slice(start, start+ps);

  E("pagerInfo").textContent = `Mostro ${slice.length} su ${filtered.length} (pagina ${page}/${pages})`;
  E("pageLabel").textContent = `Pagina ${page} / ${pages}`;

  const tb = E("tbody");
  tb.innerHTML = "";

  slice.forEach(it => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><div style="font-weight:900;">${fmtIso(it.DataISO)}</div><div class="muted" style="font-size:.85rem;">ID: ${escapeHtml(it.ID)}</div></td>
      <td><div style="font-weight:900;">${escapeHtml(it.Titolo)}</div><div class="muted" style="font-size:.85rem;">Giocatori: ${escapeHtml(it.Giocatori||"")}</div></td>
      <td><div style="font-weight:900;">${escapeHtml(it.Nome)}</div><div class="muted" style="font-size:.85rem;">${escapeHtml(it.Telefono||"")}</div></td>
      <td>${escapeHtml(it.Note||"")}</td>
      <td>${pillForStatus(it.Stato)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-green" data-act="approve" data-id="${escapeHtml(it.ID)}">âœ… Approva</button>
          <button class="btn btn-red" data-act="reject" data-id="${escapeHtml(it.ID)}">âŒ Rifiuta</button>
          <button class="btn btn-gray" data-act="cancel" data-id="${escapeHtml(it.ID)}">ğŸ—‘ï¸ Cancella</button>
        </div>
      </td>
    `;

    tb.appendChild(tr);
  });

  E("prev").disabled = (page <= 1);
  E("next").disabled = (page >= pages);
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}

async function refresh(){
  clearError();
  try{
    const tok = getToken();
    if (!tok){
      openModal("loginModal");
      return;
    }

    const me = await jsonp(API_URL, { action:"me", token: tok });
    if (!me.ok){
      clearSession();
      openModal("loginModal");
      return;
    }
    if (String(me.profile.Ruolo||"") !== "admin"){
      showError("Non sei admin.");
      return;
    }

    localStorage.setItem(LS.PROFILE, JSON.stringify(me.profile||{}));
    E("whoami").textContent = `ğŸ‘¤ ${me.profile.Username} (admin)`;

    const r = await jsonp(API_URL, { action:"admin_list", token: tok });
    if (!r.ok) throw new Error(r.error || "admin_list failed");

    items = (r.items || []);
    const inv = items.filter(x => x.Stato === "Inviata").length;
    const app = items.filter(x => x.Stato === "Approvata").length;
    const oth = items.length - inv - app;

    E("cntAll").textContent = items.length;
    E("cntInv").textContent = inv;
    E("cntApp").textContent = app;
    E("cntOther").textContent = oth;

    const onlyReg = !!r.onlyRegistered;
    E("onlyRegPill").style.display = onlyReg ? "inline-block" : "none";
    E("onlyRegPill").className = "pill " + (onlyReg ? "pill-app" : "");
    E("onlyRegPill").textContent = onlyReg ? "ğŸ”’ Solo utenti registrati" : "";

    page = 1;
    render();

  } catch(e){
    showError("Errore: " + (e?.message || String(e)));
  }
}

async function setStatus(id, stato){
  clearError();
  try{
    const tok = getToken();
    const r = await jsonp(API_URL, { action:"admin_set_status", token: tok, id, stato });
    if (!r.ok) throw new Error(r.error || "set_status failed");
    await refresh();
  } catch(e){
    showError("Errore: " + (e?.message || String(e)));
  }
}

async function deleteReq(id){
  clearError();
  try{
    const tok = getToken();
    const r = await jsonp(API_URL, { action:"admin_delete", token: tok, id });
    if (!r.ok) throw new Error(r.error || "delete failed");
    await refresh();
  } catch(e){
    showError("Errore: " + (e?.message || String(e)));
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // Back to catalogo
  E("btnBack").addEventListener("click", () => location.href = "index.html");

  // Preview
  E("btnPreview").addEventListener("click", () => {
    enablePreviewBypass();
    alert("ğŸ‘ï¸ Preview abilitata sul catalogo (bypass countdown temporaneo).");
  });

  // Toggle only registered
  E("btnToggleOnlyReg").addEventListener("click", async () => {
    clearError();
    try{
      const tok = getToken();
      const r = await jsonp(API_URL, { action:"admin_list", token: tok });
      if (!r.ok) throw new Error(r.error || "admin_list failed");

      const newVal = !(!!r.onlyRegistered);
      const set = await jsonp(API_URL, { action:"admin_set_only_registered", token: tok, value: newVal ? "true" : "false" });
      if (!set.ok) throw new Error(set.error || "toggle failed");

      alert("Impostazione aggiornata: " + (set.onlyRegistered ? "SOLO registrati" : "anche ospiti"));
      await refresh();
    } catch(e){
      showError("Errore: " + (e?.message || String(e)));
    }
  });

  // Refresh
  E("btnRefresh").addEventListener("click", () => refresh());

  // Search filters
  E("q").addEventListener("input", () => { page = 1; render(); });
  E("fStato").addEventListener("change", () => { page = 1; render(); });
  E("pageSize").addEventListener("change", () => { page = 1; render(); });

  // Pager
  E("prev").addEventListener("click", () => { page--; render(); });
  E("next").addEventListener("click", () => { page++; render(); });

  // Table actions (event delegation)
  E("tbody").addEventListener("click", (ev) => {
    const btn = ev.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");

    if (act === "approve") setStatus(id, "Approvata");
    else if (act === "reject") setStatus(id, "Rifiutata");
    else if (act === "cancel") deleteReq(id);
  });

  // Logout
  E("btnLogout").addEventListener("click", async () => {
    const tok = getToken();
    localStorage.removeItem(LS.TOKEN);
    localStorage.removeItem(LS.PROFILE);
    try{ if (tok) await jsonp(API_URL, { action:"logout", token: tok }); } catch {}
    alert("Logout effettuato");
    openModal("loginModal");
  });

  // Login modal
  E("btnLoginCancel").addEventListener("click", () => closeModal("loginModal"));
  E("loginModal").addEventListener("click", (ev) => { if (ev.target === E("loginModal")) closeModal("loginModal"); });

  E("btnLoginGo").addEventListener("click", async () => {
    clearError();
    const u = E("loginUser").value.trim().toLowerCase();
    const p = E("loginPass").value;
    if (!u || !p){ showError("Inserisci username e password."); return; }

    try{
      const passhash = await sha256hex(p);
      const r = await jsonp(API_URL, { action:"login", username:u, passhash });
      if (!r.ok) throw new Error(r.error || "Login fallito");

      setSession(r.token, r.profile);
      closeModal("loginModal");
      await refresh();
    } catch(e){
      showError("Login: " + (e?.message || String(e)));
    }
  });

  // Auto start
  refresh();
});
</script>
</body>
</html>
